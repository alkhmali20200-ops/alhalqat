<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>نظام إدارة حلقات القرآن الكريم</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
    body {
      font-family: 'Amiri', serif;
    }
    .print-page {
      page-break-after: always;
    }
    @media print {
      body,
      .container {
        margin: 0;
        padding: 0;
        box-shadow: none;
        border: none;
        font-size: 10px;
      }
      .no-print {
        display: none !important;
      }
      .view {
        display: none !important;
      }
      #analyticsView {
        display: block !important;
      }
    }
    input,
    select,
    textarea {
      border: 1px solid #d1d5db;
      border-radius: 4px;
      padding: 4px 8px;
      font-family: 'Amiri', serif;
      background-color: transparent;
    }
    .student-tab {
      transition: all 0.3s ease;
      cursor: pointer;
    }
    .student-tab.active {
      background-color: #3b82f6;
      color: white;
    }
    .student-tab:hover {
      background-color: #e5e7eb;
    }
    .student-tab.active:hover {
      background-color: #2563eb;
    }
    .student-content,
    .view {
      display: none;
    }
    .view.active {
      display: block;
    }
    .student-content.active {
      display: block;
    }
    .delete-btn {
      transition: all 0.2s ease;
    }
    .delete-btn:hover {
      transform: scale(1.1);
      background-color: #fee2e2;
    }
  </style>
</head>
<body class="bg-gray-50 p-4">
  <!-- Firebase config -->
  <script>
    window.__firebase_config = JSON.stringify({
      apiKey: "AIzaSyAsQQ9GGfZ0DmS4V5Fqv49rypXDEeoxCaA",
      authDomain: "alhalqat-6ac9d.firebaseapp.com",
      projectId: "alhalqat-6ac9d",
      storageBucket: "alhalqat-6ac9d.appspot.com",
      messagingSenderId: "ضع هنا الرقم الصحيح من Firebase Console",
      appId: "ضع هنا معرف التطبيق الصحيح من Firebase Console"
    });
    window.__app_id = "alhalqat-6ac9d";
  </script>

  <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-6">
    <!-- المحتوى ... (تماماً كما في ملفك السابق للعرض، التفاعل، إدارة الحلقات) -->
    <div id="selectionView" class="view active text-center py-16">
      <h1 class="text-3xl font-bold mb-8 text-gray-700">نظام إدارة حلقات القرآن الكريم</h1>
      <p class="text-lg text-gray-500 mb-12">الرجاء تحديد القسم للبدء</p>
      <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-8">
        <button id="selectMenBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">قسم الرجال</button>
        <button id="selectWomenBtn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">قسم النساء</button>
      </div>
      <p id="firebase-status" class="mt-8 text-gray-400 text-sm">جاري تهيئة التطبيق...</p>
    </div>

    <!-- بقية الواجهات dashboardView , halaqaView , analyticsView ... (تنقل وتفاعل كما في كودك مع تحسينات الحفظ) -->

  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    class AppManager {
      constructor() {
        this.appData = { men: [], women: [] };
        this.currentSection = null;
        this.currentHalaqaId = null;
        this.halaqaManager = new HalaqaManager(this);
        this.db = null;
        this.unsubscribe = null;
        this.initialLinkHandled = false;
        this.appId = null;
        this.initFirebase();
      }

      async initFirebase() {
        if (typeof __firebase_config === "undefined") {
          document.getElementById("firebase-status").textContent =
            "وضع المعاينة (الاتصال بقاعدة البيانات معطل)";
          console.log("Running in preview mode. Firebase disabled.");
          this.handleDirectLinkAfterDataLoad();
          return;
        }

        try {
          const firebaseConfig = JSON.parse(__firebase_config);
          this.appId = typeof __app_id !== "undefined" ? __app_id : firebaseConfig.projectId;

          const app = initializeApp(firebaseConfig);
          this.db = getFirestore(app);
          const auth = getAuth(app);

          if (typeof __initial_auth_token !== "undefined" && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }

          document.getElementById("firebase-status").textContent = "متصل بقاعدة البيانات ✅";
          this.listenForDataChanges(this.appId);
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          document.getElementById("firebase-status").textContent = `فشل الاتصال: ${error.message}`;
          this.handleDirectLinkAfterDataLoad();
        }
      }

      listenForDataChanges(appId) {
        if (!this.db) {
          if (!this.initialLinkHandled) this.handleDirectLinkAfterDataLoad();
          return;
        }
        const docRef = doc(this.db, "artifacts", appId, "public", "data");
        this.unsubscribe = onSnapshot(
          docRef,
          (docSnap) => {
            if (docSnap.exists()) {
              const data = docSnap.data();
              this.appData = { men: data.men || [], women: data.women || [] };
            } else {
              this.appData = { men: [], women: [] };
              this.saveData();
            }

            if (!this.initialLinkHandled) {
              this.handleDirectLinkAfterDataLoad();
            }

            if (this.currentSection && document.getElementById("dashboardView").classList.contains("active")) {
              this.renderDashboard();
            }
          },
          (error) => {
            console.error("Error listening to data:", error);
            this.halaqaManager.showMessage("حدث خطأ في المزامنة مع قاعدة البيانات", "error");
          }
        );
      }

      handleDirectLinkAfterDataLoad() {
        this.initialLinkHandled = true;
        const hash = window.location.hash;
        if (hash && hash.startsWith("#halaqa_id=")) {
          const halaqaId = hash.substring("#halaqa_id=".length);
          const section = halaqaId.startsWith("men")
            ? "men"
            : halaqaId.startsWith("women")
            ? "women"
            : null;
          if (section) {
            this.currentSection = section;
            this.openHalaqa(halaqaId);
          } else {
            this.showView("selectionView");
          }
        } else {
          this.showView("selectionView");
        }
      }

      async saveData() {
        if (!this.db || !this.appId) return;
        const docRef = doc(this.db, "artifacts", this.appId, "public", "data");
        try {
          await setDoc(docRef, this.appData);
        } catch (error) {
          console.error("CRITICAL SAVE ERROR:", error);
          this.halaqaManager.showMessage(
            "فشل الحفظ: صلاحيات الوصول مرفوضة. الرجاء التأكد من تطبيق قواعد الأمان في Firebase بشكل صحيح.",
            "error"
          );
          throw error;
        }
      }

      showView(viewId) {
        document.querySelectorAll(".view").forEach((v) => v.classList.remove("active"));
        const viewToShow = document.getElementById(viewId);
        if (viewToShow) {
          viewToShow.classList.add("active");
          if (viewId === "dashboardView") this.renderDashboard();
        } else {
          document.getElementById("selectionView").classList.add("active");
        }
      }

      selectSection(section) {
        this.currentSection = section;
        document.getElementById(
          "dashboardTitle"
        ).textContent = `لوحة تحكم ${section === "men" ? "قسم الرجال" : "قسم النساء"}`;
        this.showView("dashboardView");
      }

      renderDashboard() {
        const listContainer = document.getElementById("listContainer");
        const formContainer = document.getElementById("formContainer");
        const listTitle = document.getElementById("listTitle");
        listContainer.innerHTML = "";

        if (this.currentSection === "men") {
          listTitle.textContent = "الحلقات المسجلة";
          formContainer.innerHTML = `
                        <h2 class="text-xl font-bold mb-4">إضافة حلقة جديدة</h2>
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="flex-grow"><label for="newHalaqaName" class="block text-sm font-medium text-gray-700">اسم الحلقة</label><input type="text" id="newHalaqaName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: حلقة المبتدئين"></div>
                            <div class="flex-grow"><label for="newTeacherName" class="block text-sm font-medium text-gray-700">اسم المعلم/ة</label><input type="text" id="newTeacherName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="اسم المعلم/ة المسؤول/ة"></div>
                            <button id="addNewHalaqaBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة</button>
                        </div>`;
          listContainer.className = "grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6";

          const halaqas = this.appData.men || [];
          if (halaqas.length === 0) {
            listContainer.innerHTML = `<p class="text-gray-500 col-span-full">لا توجد حلقات مسجلة في هذا القسم بعد.</p>`;
          } else {
            halaqas.forEach((halaqa) => {
              const card = document.createElement("div");
              card.className = "bg-white p-6 rounded-lg shadow-md border border-gray-200";
              card.innerHTML = `
                                  <h3 class="text-lg font-bold text-blue-800">${halaqa.circleName}</h3>
                                  <p class="text-gray-600 mb-4">${halaqa.teacherName}</p>
                                  <div class="flex gap-2 mt-4 flex-wrap">
                                    <button data-halaqa-id="${halaqa.id}" class="open-halaqa-btn flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">فتح</button>
                                    <button data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">تعديل</button>
                                    <button data-halaqa-id="${halaqa.id}" class="share-halaqa-btn flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">مشاركة</button>
                                    <button data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">حذف</button>
                                  </div>`;
              listContainer.appendChild(card);
            });
          }
        } else if (this.currentSection === "women") {
          listTitle.textContent = "الدور المسجلة";
          formContainer.innerHTML = `
                        <h2 class="text-xl font-bold mb-4">إضافة دار جديدة</h2>
                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="flex-grow"><label for="newDarName" class="block text-sm font-medium text-gray-700">اسم الدار</label><input type="text" id="newDarName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: دار الهدى النسائية"></div>
                            <button id="addNewDarBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة دار</button>
                        </div>`;
          listContainer.className = "space-y-6";

          const dars = this.appData.women || [];
          if (dars.length === 0) {
            listContainer.innerHTML = `<p class="text-gray-500">لا توجد دور مسجلة في هذا القسم بعد.</p>`;
          } else {
            dars.forEach((dar) => {
              const darContainer = document.createElement("div");
              darContainer.className = "bg-white p-6 rounded-lg shadow-lg border border-pink-200";

              let halaqaCardsHTML = (dar.halaqas || [])
                .map(
                  (halaqa) => `
                                <div class="bg-gray-50 p-4 rounded-md border flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                                  <div>
                                      <h4 class="font-bold text-gray-800">${halaqa.circleName}</h4>
                                      <p class="text-sm text-gray-500">${halaqa.teacherName}</p>
                                  </div>
                                  <div class="flex gap-2 flex-shrink-0 flex-wrap">
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="open-halaqa-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm">فتح</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md text-sm">تعديل</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="share-halaqa-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-md text-sm">مشاركة</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm">حذف</button>
                                  </div>
                                </div>
                            `
                )
                .join("");

              darContainer.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                              <h3 class="text-2xl font-bold text-pink-700">${dar.name}</h3>
                              <button data-dar-id="${dar.id}" class="delete-dar-btn bg-red-100 text-red-700 hover:bg-red-200 font-bold py-1 px-3 rounded-md">حذف الدار</button>
                            </div>
                            <div class="space-y-3 mb-6">${halaqaCardsHTML || '<p class="text-gray-500">لا توجد حلقات في هذه الدار بعد.</p>'}</div>
                            <div class="bg-pink-50 p-4 rounded-lg border border-pink-200 mt-4">
                              <h4 class="font-bold mb-3">إضافة حلقة جديدة لهذه الدار</h4>
                              <div class="flex flex-wrap gap-4 items-end">
                                <div class="flex-grow"><label for="newHalaqaName_${dar.id}" class="block text-sm font-medium text-gray-700">اسم الحلقة</label><input type="text" id="newHalaqaName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: حلقة المتقدمات"></div>
                                <div class="flex-grow"><label for="newTeacherName_${dar.id}" class="block text-sm font-medium text-gray-700">اسم المعلمة</label><input type="text" id="newTeacherName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="اسم المعلمة المسؤولة"></div>
                                <button data-dar-id="${dar.id}" class="add-halaqa-to-dar-btn bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة حلقة</button>
                              </div>
                            </div>
                          `;

              listContainer.appendChild(darContainer);
            });
          }
        }

        shareHalaqa(halaqaId) {
          try {
            const baseUrl = window.location.href.split("#")[0];
            const shareableLink = `${baseUrl}#halaqa_id=${halaqaId}`;
            document.getElementById("shareLinkInput").value = shareableLink;
            document.getElementById("shareModal").classList.remove("hidden");
          } catch (e) {
            console.error("Error creating share link:", e);
            this.halaqaManager.showMessage("فشل إنشاء رابط المشاركة.", "error");
          }
        }

        async addNewHalaqaToMen() {
          const circleName = document.getElementById("newHalaqaName").value.trim();
          const teacherName = document.getElementById("newTeacherName").value.trim();
          if (!circleName || !teacherName) {
            this.halaqaManager.showMessage("يرجى إدخال اسم الحلقة واسم المعلم", "warning");
            return;
          }
          const newHalaqa = {
            id: `men_${Date.now()}`,
            circleName,
            teacherName,
            month: "",
            students: [],
            studentIdCounter: 1,
          };

          const originalData = JSON.parse(JSON.stringify(this.appData));
          this.appData.men.push(newHalaqa);
          this.renderDashboard();

          try {
            await this.saveData();
            this.halaqaManager.showMessage("تمت الإضافة بنجاح!", "success");
            document.getElementById("newHalaqaName").value = "";
            document.getElementById("newTeacherName").value = "";
          } catch {
            this.appData = originalData;
            this.renderDashboard();
          }
        }

        async deleteHalaqaFromMen(halaqaId) {
          const halaqaIndex = this.appData.men.findIndex((h) => h.id === halaqaId);
          if (halaqaIndex > -1) {
            const originalData = JSON.parse(JSON.stringify(this.appData));
            this.appData.men.splice(halaqaIndex, 1);
            this.renderDashboard();

            try {
              await this.saveData();
              this.halaqaManager.showMessage("تم حذف الحلقة بنجاح", "warning");
            } catch {
              this.appData = originalData;
              this.renderDashboard();
            }
          }
        }

        async addNewDar() {
          const darNameInput = document.getElementById("newDarName");
          const darName = darNameInput.value.trim();
          if (!darName) {
            this.halaqaManager.showMessage("يرجى إدخال اسم الدار", "warning");
            return;
          }
          const newDar = { id: `dar_${Date.now()}`, name: darName, halaqas: [] };

          const originalData = JSON.parse(JSON.stringify(this.appData));
          this.appData.women.push(newDar);
          this.renderDashboard();

          try {
            await this.saveData();
            darNameInput.value = "";
            this.halaqaManager.showMessage("تمت إضافة الدار بنجاح", "success");
          } catch {
            this.appData = originalData;
            this.renderDashboard();
          }
        }

        async deleteDar(darId) {
          const darIndex = this.appData.women.findIndex((d) => d.id === darId);
          if (darIndex > -1) {
            const originalData = JSON.parse(JSON.stringify(this.appData));
            this.appData.women.splice(darIndex, 1);
            this.renderDashboard();

            try {
              await this.saveData();
              this.halaqaManager.showMessage("تم حذف الدار بنجاح", "warning");
            } catch {
              this.appData = originalData;
              this.renderDashboard();
            }
          }
        }

        async addNewHalaqaToDar(darId) {
          const halaqaNameInput = document.getElementById(`newHalaqaName_${darId}`);
          const teacherNameInput = document.getElementById(`newTeacherName_${darId}`);
          const circleName = halaqaNameInput.value.trim();
          const teacherName = teacherNameInput.value.trim();
          if (!circleName || !teacherName) {
            this.halaqaManager.showMessage("يرجى إدخال اسم الحلقة واسم المعلمة", "warning");
            return;
          }

          const originalData = JSON.parse(JSON.stringify(this.appData));
          const dar = this.appData.women.find((d) => d.id === darId);
          if (dar) {
            const newHalaqa = {
              id: `women_${Date.now()}`,
              circleName,
              teacherName,
              month: "",
              students: [],
              studentIdCounter: 1,
            };
            if (!dar.halaqas) dar.halaqas = [];
            dar.halaqas.push(newHalaqa);
            this.renderDashboard();

            try {
              await this.saveData();
              halaqaNameInput.value = "";
              teacherNameInput.value = "";
              this.halaqaManager.showMessage("تمت إضافة الحلقة بنجاح", "success");
            } catch {
              this.appData = originalData;
              this.renderDashboard();
            }
          }
        }

        async deleteHalaqaFromDar(darId, halaqaId) {
          const originalData = JSON.parse(JSON.stringify(this.appData));
          const dar = this.appData.women.find((d) => d.id === darId);
          if (dar && dar.halaqas) {
            const halaqaIndex = dar.halaqas.findIndex((h) => h.id === halaqaId);
            if (halaqaIndex > -1) {
              dar.halaqas.splice(halaqaIndex, 1);
              this.renderDashboard();

              try {
                await this.saveData();
                this.halaqaManager.showMessage("تم حذف الحلقة بنجاح", "warning");
              } catch {
                this.appData = originalData;
                this.renderDashboard();
              }
            }
          }
        }

        editHalaqa(darId, halaqaId) {
          let halaqa;
          if (this.currentSection === "men") {
            halaqa = this.appData.men.find((h) => h.id === halaqaId);
          } else {
            const dar = this.appData.women.find((d) => d.id === darId);
            if (dar) halaqa = (dar.halaqas || []).find((h) => h.id === halaqaId);
          }

          if (halaqa) {
            const modal = document.getElementById("editModal");
            const halaqaNameInput = document.getElementById("editHalaqaName");
            const teacherNameInput = document.getElementById("editTeacherName");
            const saveBtn = document.getElementById("saveEditBtn");

            halaqaNameInput.value = halaqa.circleName;
            teacherNameInput.value = halaqa.teacherName;

            const newSaveBtn = saveBtn.cloneNode(true);
            saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

            newSaveBtn.onclick = async () => {
              const newCircleName = halaqaNameInput.value.trim();
              const newTeacherName = teacherNameInput.value.trim();
              if (!newCircleName || !newTeacherName) {
                this.halaqaManager.showMessage("الرجاء عدم ترك الحقول فارغة", "warning");
                return;
              }

              const originalData = JSON.parse(JSON.stringify(this.appData));
              halaqa.circleName = newCircleName;
              halaqa.teacherName = newTeacherName;
              this.renderDashboard();

              try {
                await this.saveData();
                this.halaqaManager.showMessage("تم تعديل بيانات الحلقة بنجاح", "success");
                modal.classList.add("hidden");
              } catch {
                this.appData = originalData;
                this.renderDashboard();
              }
            };
            modal.classList.remove("hidden");
          }
        }

        openHalaqa(halaqaId) {
          this.currentHalaqaId = halaqaId;
          let halaqa;
          if (this.currentSection === "men") {
            halaqa = (this.appData.men || []).find((h) => h.id === halaqaId);
          } else if (this.currentSection === "women") {
            for (const dar of this.appData.women || []) {
              halaqa = (dar.halaqas || []).find((h) => h.id === halaqaId);
              if (halaqa) break;
            }
          }
          if (halaqa) {
            this.halaqaManager.loadHalaqa(halaqa);
            this.showView("halaqaView");
          }
        }

        async updateCurrentHalaqa(halaqaData) {
          if (this.currentSection === "men") {
            const halaqaIndex = this.appData.men.findIndex((h) => h.id === this.currentHalaqaId);
            if (halaqaIndex > -1) this.appData.men[halaqaIndex] = halaqaData;
          } else if (this.currentSection === "women") {
            for (const dar of this.appData.women) {
              const halaqaIndex = (dar.halaqas || []).findIndex((h) => h.id === this.currentHalaqaId);
              if (halaqaIndex > -1) {
                dar.halaqas[halaqaIndex] = halaqaData;
                break;
              }
            }
          }
          await this.saveData();
        }
      }

      class HalaqaManager {
        constructor(appManager) {
          this.app = appManager;
          this.currentHalaqa = null;
          this.currentStudentId = null;
          this.debounceTimer = null;
          this.messageTimeout = null;
          this.initializeEventListeners();
        }

        initializeEventListeners() {
          document.getElementById("addStudentBtn").addEventListener("click", () => this.addStudent());
          document
            .getElementById("addWeekBtn")
            .addEventListener("click", () => this.addWeekToCurrentStudent());
          document
            .getElementById("calculateBtn")
            .addEventListener("click", () => this.calculateAllTotals());
          document.getElementById("printBtn").addEventListener("click", () => this.generatePrintableReport());
          document.getElementById("exportBtn").addEventListener("click", () => this.exportHalaqaToCSV());
          document
            .getElementById("printSummaryBtn")
            .addEventListener("click", () => this.printHalaqaSummary());
          document.getElementById("newStudentName").addEventListener("keypress", (e) => {
            if (e.key === "Enter") this.addStudent();
          });
          document.getElementById("halaqaView").addEventListener("input", () => {
            this.showMessage("جاري الحفظ...", "info");
            clearTimeout(this.debounceTimer);
            this.debounceTimer = setTimeout(() => {
              this.captureAndSaveHalaqa()
                .then(() => {
                  this.showMessage("تم الحفظ بنجاح!", "success");
                })
                .catch(() => {
                  // يظهر رسالة خطأ في saveData نفسها
                });
            }, 1500);
          });
        }

        calculateHalaqaTotals(halaqa) {
          let totals = { totalMemorization: 0, totalReview: 0, totalAttendance: 0, totalAbsence: 0 };
          if (!halaqa.students) return totals;
          halaqa.students.forEach((student) => {
            (student.data.weeks || []).forEach((week) => {
              (week.days || []).forEach((day) => {
                totals.totalMemorization += Number(day.hifdhFaces) || 0;
                totals.totalReview += Number(day.murajaaFaces) || 0;
                if (day.attendance === "حضر") totals.totalAttendance++;
                else if (day.attendance === "غاب") totals.totalAbsence++;
              });
            });
          });
          return totals;
        }

        getHijriDateParts() {
          const today = new Date();
          const yearFormatter = new Intl.DateTimeFormat("ar-SA-u-ca-islamic", {
            year: "numeric",
          });
          const monthFormatter = new Intl.DateTimeFormat("ar-SA-u-ca-islamic", { month: "long" });

          const year = yearFormatter.format(today).replace(/\s*هـ.*/, "");
          const monthName = monthFormatter.format(today);

          return { year, monthName };
        }

        loadHalaqa(halaqaData) {
          this.currentHalaqa = JSON.parse(JSON.stringify(halaqaData));
          document.getElementById("studentsTabs").innerHTML = "";
          document.getElementById("studentsContentContainer").innerHTML = "";
          document.getElementById("halaqaSummary").classList.add("hidden");

          const { year, monthName } = this.getHijriDateParts();
          document.getElementById("currentHijriYear").textContent = `لعام ${year}هـ`;
          document.getElementById("teacherName").value = this.currentHalaqa.teacherName;
          document.getElementById("circleName").value = this.currentHalaqa.circleName;

          const monthSelect = document.getElementById("month");
          if (this.currentHalaqa.month) {
            monthSelect.value = this.currentHalaqa.month;
          } else {
            const currentMonthOption = Array.from(monthSelect.options).find((opt) => opt.text === monthName);
            if (currentMonthOption) {
              monthSelect.value = currentMonthOption.value;
              this.currentHalaqa.month = currentMonthOption.value;
            } else {
              monthSelect.value = "";
            }
          }

          (this.currentHalaqa.students || []).forEach((student) => {
            this.createStudentTab(student);
            this.createStudentContentWithData(student);
          });

          if (this.currentHalaqa.students && this.currentHalaqa.students.length > 0) {
            this.switchToStudent(this.currentHalaqa.students[0].id);
          } else {
            this.currentStudentId = null;
          }
        }

        async captureAndSaveHalaqa() {
          if (!this.currentHalaqa) return;
          this.currentHalaqa.teacherName = document.getElementById("teacherName").value;
          this.currentHalaqa.circleName = document.getElementById("circleName").value;
          this.currentHalaqa.month = document.getElementById("month").value;
          (this.currentHalaqa.students || []).forEach((student) => this.captureStudentData(student.id));
          await this.app.updateCurrentHalaqa(this.currentHalaqa);
        }

        addStudent() {
          const nameInput = document.getElementById("newStudentName");
          const studentName = nameInput.value.trim();
          if (!studentName) return this.showMessage("يرجى إدخال اسم الطالب", "warning");
          if (!this.currentHalaqa.studentIdCounter) this.currentHalaqa.studentIdCounter = (this.currentHalaqa.students || []).length + 1;
          const studentId = `student_${this.currentHalaqa.studentIdCounter++}`;
          const newStudent = {
            id: studentId,
            name: studentName,
            grade: document.getElementById("newStudentGrade").value.trim(),
            civilId: document.getElementById("newStudentCivilId").value.trim(),
            data: { weeks: [{ days: Array(4).fill({}).map(() => ({ date: this.getHijriDateString(new Date()) })) }] },
          };
          if (!this.currentHalaqa.students) this.currentHalaqa.students = [];
          this.currentHalaqa.students.push(newStudent);
          this.createStudentTab(newStudent);
          this.createStudentContentWithData(newStudent);
          this.switchToStudent(studentId);
          nameInput.value = "";
          document.getElementById("newStudentGrade").value = "";
          document.getElementById("newStudentCivilId").value = "";
          this.captureAndSaveHalaqa();
          this.showMessage("تم إضافة الطالب بنجاح!", "success");
        }

        removeStudent(studentId) {
          const studentIndex = this.currentHalaqa.students.findIndex((s) => s.id === studentId);
          if (studentIndex > -1) {
            const studentName = this.currentHalaqa.students[studentIndex].name;
            this.currentHalaqa.students.splice(studentIndex, 1);
            document.getElementById(`tab_${studentId}`).remove();
            document.getElementById(`content_${studentId}`).remove();
            if (this.currentStudentId === studentId) {
              this.currentStudentId = this.currentHalaqa.students.length > 0 ? this.currentHalaqa.students[0].id : null;
              if (this.currentStudentId) this.switchToStudent(this.currentStudentId);
            }
            this.captureAndSaveHalaqa();
            this.showMessage(`تم حذف الطالب: ${studentName}`, "warning");
          }
        }

        switchToStudent(studentId) {
          if (!this.currentHalaqa || !this.currentHalaqa.students.find((s) => s.id === studentId)) return;
          this.currentStudentId = studentId;
          document.querySelectorAll(".student-tab").forEach((t) => t.classList.remove("active"));
          document.querySelectorAll(".student-content").forEach((c) => c.classList.remove("active"));
          document.getElementById(`tab_${studentId}`).classList.add("active");
          document.getElementById(`content_${studentId}`).classList.add("active");
        }

        addWeekToCurrentStudent() {
          if (!this.currentStudentId) return this.showMessage("يرجى اختيار طالب أولاً", "warning");
          const student = this.currentHalaqa.students.find((s) => s.id === this.currentStudentId);
          if (student) {
            if (!student.data.weeks) student.data.weeks = [];
            student.data.weeks.push({ days: Array(4).fill({}) });
            const weeksContainer = document.getElementById(`weeks_${this.currentStudentId}`);
            const newWeekData = student.data.weeks[student.data.weeks.length - 1];
            weeksContainer.insertAdjacentHTML("beforeend", this.createWeekTableWithData(student.id, newWeekData, student.data.weeks.length));
            this.captureAndSaveHalaqa();
          }
        }

        // باقي وظائف HalaqaManager (createStudentTab, createStudentContentWithData, getHijriDateString, createWeekTableWithData, captureStudentData, calculateAllTotals, 
        // exportHalaqaToCSV, generatePrintableReport, printHalaqaSummary, showMessage) كلها كما في ملفك الأصلي بدون تغييرات مهمة 
        // مع إضافة ensure حفظ تلقائي سريع ودقيق باستخدام debounce في input event (كما موجود في initializeEventListeners).
      }

    const app = new AppManager();

    // روابط الأحداث للعناصر الدائمة:
    document.getElementById("selectMenBtn").addEventListener("click", () => app.selectSection("men"));
    document.getElementById("selectWomenBtn").addEventListener("click", () => app.selectSection("women"));

    document.getElementById("backToSectionsBtn").addEventListener("click", () => {
      window.location.hash = "";
      app.showView("selectionView");
    });

    document.getElementById("backToDashboardBtn").addEventListener("click", () => {
      window.location.hash = "";
      app.showView("dashboardView");
    });

    document.getElementById("backToDashboardFromAnalyticsBtn").addEventListener("click", () => app.showView("dashboardView"));

    document.getElementById("copyShareLinkBtn").addEventListener("click", () => {
      const linkInput = document.getElementById("shareLinkInput");
      linkInput.select();
      linkInput.setSelectionRange(0, 99999);
      try {
        document.execCommand("copy");
        app.halaqaManager.showMessage("تم نسخ الرابط بنجاح!", "success");
      } catch (err) {
        app.halaqaManager.showMessage("فشل نسخ الرابط. يرجى النسخ يدوياً.", "error");
      }
    });

    document.getElementById("closeShareModalBtn").addEventListener("click", () => {
      document.getElementById("shareModal").classList.add("hidden");
    });

    document.getElementById("closeEditModalBtn").addEventListener("click", () => {
      document.getElementById("editModal").classList.add("hidden");
    });

    // استخدام التفويض للأزرار الديناميكية في لوحة التحكم
    document.getElementById("dashboardView").addEventListener("click", (e) => {
      const target = e.target.closest("button");
      if (!target) return;

      const halaqaId = target.dataset.halaqaId;
      const darId = target.dataset.darId;

      if (target.id === "showAnalyticsBtn") {
        app.showAnalytics();
        return;
      }

      if (target.id === "generateReportBtn") {
        app.generateSectionReport();
        return;
      }

      if (app.currentSection === "men") {
        if (target.id === "addNewHalaqaBtn") {
          app.addNewHalaqaToMen();
        } else if (halaqaId) {
          if (target.classList.contains("open-halaqa-btn")) app.openHalaqa(halaqaId);
          else if (target.classList.contains("delete-halaqa-btn")) app.deleteHalaqaFromMen(halaqaId);
          else if (target.classList.contains("share-halaqa-btn")) app.shareHalaqa(halaqaId);
          else if (target.classList.contains("edit-halaqa-btn")) app.editHalaqa(null, halaqaId);
        }
      } else if (app.currentSection === "women") {
        if (target.id === "addNewDarBtn") {
          app.addNewDar();
        } else if (target.classList.contains("add-halaqa-to-dar-btn")) {
          app.addNewHalaqaToDar(darId);
        } else if (target.classList.contains("delete-dar-btn")) {
          app.deleteDar(darId);
        } else if (halaqaId && darId) {
          if (target.classList.contains("open-halaqa-btn")) app.openHalaqa(halaqaId);
          else if (target.classList.contains("delete-halaqa-btn")) app.deleteHalaqaFromDar(darId, halaqaId);
          else if (target.classList.contains("share-halaqa-btn")) app.shareHalaqa(halaqaId);
          else if (target.classList.contains("edit-halaqa-btn")) app.editHalaqa(darId, halaqaId);
        }
      }
    });
  </script>
</body>
</html>
