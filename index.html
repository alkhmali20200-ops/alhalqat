<script>
window.__firebase_config = JSON.stringify({
  apiKey: "AIzaSyAsQQ9GGfZ0DmS4V5Fqv49rypXDEeoxCaA",
  authDomain: "alhalqat-6ac9d.firebaseapp.com", // يجب أن يأخذ القيمة الصحيحة لمشروعك فقط
  projectId: "alhalqat-6ac9d",
  storageBucket: "alhalqat-6ac9d.appspot.com",
  messagingSenderId: "رقم المرسل تجده في إعدادات المشروع Firebase Console",
  appId: "معرّف التطبيق الصحيح لمشروعك من إعدادات Firebase Console"
});
window.__app_id = "alhalqat-6ac9d";
</script>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة حلقات القرآن الكريم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        
        body {
            font-family: 'Amiri', serif;
        }
        
        .print-page { page-break-after: always; }
        
        @media print {
            body, .container {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                font-size: 10px;
            }
            .no-print { display: none !important; }
            .view { display: none !important; }
            #analyticsView {
                display: block !important;
            }
        }
        
        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Amiri', serif;
            background-color: transparent;
        }
        
        .student-tab { transition: all 0.3s ease; cursor: pointer; }
        .student-tab.active { background-color: #3b82f6; color: white; }
        .student-tab:hover { background-color: #e5e7eb; }
        .student-tab.active:hover { background-color: #2563eb; }
        
        .student-content, .view { display: none; }
        .view.active { display: block; }
        .student-content.active { display: block; }

        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.1); background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-50 p-4">

    <!-- App Container -->
    <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-6">

        <!-- View 1: Section Selection -->
        <div id="selectionView" class="view active text-center py-16">
            <h1 class="text-3xl font-bold mb-8 text-gray-700">نظام إدارة حلقات القرآن الكريم</h1>
            <p class="text-lg text-gray-500 mb-12">الرجاء تحديد القسم للبدء</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-8">
                <button id="selectMenBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    قسم الرجال
                </button>
                <button id="selectWomenBtn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    قسم النساء
                </button>
            </div>
             <p id="firebase-status" class="mt-8 text-gray-400 text-sm">جاري تهيئة التطبيق...</p>
        </div>

        <!-- View 2: Halaqa Dashboard -->
        <div id="dashboardView" class="view">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h1 id="dashboardTitle" class="text-3xl font-bold text-gray-700"></h1>
                <button id="backToSectionsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    العودة للأقسام
                </button>
            </div>
            
            <div id="formContainer" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <!-- Form content is now dynamic -->
            </div>

            <hr class="my-8">

            <div>
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                     <h2 id="listTitle" class="text-xl font-bold"></h2>
                     <div class="flex gap-2">
                        <button id="showAnalyticsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                            📊 عرض الإحصائيات
                        </button>
                         <button id="generateReportBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">
                            📈 إنشاء تقرير أسبوعي للقسم
                         </button>
                     </div>
                </div>
                <div id="listContainer">
                    <!-- Content is now fully managed by JavaScript -->
                </div>
            </div>
        </div>

        <!-- View 3: Halaqa Management -->
        <div id="halaqaView" class="view">
            <!-- Back to Dashboard Button -->
             <div class="flex justify-start mb-4 no-print">
                <button id="backToDashboardBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    → العودة للوحة التحكم
                </button>
            </div>

            <!-- Circle Header -->
            <div class="border-2 border-gray-800 p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center gap-2">
                        <span class="font-bold">المعلم /</span>
                        <input type="text" id="teacherName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="اسم المعلم">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">اسم الحلقة /</span>
                        <input type="text" id="circleName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="اسم الحلقة">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">الشهر /</span>
                        <select id="month" class="border-b border-gray-400 bg-transparent">
                           <option value="">اختر الشهر</option><option value="محرم">محرم</option><option value="صفر">صفر</option><option value="ربيع الأول">ربيع الأول</option><option value="ربيع الثاني">ربيع الثاني</option><option value="جمادى الأولى">جمادى الأولى</option><option value="جمادى الثانية">جمادى الثانية</option><option value="رجب">رجب</option><option value="شعبان">شعبان</option><option value="رمضان">رمضان</option><option value="شوال">شوال</option><option value="ذو القعدة">ذو القعدة</option><option value="ذو الحجة">ذو الحجة</option>
                        </select>
                    </div>
                </div>
                <div class="text-center"><span id="currentHijriYear" class="font-bold text-lg"></span></div>
            </div>

            <!-- Student Management Section -->
            <div class="mb-6 no-print">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-3">إدارة الطلاب</h3>
                    <div class="flex gap-4 items-center flex-wrap">
                        <input type="text" id="newStudentName" placeholder="اسم الطالب الجديد" class="flex-grow">
                        <input type="text" id="newStudentGrade" placeholder="المرحلة الدراسية" class="flex-grow">
                        <input type="text" id="newStudentCivilId" placeholder="السجل المدني" class="flex-grow">
                        <button id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">➕ إضافة طالب</button>
                    </div>
                </div>
            </div>

            <!-- Students Tabs -->
            <div id="studentsTabsContainer" class="mb-6 no-print">
                <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-300 pb-2" id="studentsTabs"></div>
            </div>

            <!-- Students Content Area -->
            <div id="studentsContentContainer"></div>

            <!-- Action Buttons -->
            <div class="flex gap-4 mb-6 no-print flex-wrap">
                <button id="addWeekBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">إضافة أسبوع للطالب الحالي</button>
                <button id="calculateBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold">حساب المجاميع</button>
                <button id="printBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold">📄 إنشاء تقرير (PDF/طباعة)</button>
                <button id="exportBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-bold">📄 تصدير لإكسل</button>
            </div>
             <!-- Save Status -->
            <div id="saveStatus" class="mb-4 p-3 rounded-lg hidden"></div>
            
            <!-- Halaqa Summary -->
            <div id="halaqaSummary" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg no-print hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-800">ملخص إنجازات الحلقة</h3>
                    <button id="printSummaryBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1 rounded-lg font-bold">🖨️ طباعة الملخص</button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-green-600" id="halaqaTotalMemorization">0</p>
                        <p class="text-sm text-gray-600">إجمالي أوجه الحفظ</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-indigo-600" id="halaqaTotalReview">0</p>
                        <p class="text-sm text-gray-600">إجمالي أوجه المراجعة</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-teal-600" id="halaqaTotalAttendance">0</p>
                        <p class="text-sm text-gray-600">إجمالي أيام الحضور</p>
                    </div>
                     <div>
                        <p class="text-2xl font-bold text-red-600" id="halaqaTotalAbsence">0</p>
                        <p class="text-sm text-gray-600">إجمالي أيام الغياب</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 4: Analytics View -->
        <div id="analyticsView" class="view">
             <div class="flex flex-wrap justify-between items-center mb-6 gap-4 no-print">
                <h1 id="analyticsTitle" class="text-3xl font-bold text-gray-700"></h1>
                <div class="flex gap-2">
                     <button id="printAnalyticsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">🖨️ طباعة</button>
                     <button id="exportAnalyticsBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">📄 تصدير (وورد)</button>
                     <button id="backToDashboardFromAnalyticsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">→ العودة</button>
                </div>
            </div>
            <div id="analyticsContent" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <canvas id="halaqaChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden no-print">
        <div class="bg-white rounded-lg p-6 w-full max-w-md text-center shadow-2xl">
            <h3 class="text-xl font-bold mb-4">مشاركة رابط الحلقة</h3>
            <p class="text-gray-600 mb-4">انسخ هذا الرابط وأرسله للمعلم/ة. سيتمكن من الدخول مباشرة إلى الحلقة.</p>
            <input type="text" id="shareLinkInput" readonly class="w-full p-2 border rounded-md text-center bg-gray-100 mb-4 font-mono">
            <div class="flex gap-4 justify-center">
                <button id="copyShareLinkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">نسخ الرابط</button>
                <button id="closeShareModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden no-print">
        <div class="bg-white rounded-lg p-6 w-full max-w-md text-center shadow-2xl">
            <h3 class="text-xl font-bold mb-4">تعديل بيانات الحلقة</h3>
            <div class="space-y-4 text-right">
                <div>
                    <label for="editHalaqaName" class="block text-sm font-medium text-gray-700 mb-1">اسم الحلقة الجديد</label>
                    <input type="text" id="editHalaqaName" class="w-full p-2 border rounded-md">
                </div>
                <div>
                    <label for="editTeacherName" class="block text-sm font-medium text-gray-700 mb-1">اسم المعلم/ة الجديد</label>
                    <input type="text" id="editTeacherName" class="w-full p-2 border rounded-md">
                </div>
            </div>
            <div class="flex gap-4 justify-center mt-6">
                <button id="saveEditBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">حفظ التعديلات</button>
                <button id="closeEditModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // ===================================================================================
    // == AppManager: Handles high-level logic (views, sections, halaqa management)
    // ===================================================================================
    class AppManager {
        constructor() {
            this.appData = { men: [], women: [] };
            this.currentSection = null;
            this.currentHalaqaId = null;
            this.halaqaManager = new HalaqaManager(this);
            this.db = null;
            this.unsubscribe = null;
            this.initialLinkHandled = false;
            this.appId = null;
            this.initFirebase();
        }

        async initFirebase() {
            // This is the correct, professional way to handle Firebase configuration.
            // It reads from a global variable `__firebase_config` provided by the environment.
            // If the variable is not present, it will show the "Preview Mode" message.
            if (typeof __firebase_config === 'undefined') {
                document.getElementById('firebase-status').textContent = 'وضع المعاينة (الاتصال بقاعدة البيانات معطل)';
                console.log("Running in preview mode. Firebase disabled.");
                this.handleDirectLinkAfterDataLoad();
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                this.appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                
                const app = initializeApp(firebaseConfig);
                this.db = getFirestore(app);
                const auth = getAuth(app);
                
                if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                     await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                     await signInAnonymously(auth);
                }

                document.getElementById('firebase-status').textContent = 'متصل بقاعدة البيانات ✅';
                this.listenForDataChanges(this.appId);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('firebase-status').textContent = `فشل الاتصال: ${error.message}`;
                this.handleDirectLinkAfterDataLoad(); 
            }
        }
        
        listenForDataChanges(appId) {
            if (!this.db) {
                if (!this.initialLinkHandled) this.handleDirectLinkAfterDataLoad();
                return;
            }
            const docRef = doc(this.db, "artifacts", appId, "public", "data");
            this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    this.appData = { men: data.men || [], women: data.women || [] };
                } else {
                    this.appData = { men: [], women: [] };
                    this.saveData(); 
                }

                if (!this.initialLinkHandled) {
                    this.handleDirectLinkAfterDataLoad();
                }

                if (this.currentSection && document.getElementById('dashboardView').classList.contains('active')) {
                    this.renderDashboard();
                }
            }, (error) => {
                console.error("Error listening to data:", error);
                this.halaqaManager.showMessage('حدث خطأ في المزامنة مع قاعدة البيانات', 'error');
            });
        }
        
        handleDirectLinkAfterDataLoad() {
            this.initialLinkHandled = true;

            const hash = window.location.hash;
            if (hash && hash.startsWith('#halaqa_id=')) {
                const halaqaId = hash.substring('#halaqa_id='.length);
                const section = halaqaId.startsWith('men') ? 'men' : halaqaId.startsWith('women') ? 'women' : null;
                if (section) {
                    this.currentSection = section; 
                    this.openHalaqa(halaqaId); 
                } else {
                    this.showView('selectionView');
                }
            } else {
                 this.showView('selectionView');
            }
        }

        async saveData() {
            if (!this.db || !this.appId) return;
            const docRef = doc(this.db, "artifacts", this.appId, "public", "data");
            try {
                await setDoc(docRef, this.appData);
            } catch (error) {
                console.error("CRITICAL SAVE ERROR:", error);
                this.halaqaManager.showMessage('فشل الحفظ: صلاحيات الوصول مرفوضة. الرجاء التأكد من تطبيق قواعد الأمان في Firebase بشكل صحيح.', 'error');
                throw error;
            }
        }

        showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const viewToShow = document.getElementById(viewId)
            if(viewToShow) {
                viewToShow.classList.add('active');
                if (viewId === 'dashboardView') this.renderDashboard();
            } else {
                document.getElementById('selectionView').classList.add('active');
            }
        }

        selectSection(section) {
            this.currentSection = section;
            document.getElementById('dashboardTitle').textContent = `لوحة تحكم ${section === 'men' ? 'قسم الرجال' : 'قسم النساء'}`;
            this.showView('dashboardView');
        }

        renderDashboard() {
            const listContainer = document.getElementById('listContainer');
            const formContainer = document.getElementById('formContainer');
            const listTitle = document.getElementById('listTitle');
            listContainer.innerHTML = '';

            if (this.currentSection === 'men') {
                listTitle.textContent = 'الحلقات المسجلة';
                formContainer.innerHTML = `
                    <h2 class="text-xl font-bold mb-4">إضافة حلقة جديدة</h2>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-grow"><label for="newHalaqaName" class="block text-sm font-medium text-gray-700">اسم الحلقة</label><input type="text" id="newHalaqaName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: حلقة المبتدئين"></div>
                        <div class="flex-grow"><label for="newTeacherName" class="block text-sm font-medium text-gray-700">اسم المعلم/ة</label><input type="text" id="newTeacherName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="اسم المعلم/ة المسؤول/ة"></div>
                        <button id="addNewHalaqaBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة</button>
                    </div>`;
                
                listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                const halaqas = this.appData.men || [];
                if (halaqas.length === 0) {
                    listContainer.innerHTML = `<p class="text-gray-500 col-span-full">لا توجد حلقات مسجلة في هذا القسم بعد.</p>`;
                } else {
                    halaqas.forEach(halaqa => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-200';
                        card.innerHTML = `
                            <h3 class="text-lg font-bold text-blue-800">${halaqa.circleName}</h3>
                            <p class="text-gray-600 mb-4">${halaqa.teacherName}</p>
                            <div class="flex gap-2 mt-4 flex-wrap">
                               <button data-halaqa-id="${halaqa.id}" class="open-halaqa-btn flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">فتح</button>
                               <button data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">تعديل</button>
                               <button data-halaqa-id="${halaqa.id}" class="share-halaqa-btn flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">مشاركة</button>
                               <button data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">حذف</button>
                            </div>`;
                        listContainer.appendChild(card);
                    });
                }
            } else if (this.currentSection === 'women') {
                listTitle.textContent = 'الدور المسجلة';
                formContainer.innerHTML = `
                    <h2 class="text-xl font-bold mb-4">إضافة دار جديدة</h2>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-grow"><label for="newDarName" class="block text-sm font-medium text-gray-700">اسم الدار</label><input type="text" id="newDarName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: دار الهدى النسائية"></div>
                        <button id="addNewDarBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة دار</button>
                    </div>`;

                listContainer.className = 'space-y-6';
                const dars = this.appData.women || [];
                if (dars.length === 0) {
                    listContainer.innerHTML = `<p class="text-gray-500">لا توجد دور مسجلة في هذا القسم بعد.</p>`;
                } else {
                    dars.forEach(dar => {
                        const darContainer = document.createElement('div');
                        darContainer.className = 'bg-white p-6 rounded-lg shadow-lg border border-pink-200';
                        
                        let halaqaCardsHTML = (dar.halaqas || []).map(halaqa => `
                            <div class="bg-gray-50 p-4 rounded-md border flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                                <div>
                                    <h4 class="font-bold text-gray-800">${halaqa.circleName}</h4>
                                    <p class="text-sm text-gray-500">${halaqa.teacherName}</p>
                                </div>
                                <div class="flex gap-2 flex-shrink-0 flex-wrap">
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="open-halaqa-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm">فتح</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md text-sm">تعديل</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="share-halaqa-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-md text-sm">مشاركة</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm">حذف</button>
                                </div>
                            </div>
                        `).join('');

                        darContainer.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-2xl font-bold text-pink-700">${dar.name}</h3>
                                <button data-dar-id="${dar.id}" class="delete-dar-btn bg-red-100 text-red-700 hover:bg-red-200 font-bold py-1 px-3 rounded-md">حذف الدار</button>
                            </div>
                            <div class="space-y-3 mb-6">${halaqaCardsHTML || '<p class="text-gray-500">لا توجد حلقات في هذه الدار بعد.</p>'}</div>
                            <div class="bg-pink-50 p-4 rounded-lg border border-pink-200 mt-4">
                                <h4 class="font-bold mb-3">إضافة حلقة جديدة لهذه الدار</h4>
                                <div class="flex flex-wrap gap-4 items-end">
                                    <div class="flex-grow"><label for="newHalaqaName_${dar.id}" class="block text-sm font-medium text-gray-700">اسم الحلقة</label><input type="text" id="newHalaqaName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: حلقة المتقدمات"></div>
                                    <div class="flex-grow"><label for="newTeacherName_${dar.id}" class="block text-sm font-medium text-gray-700">اسم المعلمة</label><input type="text" id="newTeacherName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="اسم المعلمة المسؤولة"></div>
                                    <button data-dar-id="${dar.id}" class="add-halaqa-to-dar-btn bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة حلقة</button>
                                </div>
                            </div>`;
                        listContainer.appendChild(darContainer);
                    });
                }
            }
        }
        
        shareHalaqa(halaqaId) {
            try {
                const baseUrl = window.location.href.split('#')[0];
                const shareableLink = `${baseUrl}#halaqa_id=${halaqaId}`;
                document.getElementById('shareLinkInput').value = shareableLink;
                document.getElementById('shareModal').classList.remove('hidden');
            } catch (e) {
                console.error("Error creating share link:", e);
                this.halaqaManager.showMessage('فشل إنشاء رابط المشاركة.', 'error');
            }
        }

        addNewHalaqaToMen() {
            const circleName = document.getElementById('newHalaqaName').value.trim();
            const teacherName = document.getElementById('newTeacherName').value.trim();
            if (!circleName || !teacherName) { this.halaqaManager.showMessage('يرجى إدخال اسم الحلقة واسم المعلم', 'warning'); return; }
            const newHalaqa = { id: `men_${Date.now()}`, circleName, teacherName, month: '', students: [], studentIdCounter: 1 };
            this.appData.men.push(newHalaqa);
            this.saveData().then(() => {
                this.halaqaManager.showMessage('تمت الإضافة بنجاح!', 'success');
                document.getElementById('newHalaqaName').value = '';
                document.getElementById('newTeacherName').value = '';
            });
        }

        deleteHalaqaFromMen(halaqaId) {
            const halaqaIndex = this.appData.men.findIndex(h => h.id === halaqaId);
            if (halaqaIndex > -1) {
                this.appData.men.splice(halaqaIndex, 1);
                this.saveData().then(() => this.halaqaManager.showMessage('تم حذف الحلقة بنجاح', 'warning'));
            }
        }

        addNewDar() {
            const darNameInput = document.getElementById('newDarName');
            const darName = darNameInput.value.trim();
            if (!darName) { return this.halaqaManager.showMessage('يرجى إدخال اسم الدار', 'warning'); }
            const newDar = { id: `dar_${Date.now()}`, name: darName, halaqas: [] };
            this.appData.women.push(newDar);
            this.saveData().then(() => {
                darNameInput.value = '';
                this.halaqaManager.showMessage('تمت إضافة الدار بنجاح', 'success');
            });
        }

        deleteDar(darId) {
            const darIndex = this.appData.women.findIndex(d => d.id === darId);
            if (darIndex > -1) {
                this.appData.women.splice(darIndex, 1);
                this.saveData().then(() => this.halaqaManager.showMessage('تم حذف الدار بنجاح', 'warning'));
            }
        }

        addNewHalaqaToDar(darId) {
            const halaqaNameInput = document.getElementById(`newHalaqaName_${darId}`);
            const teacherNameInput = document.getElementById(`newTeacherName_${darId}`);
            const circleName = halaqaNameInput.value.trim();
            const teacherName = teacherNameInput.value.trim();
            if (!circleName || !teacherName) { return this.halaqaManager.showMessage('يرجى إدخال اسم الحلقة واسم المعلمة', 'warning');}
            const dar = this.appData.women.find(d => d.id === darId);
            if (dar) {
                const newHalaqa = { id: `women_${Date.now()}`, circleName, teacherName, month: '', students: [], studentIdCounter: 1 };
                if (!dar.halaqas) dar.halaqas = [];
                dar.halaqas.push(newHalaqa);
                this.saveData().then(() => {
                    halaqaNameInput.value = '';
                    teacherNameInput.value = '';
                    this.halaqaManager.showMessage('تمت إضافة الحلقة بنجاح', 'success');
                });
            }
        }

        deleteHalaqaFromDar(darId, halaqaId) {
            const dar = this.appData.women.find(d => d.id === darId);
            if (dar && dar.halaqas) {
                const halaqaIndex = dar.halaqas.findIndex(h => h.id === halaqaId);
                if (halaqaIndex > -1) {
                    dar.halaqas.splice(halaqaIndex, 1);
                    this.saveData().then(() => this.halaqaManager.showMessage('تم حذف الحلقة بنجاح', 'warning'));
                }
            }
        }

        editHalaqa(darId, halaqaId) {
            let halaqa;
            if (this.currentSection === 'men') {
                halaqa = this.appData.men.find(h => h.id === halaqaId);
            } else {
                const dar = this.appData.women.find(d => d.id === darId);
                if (dar) halaqa = (dar.halaqas || []).find(h => h.id === halaqaId);
            }

            if (halaqa) {
                const modal = document.getElementById('editModal');
                const halaqaNameInput = document.getElementById('editHalaqaName');
                const teacherNameInput = document.getElementById('editTeacherName');
                const saveBtn = document.getElementById('saveEditBtn');
                
                halaqaNameInput.value = halaqa.circleName;
                teacherNameInput.value = halaqa.teacherName;
                
                const newSaveBtn = saveBtn.cloneNode(true);
                saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);

                newSaveBtn.onclick = () => {
                    const newCircleName = halaqaNameInput.value.trim();
                    const newTeacherName = teacherNameInput.value.trim();
                    if (!newCircleName || !newTeacherName) {
                        this.halaqaManager.showMessage('الرجاء عدم ترك الحقول فارغة', 'warning');
                        return;
                    }
                    halaqa.circleName = newCircleName;
                    halaqa.teacherName = newTeacherName;
                    this.saveData().then(() => {
                        this.halaqaManager.showMessage('تم تعديل بيانات الحلقة بنجاح', 'success');
                        modal.classList.add('hidden');
                    });
                };
                modal.classList.remove('hidden');
            }
        }

        openHalaqa(halaqaId) {
            this.currentHalaqaId = halaqaId;
            let halaqa;
            if (this.currentSection === 'men') {
                halaqa = (this.appData.men || []).find(h => h.id === halaqaId);
            } else if (this.currentSection === 'women') {
                for (const dar of (this.appData.women || [])) {
                    halaqa = (dar.halaqas || []).find(h => h.id === halaqaId);
                    if (halaqa) break;
                }
            }
            if (halaqa) {
                this.halaqaManager.loadHalaqa(halaqa);
                this.showView('halaqaView');
            }
        }

        async updateCurrentHalaqa(halaqaData) {
            if (this.currentSection === 'men') {
                const halaqaIndex = this.appData.men.findIndex(h => h.id === this.currentHalaqaId);
                if (halaqaIndex > -1) this.appData.men[halaqaIndex] = halaqaData;
            } else if (this.currentSection === 'women') {
                for (const dar of this.appData.women) {
                    const halaqaIndex = (dar.halaqas || []).findIndex(h => h.id === this.currentHalaqaId);
                    if (halaqaIndex > -1) {
                        dar.halaqas[halaqaIndex] = halaqaData;
                        break;
                    }
                }
            }
            await this.saveData();
        }
        
        showAnalytics() {
            const sectionName = this.currentSection === 'men' ? 'قسم الرجال' : 'قسم النساء';
            document.getElementById('analyticsTitle').textContent = `إحصائيات أداء الحلقات في ${sectionName}`;
            this.showView('analyticsView');

            let allHalaqas = [];
             if (this.currentSection === 'men') {
                allHalaqas = this.appData.men || [];
            } else if (this.currentSection === 'women') {
                (this.appData.women || []).forEach(dar => {
                    (dar.halaqas || []).forEach(halaqa => {
                        allHalaqas.push({ ...halaqa, darName: dar.name });
                    });
                });
            }

            const ctx = document.getElementById('halaqaChart').getContext('2d');
            if (window.myHalaqaChart instanceof Chart) {
                window.myHalaqaChart.destroy();
            }

            const labels = allHalaqas.map(h => h.circleName);
            const memorizationData = allHalaqas.map(h => this.halaqaManager.calculateHalaqaTotals(h).totalMemorization);
            const reviewData = allHalaqas.map(h => this.halaqaManager.calculateHalaqaTotals(h).totalReview);
            const attendanceData = allHalaqas.map(h => this.halaqaManager.calculateHalaqaTotals(h).totalAttendance);
            
            window.myHalaqaChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'أوجه الحفظ',
                            data: memorizationData,
                            backgroundColor: 'rgba(54, 162, 235, 0.6)',
                            borderColor: 'rgba(54, 162, 235, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'أوجه المراجعة',
                            data: reviewData,
                            backgroundColor: 'rgba(75, 192, 192, 0.6)',
                            borderColor: 'rgba(75, 192, 192, 1)',
                            borderWidth: 1
                        },
                        {
                            label: 'أيام الحضور',
                            data: attendanceData,
                            backgroundColor: 'rgba(255, 206, 86, 0.6)',
                            borderColor: 'rgba(255, 206, 86, 1)',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'top',
                             labels: { font: { family: 'Amiri', size: 14 } }
                        },
                        title: {
                            display: true,
                            text: 'مقارنة أداء الحلقات',
                            font: { family: 'Amiri', size: 18 }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { font: { family: 'Amiri' } } },
                        x: { ticks: { font: { family: 'Amiri', size: 12 } } }
                    }
                }
            });
        }
        
        printAnalytics() {
            window.print();
        }

        exportAnalyticsToWord() {
            if (!window.myHalaqaChart) {
                this.halaqaManager.showMessage('لا توجد بيانات لتصديرها', 'error');
                return;
            }

            const sectionName = this.currentSection === 'men' ? 'قسم الرجال' : 'قسم النساء';
            const title = `<h1>تقرير إحصائيات ${sectionName}</h1>`;
            const chartImage = window.myHalaqaChart.toBase64Image();
            
            const chartData = window.myHalaqaChart.data;
            let tableHtml = `<table border="1" style="border-collapse: collapse; width: 100%; text-align: right; font-family: sans-serif;">
                                <thead>
                                    <tr>
                                        <th>الحلقة</th>
                                        <th>${chartData.datasets[0].label}</th>
                                        <th>${chartData.datasets[1].label}</th>
                                        <th>${chartData.datasets[2].label}</th>
                                    </tr>
                                </thead>
                                <tbody>`;

            chartData.labels.forEach((label, index) => {
                tableHtml += `<tr>
                                <td>${label}</td>
                                <td>${chartData.datasets[0].data[index]}</td>
                                <td>${chartData.datasets[1].data[index]}</td>
                                <td>${chartData.datasets[2].data[index]}</td>
                              </tr>`;
            });
            tableHtml += `</tbody></table>`;
            
            const htmlContent = `
                <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
                <head>
                    <meta charset='utf-8'>
                    <title>تقرير الإحصائيات</title>
                    <style>
                        body { font-family: 'Arial', sans-serif; direction: rtl; }
                        table { border-collapse: collapse; width: 100%; }
                        th, td { border: 1px solid #dddddd; text-align: right; padding: 8px; }
                        th { background-color: #f2f2f2; }
                    </style>
                </head>
                <body>
                    ${title}
                    <br/>
                    <h2>الرسم البياني</h2>
                    <p><img src="${chartImage}" alt="Analytics Chart" style="max-width: 100%;"></p>
                    <br/>
                    <h2>جدول البيانات</h2>
                    ${tableHtml}
                </body>
                </html>`;

            const blob = new Blob(['\ufeff', htmlContent], {
                type: 'application/msword'
            });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `statistics_report_${this.currentSection}.doc`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        generateSectionReport() {
            let sectionHalaqas = [];
            let sectionName = '';
            if (this.currentSection === 'men') {
                sectionHalaqas = this.appData.men || [];
                sectionName = 'الرجال';
            } else if (this.currentSection === 'women') {
                sectionName = 'النساء';
                (this.appData.women || []).forEach(dar => {
                    (dar.halaqas || []).forEach(halaqa => {
                        sectionHalaqas.push({ ...halaqa, darName: dar.name });
                    });
                });
            }

            if (sectionHalaqas.length === 0) {
                return this.halaqaManager.showMessage('لا توجد حلقات في هذا القسم لإنشاء تقرير', 'warning');
            }
            const today = this.halaqaManager.getHijriDateString(new Date());

            let reportHTML = `
                <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير قسم ${sectionName}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
                    body { font-family: 'Amiri', serif; margin: 20px; } table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
                    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; } thead { background-color: #f2f2f2; }
                    .header { text-align: center; margin-bottom: 2rem; }
                </style></head><body>
                    <div class="header">
                        <h1 class="text-3xl font-bold">التقرير الأسبوعي الشامل لقسم ${sectionName}</h1>
                        <p class="text-lg text-gray-600">تاريخ التقرير: ${today}</p>
                    </div>
                    <table><thead><tr>
                        ${this.currentSection === 'women' ? '<th>اسم الدار</th>' : ''}
                        <th>اسم الحلقة</th><th>اسم المعلم/ة</th><th>عدد الطلاب</th><th>إجمالي أوجه الحفظ</th>
                        <th>إجمالي أوجه المراجعة</th><th>إجمالي الحضور</th><th>إجمالي الغياب</th>
                    </tr></thead><tbody>`;

            sectionHalaqas.forEach(halaqa => {
                const totals = this.halaqaManager.calculateHalaqaTotals(halaqa);
                reportHTML += `
                    <tr>
                        ${this.currentSection === 'women' ? `<td>${halaqa.darName || ''}</td>` : ''}
                        <td>${halaqa.circleName}</td><td>${halaqa.teacherName}</td><td>${(halaqa.students || []).length}</td>
                        <td class="font-bold text-green-600">${totals.totalMemorization}</td><td class="font-bold text-indigo-600">${totals.totalReview}</td>
                        <td class="font-bold text-teal-600">${totals.totalAttendance}</td><td class="font-bold text-red-600">${totals.totalAbsence}</td>
                    </tr>`;
            });

            reportHTML += `</tbody></table></body></html>`;
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            reportWindow.onload = () => reportWindow.print();
        }
    }

    // ===================================================================================
    // == HalaqaManager: Manages the detailed view of a single halaqa (students, tables)
    // ===================================================================================
    class HalaqaManager {
        constructor(appManager) {
            this.app = appManager;
            this.currentHalaqa = null;
            this.currentStudentId = null;
            this.debounceTimer = null;
            this.initializeEventListeners();
        }

        initializeEventListeners() {
            document.getElementById('addStudentBtn').addEventListener('click', () => this.addStudent());
            document.getElementById('addWeekBtn').addEventListener('click', () => this.addWeekToCurrentStudent());
            document.getElementById('calculateBtn').addEventListener('click', () => this.calculateAllTotals());
            document.getElementById('printBtn').addEventListener('click', () => this.generatePrintableReport());
            document.getElementById('exportBtn').addEventListener('click', () => this.exportHalaqaToCSV());
            document.getElementById('printSummaryBtn').addEventListener('click', () => this.printHalaqaSummary());
            document.getElementById('newStudentName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.addStudent();
            });
            document.getElementById('halaqaView').addEventListener('input', () => {
                this.showMessage('جاري الحفظ...', 'info');
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.captureAndSaveHalaqa().then(() => {
                        this.showMessage('تم الحفظ بنجاح!', 'success');
                    }).catch(() => {
                        // Error message is already shown by AppManager's saveData
                    });
                }, 1500);
            });
        }
        
        calculateHalaqaTotals(halaqa) {
            let totals = { totalMemorization: 0, totalReview: 0, totalAttendance: 0, totalAbsence: 0 };
            if (!halaqa.students) return totals;
            halaqa.students.forEach(student => {
                (student.data.weeks || []).forEach(week => {
                    (week.days || []).forEach(day => {
                        totals.totalMemorization += Number(day.hifdhFaces) || 0;
                        totals.totalReview += Number(day.murajaaFaces) || 0;
                        if (day.attendance === 'حضر') totals.totalAttendance++;
                        else if (day.attendance === 'غاب') totals.totalAbsence++;
                    });
                });
            });
            return totals;
        }

        getHijriDateParts() {
            const today = new Date();
            const yearFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { year: 'numeric' });
            const monthFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { month: 'long' });
            
            const year = yearFormatter.format(today).replace(/\s*هـ.*/, '');
            const monthName = monthFormatter.format(today);
            
            return { year, monthName };
        }

        loadHalaqa(halaqaData) {
            this.currentHalaqa = JSON.parse(JSON.stringify(halaqaData));
            document.getElementById('studentsTabs').innerHTML = '';
            document.getElementById('studentsContentContainer').innerHTML = '';
            document.getElementById('halaqaSummary').classList.add('hidden');

            const { year, monthName } = this.getHijriDateParts();
            document.getElementById('currentHijriYear').textContent = `لعام ${year}هـ`;
            document.getElementById('teacherName').value = this.currentHalaqa.teacherName;
            document.getElementById('circleName').value = this.currentHalaqa.circleName;
            
            const monthSelect = document.getElementById('month');
            if (this.currentHalaqa.month) {
                monthSelect.value = this.currentHalaqa.month;
            } else {
                const currentMonthOption = Array.from(monthSelect.options).find(opt => opt.text === monthName);
                if (currentMonthOption) {
                    monthSelect.value = currentMonthOption.value;
                    this.currentHalaqa.month = currentMonthOption.value;
                } else {
                     monthSelect.value = "";
                }
            }
            
            (this.currentHalaqa.students || []).forEach(student => {
                this.createStudentTab(student);
                this.createStudentContentWithData(student);
            });
            if (this.currentHalaqa.students && this.currentHalaqa.students.length > 0) {
                this.switchToStudent(this.currentHalaqa.students[0].id);
            } else {
                this.currentStudentId = null;
            }
        }

        async captureAndSaveHalaqa() {
            if (!this.currentHalaqa) return;
            this.currentHalaqa.teacherName = document.getElementById('teacherName').value;
            this.currentHalaqa.circleName = document.getElementById('circleName').value;
            this.currentHalaqa.month = document.getElementById('month').value;
            (this.currentHalaqa.students || []).forEach(student => this.captureStudentData(student.id));
            await this.app.updateCurrentHalaqa(this.currentHalaqa);
        }

        addStudent() {
            const nameInput = document.getElementById('newStudentName');
            const studentName = nameInput.value.trim();
            if (!studentName) return this.showMessage('يرجى إدخال اسم الطالب', 'warning');
            if (!this.currentHalaqa.studentIdCounter) this.currentHalaqa.studentIdCounter = (this.currentHalaqa.students || []).length + 1;
            const studentId = `student_${this.currentHalaqa.studentIdCounter++}`;
            const newStudent = {
                id: studentId, name: studentName,
                grade: document.getElementById('newStudentGrade').value.trim(),
                civilId: document.getElementById('newStudentCivilId').value.trim(),
                data: { weeks: [{ days: Array(4).fill({}).map(() => ({ date: this.getHijriDateString(new Date()) })) }] }
            };
            if (!this.currentHalaqa.students) this.currentHalaqa.students = [];
            this.currentHalaqa.students.push(newStudent);
            this.createStudentTab(newStudent);
            this.createStudentContentWithData(newStudent);
            this.switchToStudent(studentId);
            nameInput.value = '';
            document.getElementById('newStudentGrade').value = '';
            document.getElementById('newStudentCivilId').value = '';
            this.captureAndSaveHalaqa();
            this.showMessage('تم إضافة الطالب بنجاح!', 'success');
        }
        
        removeStudent(studentId) {
            const studentIndex = this.currentHalaqa.students.findIndex(s => s.id === studentId);
            if(studentIndex > -1){
                const studentName = this.currentHalaqa.students[studentIndex].name;
                this.currentHalaqa.students.splice(studentIndex, 1);
                document.getElementById(`tab_${studentId}`).remove();
                document.getElementById(`content_${studentId}`).remove();
                if (this.currentStudentId === studentId) {
                    this.currentStudentId = this.currentHalaqa.students.length > 0 ? this.currentHalaqa.students[0].id : null;
                    if (this.currentStudentId) this.switchToStudent(this.currentStudentId);
                }
                this.captureAndSaveHalaqa();
                this.showMessage(`تم حذف الطالب: ${studentName}`, 'warning');
            }
        }

        switchToStudent(studentId) {
            if (!this.currentHalaqa || !this.currentHalaqa.students.find(s => s.id === studentId)) return;
            this.currentStudentId = studentId;
            document.querySelectorAll('.student-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.student-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab_${studentId}`).classList.add('active');
            document.getElementById(`content_${studentId}`).classList.add('active');
        }
        
        addWeekToCurrentStudent() {
            if (!this.currentStudentId) return this.showMessage('يرجى اختيار طالب أولاً', 'warning');
            const student = this.currentHalaqa.students.find(s => s.id === this.currentStudentId);
            if (student) {
                if (!student.data.weeks) student.data.weeks = [];
                student.data.weeks.push({ days: Array(4).fill({}) });
                const weeksContainer = document.getElementById(`weeks_${this.currentStudentId}`);
                const newWeekData = student.data.weeks[student.data.weeks.length - 1];
                weeksContainer.insertAdjacentHTML('beforeend', this.createWeekTableWithData(student.id, newWeekData, student.data.weeks.length));
                this.captureAndSaveHalaqa();
            }
        }
        
        createStudentTab(student) {
            const tabsContainer = document.getElementById('studentsTabs');
            const tab = document.createElement('div');
            tab.id = `tab_${student.id}`;
            tab.className = 'student-tab px-4 py-2 rounded-lg border border-gray-300 font-bold flex items-center gap-2';
            tab.innerHTML = `<span class="flex-1 select-none">${student.name}</span>`;
            tab.addEventListener('click', () => this.switchToStudent(student.id));
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn text-red-500 hover:text-red-700 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold';
            deleteBtn.textContent = '✕';
            deleteBtn.title = 'حذف الطالب';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                this.removeStudent(student.id);
            });
            tab.appendChild(deleteBtn);
            tabsContainer.appendChild(tab);
        }

        createStudentContentWithData(student) {
            const contentContainer = document.getElementById('studentsContentContainer');
            const studentDiv = document.createElement('div');
            studentDiv.id = `content_${student.id}`;
            studentDiv.className = 'student-content student-card';
            let weeksHTML = (student.data.weeks || []).map((weekData, index) => this.createWeekTableWithData(student.id, weekData, index + 1)).join('');
            
            studentDiv.innerHTML = `
                <div class="border-2 border-blue-600 p-4 mb-6 bg-blue-50">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><span class="font-bold">اسم الطالب:</span> <span class="text-blue-800 font-bold">${student.name}</span></div>
                        <div><span class="font-bold">المرحلة الدراسية:</span> <span class="text-blue-800">${student.grade}</span></div>
                        <div><span class="font-bold">السجل المدني:</span> <span class="text-blue-800">${student.civilId}</span></div>
                    </div>
                </div>
                <div id="weeks_${student.id}">${weeksHTML}</div>
                <div id="summary_${student.id}" class="mt-6 p-4 bg-gray-50 border border-gray-300 rounded-lg">
                    <h4 class="font-bold text-center text-lg mb-2">الملخص النهائي للطالب</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div><p class="font-bold">إجمالي الحفظ: <span class="total-memorization text-green-600">0</span></p></div>
                        <div><p class="font-bold">إجمالي المراجعة: <span class="total-review text-indigo-600">0</span></p></div>
                        <div><p class="font-bold">أيام الحضور: <span class="total-attendance text-teal-600">0</span></p></div>
                        <div><p class="font-bold">أيام الغياب: <span class="total-absence text-red-600">0</span></p></div>
                    </div>
                </div>`;
            contentContainer.appendChild(studentDiv);
        }

        getHijriDateString(date) {
            const formatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return formatter.format(date).replace(/\s*هـ.*/, '');
        }

        createWeekTableWithData(studentId, weekData, weekNumber) {
            const days = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء'];
            
            const createTextField = (dayIndex, field, placeholder = '', value = '', type = 'text') => {
                 return `<input type="${type}" placeholder="${placeholder}" value="${value || ''}" class="w-full text-center border-gray-300 rounded" data-day-index="${dayIndex}" data-field="${field}">`;
            };
            
            const createTextArea = (dayIndex, field, placeholder = '', value = '') => {
                 return `<textarea placeholder="${placeholder}" class="w-full border-gray-300 rounded text-sm p-1" rows="2" data-day-index="${dayIndex}" data-field="${field}">${value || ''}</textarea>`;
            };

            const createAttendanceSelect = (dayIndex, field, value = '') => {
                 return `<select class="w-full border-gray-300 rounded attendance-select" data-day-index="${dayIndex}" data-field="${field}">
                            <option value=""></option>
                            <option value="حضر" ${value === 'حضر' ? 'selected' : ''}>حضر</option>
                            <option value="غاب" ${value === 'غاب' ? 'selected' : ''}>غاب</option>
                            <option value="مستأذن" ${value === 'مستأذن' ? 'selected' : ''}>مستأذن</option>
                        </select>`;
            };
            
            const createGradeSelect = (dayIndex, field, value = '') => {
                 return `<select class="w-full border-gray-300 rounded" data-day-index="${dayIndex}" data-field="${field}">
                            <option value=""></option>
                            <option value="ممتاز" ${value === 'ممتاز' ? 'selected' : ''}>ممتاز</option>
                            <option value="جيد جداً" ${value === 'جيد جداً' ? 'selected' : ''}>جيد جداً</option>
                            <option value="جيد" ${value === 'جيد' ? 'selected' : ''}>جيد</option>
                            <option value="مقبول" ${value === 'مقبول' ? 'selected' : ''}>مقبول</option>
                            <option value="ضعيف" ${value === 'ضعيف' ? 'selected' : ''}>ضعيف</option>
                        </select>`;
            };

            // --- MOBILE VIEW HTML ---
            const mobileDayCards = days.map((day, dayIndex) => {
                const dayData = weekData.days?.[dayIndex] || {};
                const hijriDateString = this.getHijriDateString(new Date());

                return `
                <div class="border-b-2 border-gray-200 p-3 last:border-b-0">
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="font-bold text-lg text-blue-800">${day}</h5>
                        <div class="w-1/2">
                            ${createTextField(dayIndex, 'date', '', dayData.date || hijriDateString)}
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">الحضور</label>
                        ${createAttendanceSelect(dayIndex, 'attendance', dayData.attendance)}
                    </div>

                    <!-- Hifdh Section -->
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <h6 class="font-bold mb-2 text-blue-700">الحفظ</h6>
                        <div class="grid grid-cols-2 gap-3 items-center">
                            <label class="block text-sm font-medium">السورة</label> ${createTextField(dayIndex, 'hifdhSurah', 'السورة', dayData.hifdhSurah)}
                            <label class="block text-sm font-medium">من</label> ${createTextField(dayIndex, 'hifdhFrom', 'آية', dayData.hifdhFrom)}
                            <label class="block text-sm font-medium">إلى</label> ${createTextField(dayIndex, 'hifdhTo', 'آية', dayData.hifdhTo)}
                            <label class="block text-sm font-medium">التقدير</label> ${createGradeSelect(dayIndex, 'hifdhGrade', dayData.hifdhGrade)}
                            <label class="block text-sm font-medium">عدد الأوجه</label> ${createTextField(dayIndex, 'hifdhFaces', '0', dayData.hifdhFaces, 'number')}
                        </div>
                    </div>

                    <!-- Murajaa Section -->
                     <div class="bg-green-50 p-3 rounded-lg border border-green-200 mt-3">
                        <h6 class="font-bold mb-2 text-green-700">المراجعة</h6>
                        <div class="grid grid-cols-2 gap-3 items-center">
                            <label class="block text-sm font-medium">السورة</label> ${createTextField(dayIndex, 'murajaaSurah', 'السورة', dayData.murajaaSurah)}
                            <label class="block text-sm font-medium">من</label> ${createTextField(dayIndex, 'murajaaFrom', 'آية', dayData.murajaaFrom)}
                            <label class="block text-sm font-medium">إلى</label> ${createTextField(dayIndex, 'murajaaTo', 'آية', dayData.murajaaTo)}
                            <label class="block text-sm font-medium">التقدير</label> ${createGradeSelect(dayIndex, 'murajaaGrade', dayData.murajaaGrade)}
                            <label class="block text-sm font-medium">عدد الأوجه</label> ${createTextField(dayIndex, 'murajaaFaces', '0', dayData.murajaaFaces, 'number')}
                        </div>
                    </div>
                    
                    <!-- Daily Notes Section -->
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">ملاحظات اليوم</label>
                        ${createTextArea(dayIndex, 'notes', 'ملاحظات...', dayData.notes)}
                    </div>
                </div>
                `;
            }).join('');

            // --- DESKTOP VIEW HTML ---
            const desktopDayRows = days.map((day, dayIndex) => {
                const dayData = weekData.days?.[dayIndex] || {};
                const hijriDateString = this.getHijriDateString(new Date());

                return `<tr>
                    <td class="border p-2 font-bold bg-gray-50">${day}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'date', '', dayData.date || hijriDateString)}</td>
                    <td class="border p-1">${createAttendanceSelect(dayIndex, 'attendance', dayData.attendance)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhSurah', 'السورة', dayData.hifdhSurah)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhFrom', 'آية', dayData.hifdhFrom)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhTo', 'آية', dayData.hifdhTo)}</td>
                    <td class="border p-1">${createGradeSelect(dayIndex, 'hifdhGrade', dayData.hifdhGrade)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhFaces', '', dayData.hifdhFaces, 'number')}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaSurah', 'السورة', dayData.murajaaSurah)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaFrom', 'آية', dayData.murajaaFrom)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaTo', 'آية', dayData.murajaaTo)}</td>
                    <td class="border p-1">${createGradeSelect(dayIndex, 'murajaaGrade', dayData.murajaaGrade)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaFaces', '', dayData.murajaaFaces, 'number')}</td>
                    <td class="border p-1">${createTextArea(dayIndex, 'notes', 'ملاحظات', dayData.notes)}</td>
                </tr>`;
            }).join('');

            return `<div class="week-table mb-8 border border-gray-400 rounded-lg overflow-hidden">
                <h4 class="font-bold p-2 bg-gray-100 text-center">الأسبوع ${weekNumber}</h4>
                
                <!-- Mobile View -->
                <div class="block md:hidden">${mobileDayCards}</div>

                <!-- Desktop View -->
                <div class="hidden md:block">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[1200px] whitespace-nowrap">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th rowspan="2" class="border p-1">اليوم</th><th rowspan="2" class="border p-1">التاريخ</th><th rowspan="2" class="border p-1">الحضور</th>
                                    <th colspan="5" class="border p-1">الحفظ</th><th colspan="5" class="border p-1">المراجعة</th>
                                    <th rowspan="2" class="border p-1">الملاحظات</th>
                                </tr>
                                <tr class="bg-gray-100 text-xs">
                                    <th class="border p-1">السورة</th><th class="border p-1">من</th><th class="border p-1">إلى</th><th class="border p-1">التقدير</th><th class="border p-1">عدد الأوجه</th>
                                    <th class="border p-1">السورة</th><th class="border p-1">من</th><th class="border p-1">إلى</th><th class="border p-1">التقدير</th><th class="border p-1">عدد الأوجه</th>
                                </tr>
                            </thead>
                            <tbody>${desktopDayRows}</tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-yellow-50 font-bold p-2 text-center grid grid-cols-1 sm:grid-cols-2">
                    <div>حصيلة الحفظ الأسبوعية: <span class="weekly-memorization">0</span></div>
                    <div>حصيلة المراجعة الأسبوعية: <span class="weekly-review">0</span></div>
                </div>
            </div>`;
        }
        
        captureStudentData(studentId) {
            const student = this.currentHalaqa.students.find(s => s.id === studentId);
            if (!student) return;
            const contentElement = document.getElementById(`content_${studentId}`);
            if (contentElement) {
                student.data.weeks = [];
                const weekTables = contentElement.querySelectorAll('.week-table');
                weekTables.forEach(table => {
                    const weekData = { 
                        days: Array(4).fill(0).map(() => ({}))
                    };
                    const allInputs = table.querySelectorAll('input[data-field], select[data-field], textarea[data-field]');

                    allInputs.forEach(input => {
                        const dayIndex = input.dataset.dayIndex;
                        const field = input.dataset.field;
                        if (dayIndex !== undefined && field) {
                            if (!weekData.days[dayIndex]) weekData.days[dayIndex] = {};
                            weekData.days[dayIndex][field] = input.value;
                        }
                    });
                    student.data.weeks.push(weekData);
                });
            }
        }

        calculateAllTotals() {
            if (!this.currentHalaqa || !this.currentHalaqa.students) return;
            this.currentHalaqa.students.forEach(student => this.captureStudentData(student.id));

            let halaqaTotalMemorization = 0, halaqaTotalReview = 0, halaqaTotalAttendance = 0, halaqaTotalAbsence = 0;

            this.currentHalaqa.students.forEach(student => {
                let studentTotalMemorization = 0, studentTotalReview = 0, studentTotalAttendance = 0, studentTotalAbsence = 0;
                const studentContent = document.getElementById(`content_${student.id}`);
                
                (student.data.weeks || []).forEach((week, weekIndex) => {
                    let weeklyMemorization = 0, weeklyReview = 0;
                    (week.days || []).forEach(day => {
                        weeklyMemorization += Number(day.hifdhFaces) || 0;
                        weeklyReview += Number(day.murajaaFaces) || 0;
                        if (day.attendance === 'حضر') studentTotalAttendance++;
                        else if (day.attendance === 'غاب') studentTotalAbsence++;
                    });

                    if (studentContent) {
                        const weekTable = studentContent.querySelectorAll('.week-table')[weekIndex];
                        if (weekTable) {
                            weekTable.querySelectorAll('.weekly-memorization').forEach(el => el.textContent = weeklyMemorization);
                            weekTable.querySelectorAll('.weekly-review').forEach(el => el.textContent = weeklyReview);
                        }
                    }
                    studentTotalMemorization += weeklyMemorization;
                    studentTotalReview += weeklyReview;
                });

                if (studentContent) {
                    const summaryDiv = studentContent.querySelector(`#summary_${student.id}`);
                    if(summaryDiv){
                        summaryDiv.querySelector('.total-memorization').textContent = studentTotalMemorization;
                        summaryDiv.querySelector('.total-review').textContent = studentTotalReview;
                        summaryDiv.querySelector('.total-attendance').textContent = studentTotalAttendance;
                        summaryDiv.querySelector('.total-absence').textContent = studentTotalAbsence;
                    }
                }
                
                halaqaTotalMemorization += studentTotalMemorization;
                halaqaTotalReview += studentTotalReview;
                halaqaTotalAttendance += studentTotalAttendance;
                halaqaTotalAbsence += studentTotalAbsence;
            });
            
            const halaqaSummaryDiv = document.getElementById('halaqaSummary');
            halaqaSummaryDiv.querySelector('#halaqaTotalMemorization').textContent = halaqaTotalMemorization;
            halaqaSummaryDiv.querySelector('#halaqaTotalReview').textContent = halaqaTotalReview;
            halaqaSummaryDiv.querySelector('#halaqaTotalAttendance').textContent = halaqaTotalAttendance;
            halaqaSummaryDiv.querySelector('#halaqaTotalAbsence').textContent = halaqaTotalAbsence;
            halaqaSummaryDiv.classList.remove('hidden');
            this.showMessage("تم حساب جميع المجاميع بنجاح!", "success");
        }
        
        exportHalaqaToCSV() {
            if (!this.currentHalaqa) return this.showMessage('لا توجد حلقة لتصديرها', 'warning');

            const headers = ['اسم الطالب', 'المرحلة الدراسية', 'السجل المدني', 'الأسبوع', 'اليوم', 'التاريخ', 'الحضور', 'سورة الحفظ', 'الحفظ من', 'الحفظ إلى', 'تقدير الحفظ', 'أوجه الحفظ', 'سورة المراجعة', 'المراجعة من', 'المراجعة إلى', 'تقدير المراجعة', 'أوجه المراجعة', 'ملاحظات اليوم'];
            let csvContent = "\uFEFF"; // BOM for Arabic Excel
            csvContent += headers.join(',') + '\r\n';

            (this.currentHalaqa.students || []).forEach(student => {
                (student.data.weeks || []).forEach((week, weekIndex) => {
                    const daysOfWeek = ['الأحد', 'الاثنين', 'الثلاثاء', 'الأربعاء'];
                    (week.days || []).forEach((day, dayIndex) => {
                        const row = [
                            `"${student.name}"`, `"${student.grade}"`, `"${student.civilId}"`,
                            weekIndex + 1, daysOfWeek[dayIndex], `"${day.date || ''}"`, `"${day.attendance || ''}"`,
                            `"${day.hifdhSurah || ''}"`, `"${day.hifdhFrom || ''}"`, `"${day.hifdhTo || ''}"`, `"${day.hifdhGrade || ''}"`, `"${day.hifdhFaces || '0'}"`,
                            `"${day.murajaaSurah || ''}"`, `"${day.murajaaFrom || ''}"`, `"${day.murajaaTo || ''}"`, `"${day.murajaaGrade || ''}"`, `"${day.murajaaFaces || '0'}"`,
                            `"${(day.notes || '').replace(/"/g, '""')}"`
                        ].join(',');
                        csvContent += row + '\r\n';
                    });
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${this.currentHalaqa.circleName || 'halaqa'}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        generatePrintableReport() {
            this.captureAndSaveHalaqa();
            const halaqa = this.currentHalaqa;
            if (!halaqa) return;

            let reportHTML = `
                <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>تقرير حلقة ${halaqa.circleName}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
                    body { font-family: 'Amiri', serif; margin: 20px; }
                    .student-card { page-break-inside: avoid; margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 0.5rem;}
                    table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    thead { background-color: #f2f2f2; }
                    .notes-section { margin-top: 1rem; padding: 0.5rem; border-top: 2px solid #eee; }
                </style></head><body>
                    <h1 class="text-3xl font-bold text-center mb-2">تقرير حلقة: ${halaqa.circleName}</h1>
                    <h2 class="text-xl text-center mb-6">المعلم: ${halaqa.teacherName} | الشهر: ${halaqa.month}</h2>`;

            (halaqa.students || []).forEach(student => {
                reportHTML += `<div class="student-card"><h3 class="text-2xl font-bold mb-4">الطالب: ${student.name}</h3>`;
                (student.data.weeks || []).forEach((week, index) => {
                    reportHTML += this.createWeekTableWithData(student.id, week, index + 1);
                });
                reportHTML += `</div>`;
            });
            reportHTML += `</body></html>`;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            reportWindow.onload = () => reportWindow.print();
        }

        printHalaqaSummary() {
            this.captureAndSaveHalaqa();
            const halaqa = this.currentHalaqa;
            const summaryNode = document.getElementById('halaqaSummary');
            if (!halaqa || !summaryNode) return;

            const summaryContent = summaryNode.cloneNode(true);
            const btnInClone = summaryContent.querySelector('#printSummaryBtn');
            if (btnInClone) btnInClone.parentElement.replaceWith(summaryContent.querySelector('h3'));
            
            let reportHTML = `
                <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ملخص إنجازات حلقة ${halaqa.circleName}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
                    body { font-family: 'Amiri', serif; margin: 20px; }
                    .summary-container { margin-top: 2rem; padding: 1.5rem; background-color: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.5rem; }
                </style></head><body>
                <div class="container mx-auto max-w-4xl">
                    <div class="text-center">
                        <h1 class="text-3xl font-bold mb-2">ملخص إنجازات حلقة: ${halaqa.circleName}</h1>
                        <h2 class="text-xl mb-6">المعلم: ${halaqa.teacherName} | الشهر: ${halaqa.month || 'غير محدد'}</h2>
                    </div>
                    <div class="summary-container">${summaryContent.innerHTML}</div>
                </div></body></html>`;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            reportWindow.onload = () => reportWindow.print();
        }

        showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('saveStatus');
            statusDiv.textContent = message;
            const colors = {
                success: 'bg-green-100 border-green-300 text-green-800',
                warning: 'bg-yellow-100 border-yellow-300 text-yellow-800',
                info: 'bg-blue-100 border-blue-300 text-blue-800',
                error: 'bg-red-100 border-red-300 text-red-800'
            };
            statusDiv.className = `p-3 rounded-lg border text-center font-bold ${colors[type]}`;
            clearTimeout(this.messageTimeout);
            this.messageTimeout = setTimeout(() => { statusDiv.className = 'hidden'; }, 3000);
        }
    }

    const app = new AppManager();
    
    // Bind events for elements that exist on page load
    document.getElementById('selectMenBtn').addEventListener('click', () => app.selectSection('men'));
    document.getElementById('selectWomenBtn').addEventListener('click', () => app.selectSection('women'));
    document.getElementById('backToSectionsBtn').addEventListener('click', () => {
        window.location.hash = '';
        app.showView('selectionView')
    });
    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
        window.location.hash = '';
        app.showView('dashboardView')
    });
    document.getElementById('backToDashboardFromAnalyticsBtn').addEventListener('click', () => app.showView('dashboardView'));
    
    document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
        const linkInput = document.getElementById('shareLinkInput');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        try {
            document.execCommand('copy');
            app.halaqaManager.showMessage('تم نسخ الرابط بنجاح!', 'success');
        } catch (err) {
            app.halaqaManager.showMessage('فشل نسخ الرابط. يرجى النسخ يدوياً.', 'error');
        }
    });

    document.getElementById('closeShareModalBtn').addEventListener('click', () => {
        document.getElementById('shareModal').classList.add('hidden');
    });
     document.getElementById('closeEditModalBtn').addEventListener('click', () => {
        document.getElementById('editModal').classList.add('hidden');
    });

    document.getElementById('printAnalyticsBtn').addEventListener('click', () => app.printAnalytics());
    document.getElementById('exportAnalyticsBtn').addEventListener('click', () => app.exportAnalyticsToWord());

    // Use event delegation for dynamically created elements in the dashboard
    document.getElementById('dashboardView').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        const halaqaId = target.dataset.halaqaId;
        const darId = target.dataset.darId;
        
        if (target.id === 'showAnalyticsBtn') {
            app.showAnalytics();
            return;
        }

        if (target.id === 'generateReportBtn') {
            app.generateSectionReport();
            return;
        }

        // --- Men's Section Actions ---
        if (app.currentSection === 'men') {
            if (target.id === 'addNewHalaqaBtn') {
                app.addNewHalaqaToMen();
            } else if (halaqaId) {
                if (target.classList.contains('open-halaqa-btn')) app.openHalaqa(halaqaId);
                else if (target.classList.contains('delete-halaqa-btn')) app.deleteHalaqaFromMen(halaqaId);
                else if (target.classList.contains('share-halaqa-btn')) app.shareHalaqa(halaqaId);
                else if (target.classList.contains('edit-halaqa-btn')) app.editHalaqa(null, halaqaId);
            }
        }
        // --- Women's Section Actions ---
        else if (app.currentSection === 'women') {
            if (target.id === 'addNewDarBtn') {
                app.addNewDar();
            } else if (target.classList.contains('add-halaqa-to-dar-btn')) {
                app.addNewHalaqaToDar(darId);
            } else if (target.classList.contains('delete-dar-btn')) {
                app.deleteDar(darId);
            } else if (halaqaId && darId) {
                if (target.classList.contains('open-halaqa-btn')) app.openHalaqa(halaqaId);
                else if (target.classList.contains('delete-halaqa-btn')) app.deleteHalaqaFromDar(darId, halaqaId); 
                else if (target.classList.contains('share-halaqa-btn')) app.shareHalaqa(halaqaId);
                else if (target.classList.contains('edit-halaqa-btn')) app.editHalaqa(darId, halaqaId);
            }
        }
    });


    </script>
</body>
</html>

