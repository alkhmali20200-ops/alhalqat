<script>
window.__firebase_config = JSON.stringify({
  apiKey: "AIzaSyAsQQ9GGfZ0DmS4V5Fqv49rypXDEeoxCaA",
  authDomain: "alhalqat-6ac9d.firebaseapp.com", // يجب أن يأخذ القيمة الصحيحة لمشروعك فقط
  projectId: "alhalqat-6ac9d",
  storageBucket: "alhalqat-6ac9d.appspot.com",
  messagingSenderId: "رقم المرسل تجده في إعدادات المشروع Firebase Console",
  appId: "معرّف التطبيق الصحيح لمشروعك من إعدادات Firebase Console"
});
window.__app_id = "alhalqat-6ac9d";
</script>

<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة حلقات القرآن الكريم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        
        body {
            font-family: 'Amiri', serif;
        }
        
        .print-page { page-break-after: always; }
        
        @media print {
            body, .container {
                margin: 0;
                padding: 0;
                box-shadow: none;
                border: none;
                font-size: 10px;
            }
            .no-print { display: none !important; }
            .view { display: none !important; }
            #analyticsView {
                display: block !important;
            }
        }
        
        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Amiri', serif;
            background-color: transparent;
        }
        
        .student-tab { transition: all 0.3s ease; cursor: pointer; }
        .student-tab.active { background-color: #3b82f6; color: white; }
        .student-tab:hover { background-color: #e5e7eb; }
        .student-tab.active:hover { background-color: #2563eb; }
        
        .student-content, .view { display: none; }
        .view.active { display: block; }
        .student-content.active { display: block; }

        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.1); background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-50 p-4">

    <!-- App Container -->
    <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-6">

        <!-- View 1: Section Selection -->
        <div id="selectionView" class="view active text-center py-16">
            <h1 class="text-3xl font-bold mb-8 text-gray-700">نظام إدارة حلقات القرآن الكريم</h1>
            <p class="text-lg text-gray-500 mb-12">الرجاء تحديد القسم للبدء</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-8">
                <button id="selectMenBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    قسم الرجال
                </button>
                <button id="selectWomenBtn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    قسم النساء
                </button>
            </div>
             <p id="firebase-status" class="mt-8 text-gray-400 text-sm">جاري تهيئة التطبيق...</p>
        </div>

        <!-- View 2: Halaqa Dashboard -->
        <div id="dashboardView" class="view">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h1 id="dashboardTitle" class="text-3xl font-bold text-gray-700"></h1>
                <button id="backToSectionsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    العودة للأقسام
                </button>
            </div>
            
            <div id="formContainer" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <!-- Form content is managed dynamically -->
            </div>
            <hr class="my-8">

            <div>
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                     <h2 id="listTitle" class="text-xl font-bold"></h2>
                     <div class="flex gap-2">
                        <button id="showAnalyticsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">
                            📊 عرض الإحصائيات
                        </button>
                         <button id="generateReportBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">
                            📈 إنشاء تقرير أسبوعي للقسم
                         </button>
                     </div>
                </div>
                <div id="listContainer">
                    <!-- Content managed dynamically -->
                </div>
            </div>
        </div>

        <!-- View 3: Halaqa Management -->
        <div id="halaqaView" class="view">
            <div class="flex justify-start mb-4 no-print">
                <button id="backToDashboardBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    → العودة للوحة التحكم
                </button>
            </div>

            <div class="border-2 border-gray-800 p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center gap-2">
                        <span class="font-bold">المعلم /</span>
                        <input type="text" id="teacherName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="اسم المعلم">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">اسم الحلقة /</span>
                        <input type="text" id="circleName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="اسم الحلقة">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">الشهر /</span>
                        <select id="month" class="border-b border-gray-400 bg-transparent">
                           <option value="">اختر الشهر</option><option value="محرم">محرم</option><option value="صفر">صفر</option><option value="ربيع الأول">ربيع الأول</option><option value="ربيع الثاني">ربيع الثاني</option><option value="جمادى الأولى">جمادى الأولى</option><option value="جمادى الثانية">جمادى الثانية</option><option value="رجب">رجب</option><option value="شعبان">شعبان</option><option value="رمضان">رمضان</option><option value="شوال">شوال</option><option value="ذو القعدة">ذو القعدة</option><option value="ذو الحجة">ذو الحجة</option>
                        </select>
                    </div>
                </div>
                <div class="text-center"><span id="currentHijriYear" class="font-bold text-lg"></span></div>
            </div>

            <div class="mb-6 no-print">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-3">إدارة الطلاب</h3>
                    <div class="flex gap-4 items-center flex-wrap">
                        <input type="text" id="newStudentName" placeholder="اسم الطالب الجديد" class="flex-grow">
                        <input type="text" id="newStudentGrade" placeholder="المرحلة الدراسية" class="flex-grow">
                        <input type="text" id="newStudentCivilId" placeholder="السجل المدني" class="flex-grow">
                        <button id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">➕ إضافة طالب</button>
                    </div>
                </div>
            </div>

            <div id="studentsTabsContainer" class="mb-6 no-print">
                <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-300 pb-2" id="studentsTabs"></div>
            </div>

            <div id="studentsContentContainer"></div>

            <div class="flex gap-4 mb-6 no-print flex-wrap">
                <button id="addWeekBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">إضافة أسبوع للطالب الحالي</button>
                <button id="calculateBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold">حساب المجاميع</button>
                <button id="printBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold">📄 إنشاء تقرير (PDF/طباعة)</button>
                <button id="exportBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-bold">📄 تصدير لإكسل</button>
            </div>
            
            <div id="saveStatus" class="mb-4 p-3 rounded-lg hidden"></div>
            
            <div id="halaqaSummary" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg no-print hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-800">ملخص إنجازات الحلقة</h3>
                    <button id="printSummaryBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1 rounded-lg font-bold">🖨️ طباعة الملخص</button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-green-600" id="halaqaTotalMemorization">0</p>
                        <p class="text-sm text-gray-600">إجمالي أوجه الحفظ</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-indigo-600" id="halaqaTotalReview">0</p>
                        <p class="text-sm text-gray-600">إجمالي أوجه المراجعة</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-teal-600" id="halaqaTotalAttendance">0</p>
                        <p class="text-sm text-gray-600">إجمالي أيام الحضور</p>
                    </div>
                     <div>
                        <p class="text-2xl font-bold text-red-600" id="halaqaTotalAbsence">0</p>
                        <p class="text-sm text-gray-600">إجمالي أيام الغياب</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- View 4: Analytics View -->
        <div id="analyticsView" class="view">
             <div class="flex flex-wrap justify-between items-center mb-6 gap-4 no-print">
                <h1 id="analyticsTitle" class="text-3xl font-bold text-gray-700"></h1>
                <div class="flex gap-2">
                     <button id="printAnalyticsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">🖨️ طباعة</button>
                     <button id="exportAnalyticsBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">📄 تصدير (وورد)</button>
                     <button id="backToDashboardFromAnalyticsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">→ العودة</button>
                </div>
            </div>
            <div id="analyticsContent" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
                <canvas id="halaqaChart"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden no-print">
        <div class="bg-white rounded-lg p-6 w-full max-w-md text-center shadow-2xl">
            <h3 class="text-xl font-bold mb-4">مشاركة رابط الحلقة</h3>
            <p class="text-gray-600 mb-4">انسخ هذا الرابط وأرسله للمعلم/ة. سيتمكن من الدخول مباشرة إلى الحلقة.</p>
            <input type="text" id="shareLinkInput" readonly class="w-full p-2 border rounded-md text-center bg-gray-100 mb-4 font-mono">
            <div class="flex gap-4 justify-center">
                <button id="copyShareLinkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">نسخ الرابط</button>
                <button id="closeShareModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إغلاق</button>
            </div>
        </div>
    </div>
    <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden no-print">
        <div class="bg-white rounded-lg p-6 w-full max-w-md text-center shadow-2xl">
            <h3 class="text-xl font-bold mb-4">تعديل بيانات الحلقة</h3>
            <div class="space-y-4 text-right">
                <div>
                    <label for="editHalaqaName" class="block text-sm font-medium text-gray-700 mb-1">اسم الحلقة الجديد</label>
                    <input type="text" id="editHalaqaName" class="w-full p-2 border rounded-md">
                </div>
                <div>
                    <label for="editTeacherName" class="block text-sm font-medium text-gray-700 mb-1">اسم المعلم/ة الجديد</label>
                    <input type="text" id="editTeacherName" class="w-full p-2 border rounded-md">
                </div>
            </div>
            <div class="flex gap-4 justify-center mt-6">
                <button id="saveEditBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">حفظ التعديلات</button>
                <button id="closeEditModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">إلغاء</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    class AppManager {
        constructor() {
            this.appData = { men: [], women: [] };
            this.currentSection = null;
            this.currentHalaqaId = null;
            this.halaqaManager = new HalaqaManager(this);
            this.db = null;
            this.unsubscribe = null;
            this.initialLinkHandled = false;
            this.appId = null;
            this.initFirebase();
        }

        async initFirebase() {
            if (typeof __firebase_config === 'undefined') {
                document.getElementById('firebase-status').textContent = 'وضع المعاينة (الاتصال بقاعدة البيانات معطل)';
                console.log("Running in preview mode. Firebase disabled.");
                this.handleDirectLinkAfterDataLoad();
                return;
            }

            try {
                const firebaseConfig = JSON.parse(__firebase_config);
                this.appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;

                const app = initializeApp(firebaseConfig);
                this.db = getFirestore(app);
                const auth = getAuth(app);

                if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }

                document.getElementById('firebase-status').textContent = 'متصل بقاعدة البيانات ✅';
                this.listenForDataChanges(this.appId);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('firebase-status').textContent = `فشل الاتصال: ${error.message}`;
                this.handleDirectLinkAfterDataLoad();
            }
        }

        listenForDataChanges(appId) {
            if (!this.db) {
                if (!this.initialLinkHandled) this.handleDirectLinkAfterDataLoad();
                return;
            }
            const docRef = doc(this.db, "artifacts", appId, "public", "data");
            this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    this.appData = { men: data.men || [], women: data.women || [] };
                } else {
                    this.appData = { men: [], women: [] };
                    this.saveData();
                }

                if (!this.initialLinkHandled) {
                    this.handleDirectLinkAfterDataLoad();
                }

                if (this.currentSection && document.getElementById('dashboardView').classList.contains('active')) {
                    this.renderDashboard();
                }
            }, (error) => {
                console.error("Error listening to data:", error);
                this.halaqaManager.showMessage('حدث خطأ في المزامنة مع قاعدة البيانات', 'error');
            });
        }

        handleDirectLinkAfterDataLoad() {
            this.initialLinkHandled = true;

            const hash = window.location.hash;
            if (hash && hash.startsWith('#halaqa_id=')) {
                const halaqaId = hash.substring('#halaqa_id='.length);
                const section = halaqaId.startsWith('men') ? 'men' : halaqaId.startsWith('women') ? 'women' : null;
                if (section) {
                    this.currentSection = section;
                    this.openHalaqa(halaqaId);
                } else {
                    this.showView('selectionView');
                }
            } else {
                this.showView('selectionView');
            }
        }

        async saveData() {
            if (!this.db || !this.appId) return;
            const docRef = doc(this.db, "artifacts", this.appId, "public", "data");
            try {
                await setDoc(docRef, this.appData);
            } catch (error) {
                console.error("CRITICAL SAVE ERROR:", error);
                this.halaqaManager.showMessage('فشل الحفظ: صلاحيات الوصول مرفوضة. الرجاء التأكد من تطبيق قواعد الأمان في Firebase بشكل صحيح.', 'error');
                throw error;
            }
        }

        showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const viewToShow = document.getElementById(viewId);
            if(viewToShow) {
                viewToShow.classList.add('active');
                if (viewId === 'dashboardView') this.renderDashboard();
            } else {
                document.getElementById('selectionView').classList.add('active');
            }
        }

        selectSection(section) {
            this.currentSection = section;
            document.getElementById('dashboardTitle').textContent = `لوحة تحكم ${section === 'men' ? 'قسم الرجال' : 'قسم النساء'}`;
            this.showView('dashboardView');
        }

        renderDashboard() {
            const listContainer = document.getElementById('listContainer');
            const formContainer = document.getElementById('formContainer');
            const listTitle = document.getElementById('listTitle');
            listContainer.innerHTML = '';

            if (this.currentSection === 'men') {
                listTitle.textContent = 'الحلقات المسجلة';
                formContainer.innerHTML = `
                    <h2 class="text-xl font-bold mb-4">إضافة حلقة جديدة</h2>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-grow"><label for="newHalaqaName" class="block text-sm font-medium text-gray-700">اسم الحلقة</label><input type="text" id="newHalaqaName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: حلقة المبتدئين"></div>
                        <div class="flex-grow"><label for="newTeacherName" class="block text-sm font-medium text-gray-700">اسم المعلم/ة</label><input type="text" id="newTeacherName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="اسم المعلم/ة المسؤول/ة"></div>
                        <button id="addNewHalaqaBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة</button>
                    </div>`;
                
                listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                const halaqas = this.appData.men || [];
                if (halaqas.length === 0) {
                    listContainer.innerHTML = `<p class="text-gray-500 col-span-full">لا توجد حلقات مسجلة في هذا القسم بعد.</p>`;
                } else {
                    halaqas.forEach(halaqa => {
                        const card = document.createElement('div');
                        card.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-200';
                        card.innerHTML = `
                            <h3 class="text-lg font-bold text-blue-800">${halaqa.circleName}</h3>
                            <p class="text-gray-600 mb-4">${halaqa.teacherName}</p>
                            <div class="flex gap-2 mt-4 flex-wrap">
                               <button data-halaqa-id="${halaqa.id}" class="open-halaqa-btn flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">فتح</button>
                               <button data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">تعديل</button>
                               <button data-halaqa-id="${halaqa.id}" class="share-halaqa-btn flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">مشاركة</button>
                               <button data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">حذف</button>
                            </div>`;
                        listContainer.appendChild(card);
                    });
                }
            } else if (this.currentSection === 'women') {
                listTitle.textContent = 'الدور المسجلة';
                formContainer.innerHTML = `
                    <h2 class="text-xl font-bold mb-4">إضافة دار جديدة</h2>
                    <div class="flex flex-wrap gap-4 items-end">
                        <div class="flex-grow"><label for="newDarName" class="block text-sm font-medium text-gray-700">اسم الدار</label><input type="text" id="newDarName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: دار الهدى النسائية"></div>
                        <button id="addNewDarBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة دار</button>
                    </div>`;
                listContainer.className = 'space-y-6';
                const dars = this.appData.women || [];
                if (dars.length === 0) {
                    listContainer.innerHTML = `<p class="text-gray-500">لا توجد دور مسجلة في هذا القسم بعد.</p>`;
                } else {
                    dars.forEach(dar => {
                        const darContainer = document.createElement('div');
                        darContainer.className = 'bg-white p-6 rounded-lg shadow-lg border border-pink-200';
                        
                        let halaqaCardsHTML = (dar.halaqas || []).map(halaqa => `
                            <div class="bg-gray-50 p-4 rounded-md border flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                                <div>
                                    <h4 class="font-bold text-gray-800">${halaqa.circleName}</h4>
                                    <p class="text-sm text-gray-500">${halaqa.teacherName}</p>
                                </div>
                                <div class="flex gap-2 flex-shrink-0 flex-wrap">
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="open-halaqa-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm">فتح</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md text-sm">تعديل</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="share-halaqa-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-md text-sm">مشاركة</button>
                                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm">حذف</button>
                                </div>
                            </div>
                        `).join('');
                        
                        darContainer.innerHTML = `
                            <div class="flex justify-between items-center mb-4">
                                <h3 class="text-2xl font-bold text-pink-700">${dar.name}</h3>
                                <button data-dar-id="${dar.id}" class="delete-dar-btn bg-red-100 text-red-700 hover:bg-red-200 font-bold py-1 px-3 rounded-md">حذف الدار</button>
                            </div>
                            <div class="space-y-3 mb-6">${halaqaCardsHTML || '<p class="text-gray-500">لا توجد حلقات في هذه الدار بعد.</p>'}</div>
                            <div class="bg-pink-50 p-4 rounded-lg border border-pink-200 mt-4">
                                <h4 class="font-bold mb-3">إضافة حلقة جديدة لهذه الدار</h4>
                                <div class="flex flex-wrap gap-4 items-end">
                                    <div class="flex-grow"><label for="newHalaqaName_${dar.id}" class="block text-sm font-medium text-gray-700">اسم الحلقة</label><input type="text" id="newHalaqaName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="مثال: حلقة المتقدمات"></div>
                                    <div class="flex-grow"><label for="newTeacherName_${dar.id}" class="block text-sm font-medium text-gray-700">اسم المعلمة</label><input type="text" id="newTeacherName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="اسم المعلمة المسؤولة"></div>
                                    <button data-dar-id="${dar.id}" class="add-halaqa-to-dar-btn bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-6 rounded-lg">➕ إضافة حلقة</button>
                                </div>
                            </div>`;
                        listContainer.appendChild(darContainer);
                    });
                }
            }
        }

        shareHalaqa(halaqaId) {
            try {
                const baseUrl = window.location.href.split('#')[0];
                const shareableLink = `${baseUrl}#halaqa_id=${halaqaId}`;
                document.getElementById('shareLinkInput').value = shareableLink;
                document.getElementById('shareModal').classList.remove('hidden');
            } catch (e) {
                console.error("Error creating share link:", e);
                this.halaqaManager.showMessage('فشل إنشاء رابط المشاركة.', 'error');
            }
        }

        // ... بقية وظائف إدارة الحلقات، إضافة وحذف الطلاب، تعديل البيانات، تقرير، إلخ ...

        addNewHalaqaToMen() {
            // وظيفة إضافة حلقة جديدة في قسم الرجال
        }

        deleteHalaqaFromMen(halaqaId) {
            // وظيفة حذف حلقة من قسم الرجال
        }

        addNewDar() {
            // وظيفة إضافة دار جديدة في قسم النساء
        }

        deleteDar(darId) {
            // وظيفة حذف الدار من قسم النساء
        }

        addNewHalaqaToDar(darId) {
            // وظيفة إضافة حلقة داخل دار نسائية
        }

        deleteHalaqaFromDar(darId, halaqaId) {
            // وظيفة حذف حلقة من دار نسائية
        }

        editHalaqa(darId, halaqaId) {
            // تعديل بيانات حلقة
        }

        openHalaqa(halaqaId) {
            // فتح حلقة للعرض والتعديل
        }

        async updateCurrentHalaqa(halaqaData) {
            // تحديث بيانات الحلقة وحفظها في قاعدة البيانات Firebase
        }

        showAnalytics() {
            // عرض إحصائيات أداء الحلقات
        }

        printAnalytics() {
            window.print();
        }

        exportAnalyticsToWord() {
            // تصدير إحصائيات القسم إلى ملف وورد
        }

        generateSectionReport() {
            // إنشاء تقرير أسبوعي شامل للقسم
        }
    }

    class HalaqaManager {
        constructor(appManager) {
            // إدارة تفاصيل الحلقة، الطلاب، الجداول، التقارير
        }

        initializeEventListeners() {
            // ربط الأزرار وأحداث الإدخال
        }

        addStudent() {
            // إضافة طالب جديد للحلقة
        }

        removeStudent(studentId) {
            // حذف طالب من الحلقة
        }

        switchToStudent(studentId) {
            // التبديل بين طلاب الحلقة
        }

        addWeekToCurrentStudent() {
            // إضافة أسبوع جديد لبيانات الطالب
        }

        captureAndSaveHalaqa() {
            // التقاط بيانات الحلقة من الواجهة وحفظها
        }

        calculateAllTotals() {
            // حساب المجاميع الكلية للحفظ والمراجعة والحضور والغياب
        }

        exportHalaqaToCSV() {
            // تصدير بيانات الحلقة إلى ملف Excel CSV
        }

        generatePrintableReport() {
            // إنشاء تقرير PDF أو طباعة بيانات الحلقة
        }

        printHalaqaSummary() {
            // طباعة ملخص إنجازات الحلقة
        }

        showMessage(message, type='info') {
            // عرض رسالة حالة (نجاح، تحذير، خطأ)
        }

        // والعديد من الوظائف المساعدة الأخرى
    }

    const app = new AppManager();

    // ربط أزرار الواجهة الرئيسية بأحداثها
    document.getElementById('selectMenBtn').addEventListener('click', () => app.selectSection('men'));
    document.getElementById('selectWomenBtn').addEventListener('click', () => app.selectSection('women'));
    document.getElementById('backToSectionsBtn').addEventListener('click', () => {
        window.location.hash = '';
        app.showView('selectionView');
    });
    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
        window.location.hash = '';
        app.showView('dashboardView');
    });
    document.getElementById('backToDashboardFromAnalyticsBtn').addEventListener('click', () => app.showView('dashboardView'));

    // نسخ رابط المشاركة
    document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
        const linkInput = document.getElementById('shareLinkInput');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        try {
            document.execCommand('copy');
            app.halaqaManager.showMessage('تم نسخ الرابط بنجاح!', 'success');
        } catch (err) {
            app.halaqaManager.showMessage('فشل نسخ الرابط. يرجى النسخ يدوياً.', 'error');
        }
    });

    document.getElementById('closeShareModalBtn').addEventListener('click', () => {
        document.getElementById('shareModal').classList.add('hidden');
    });
    document.getElementById('closeEditModalBtn').addEventListener('click', () => {
        document.getElementById('editModal').classList.add('hidden');
    });

    // التعامل مع أزرار الحلقات والدور في لوحة التحكم باستخدام التفويض
    document.getElementById('dashboardView').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        const halaqaId = target.dataset.halaqaId;
        const darId = target.dataset.darId;

        if (target.id === 'showAnalyticsBtn') {
            app.showAnalytics();
            return;
        }

        if (target.id === 'generateReportBtn') {
            app.generateSectionReport();
            return;
        }

        if (app.currentSection === 'men') {
            if (target.id === 'addNewHalaqaBtn') {
                app.addNewHalaqaToMen();
            } else if (halaqaId) {
                if (target.classList.contains('open-halaqa-btn')) app.openHalaqa(halaqaId);
                else if (target.classList.contains('delete-halaqa-btn')) app.deleteHalaqaFromMen(halaqaId);
                else if (target.classList.contains('share-halaqa-btn')) app.shareHalaqa(halaqaId);
                else if (target.classList.contains('edit-halaqa-btn')) app.editHalaqa(null, halaqaId);
            }
        } else if (app.currentSection === 'women') {
            if (target.id === 'addNewDarBtn') {
                app.addNewDar();
            } else if (target.classList.contains('add-halaqa-to-dar-btn')) {
                app.addNewHalaqaToDar(darId);
            } else if (target.classList.contains('delete-dar-btn')) {
                app.deleteDar(darId);
            } else if (halaqaId && darId) {
                if (target.classList.contains('open-halaqa-btn')) app.openHalaqa(halaqaId);
                else if (target.classList.contains('delete-halaqa-btn')) app.deleteHalaqaFromDar(darId, halaqaId);
                else if (target.classList.contains('share-halaqa-btn')) app.shareHalaqa(halaqaId);
                else if (target.classList.contains('edit-halaqa-btn')) app.editHalaqa(darId, halaqaId);
            }
        }
    });
    </script>
</body>
</html>
