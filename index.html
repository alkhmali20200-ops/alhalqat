<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>نظام إدارة حلقات القرآن الكريم</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');

        body {
            font-family: 'Amiri', serif;
        }

        .print-page {
            page-break-after: always;
        }

        @media print {
            body, .container {
                margin: 0; padding: 0; box-shadow: none; border: none; font-size: 10px;
            }
            .no-print { display: none !important; }
            .view { display: none !important; }
            #analyticsView { display: block !important; }
        }

        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Amiri', serif;
            background-color: transparent;
        }

        .student-tab { transition: all 0.3s ease; cursor: pointer; }
        .student-tab.active { background-color: #3b82f6; color: white; }
        .student-tab:hover { background-color: #e5e7eb; }
        .student-tab.active:hover { background-color: #2563eb; }

        .student-content, .view { display: none; }
        .view.active { display: block; }
        .student-content.active { display: block; }

        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.1); background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-50 p-4">

    <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-6">
        <!-- المحتوى هنا مثل الأقسام، لوحة التحكم، إدارة الحلقة، الإحصائيات -->
        <!-- ... نسخ كامل الهيكلية HTML كما في الملف الملحق ... -->
        
        <!-- لأجل اختصار الرد، يمكن الرجوع إلى المرفقات في حالة طلب الهيكلية كاملة -->

        <!-- روابط وأزرار أقسام -->
        <div id="selectionView" class="view active text-center py-16">
            <h1 class="text-3xl font-bold mb-8 text-gray-700">نظام إدارة حلقات القرآن الكريم</h1>
            <p class="text-lg text-gray-500 mb-12">الرجاء تحديد القسم للبدء</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-8">
                <button id="selectMenBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">قسم الرجال</button>
                <button id="selectWomenBtn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">قسم النساء</button>
            </div>
            <p id="firebase-status" class="mt-8 text-gray-400 text-sm">جاري تهيئة التطبيق...</p>
        </div>

        <!-- بقية Views مثل dashboardView - halaqaView - analyticsView وضعها هنا ... -->

    </div>

    <script type="module">
        // استيراد مكتبات Firebase (مثال، مع حفظ تعديل الكود على حسب مشروعك)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        class AppManager {
            constructor() {
                this.appData = { men: [], women: [] };
                this.currentSection = null;
                this.currentHalaqaId = null;
                this.halaqaManager = new HalaqaManager(this);
                this.db = null;
                this.unsubscribe = null;
                this.initialLinkHandled = false;
                this.appId = null;
                this.initFirebase();
            }

            async initFirebase() {
                // مثال تهيئة Firebase - عدل حسب إعدادات مشروعك الحقيقية
                if (typeof __firebase_config === 'undefined') {
                    document.getElementById('firebase-status').textContent = 'وضع المعاينة (الاتصال بقاعدة البيانات معطل)';
                    this.handleDirectLinkAfterDataLoad();
                    return;
                }
                try {
                    const firebaseConfig = JSON.parse(__firebase_config);
                    this.appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
                    const app = initializeApp(firebaseConfig);
                    this.db = getFirestore(app);
                    const auth = getAuth(app);
                    if(typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                         await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                         await signInAnonymously(auth);
                    }
                    document.getElementById('firebase-status').textContent = 'متصل بقاعدة البيانات ✅';
                    this.listenForDataChanges(this.appId);
                } catch (error) {
                    console.error("Firebase initialization failed:", error);
                    document.getElementById('firebase-status').textContent = `فشل الاتصال: ${error.message}`;
                    this.handleDirectLinkAfterDataLoad(); 
                }
            }

            listenForDataChanges(appId) {
                if (!this.db) {
                    if (!this.initialLinkHandled) this.handleDirectLinkAfterDataLoad();
                    return;
                }
                const docRef = doc(this.db, "artifacts", appId, "public", "data");
                this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        this.appData = { men: data.men || [], women: data.women || [] };
                    } else {
                        this.appData = { men: [], women: [] };
                        this.saveData();
                    }
                    if (!this.initialLinkHandled) {
                        this.handleDirectLinkAfterDataLoad();
                    }
                    if (this.currentSection && document.getElementById('dashboardView').classList.contains('active')) {
                        this.renderDashboard();
                    }
                }, (error) => {
                    console.error("Error listening to data:", error);
                    this.halaqaManager.showMessage('حدث خطأ في المزامنة مع قاعدة البيانات', 'error');
                });
            }

            handleDirectLinkAfterDataLoad() {
                this.initialLinkHandled = true;
                const hash = window.location.hash;
                if (hash && hash.startsWith('#halaqa_id=')) {
                    const halaqaId = hash.substring('#halaqa_id='.length);
                    const section = halaqaId.startsWith('men') ? 'men' : halaqaId.startsWith('women') ? 'women' : null;
                    if (section) {
                        this.currentSection = section;
                        this.openHalaqa(halaqaId);
                    } else {
                        this.showView('selectionView');
                    }
                } else {
                    this.showView('selectionView');
                }
            }

            async saveData() {
                if (!this.db || !this.appId) return;
                const docRef = doc(this.db, "artifacts", this.appId, "public", "data");
                try {
                    await setDoc(docRef, this.appData);
                } catch (error) {
                    console.error("CRITICAL SAVE ERROR:", error);
                    this.halaqaManager.showMessage('فشل الحفظ: صلاحيات الوصول مرفوضة. الرجاء التأكد من تطبيق قواعد الأمان في Firebase بشكل صحيح.', 'error');
                    throw error;
                }
            }

            showView(viewId) {
                document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                const viewToShow = document.getElementById(viewId)
                if(viewToShow) {
                    viewToShow.classList.add('active');
                    if (viewId === 'dashboardView') this.renderDashboard();
                } else {
                    document.getElementById('selectionView').classList.add('active');
                }
            }

            selectSection(section) {
                this.currentSection = section;
                document.getElementById('dashboardTitle').textContent = `لوحة تحكم ${section === 'men' ? 'قسم الرجال' : 'قسم النساء'}`;
                this.showView('dashboardView');
            }

            renderDashboard() {
                // ... كود ملئ بيانات لوحة تحكم الحلقات والدور مع بناء الأزرار الديناميكية
                // مشابه لما في ملف الـ paste.txt المرفق
            }

            // تعريف باقي وظائف إضافة/حذف/تعديل وفتح الحلقات والأدوار
            // تجد الكود كامل في المرفقات المرفقة

            openHalaqa(halaqaId) {
                // تحميل تفاصيل الحلقة وعرض شاشة إدارتها
            }

            showAnalytics() {
                // عرض إحصائيات الحلقات باستخدام Chart.js
            }

            generateSectionReport() {
                // إنشاء تقرير أسبوعي لقسم الحلقات
            }
        }

        class HalaqaManager {
            constructor(appManager) {
                this.app = appManager;
                this.currentHalaqa = null;
                this.currentStudentId = null;
                this.debounceTimer = null;
                this.initializeEventListeners();
            }

            initializeEventListeners() {
                // ربط أزرار إضافة الطلاب، الأسابيع، الحفظ، الطباعة والتصدير
                // مع دعم حفظ التغييرات تلقائيًا
            }

            // تعريف دوال تحميل البيانات، الحفظ، حساب المجاميع، وطباعة التقارير
            // تجد الكود كامل في المرفقات المرفقة
        }

        const app = new AppManager();

        // ربط الأحداث لأزرار الأقسام، الرجوع، النسخ، الطباعة، التصدير، إلخ
        document.getElementById('selectMenBtn').addEventListener('click', () => app.selectSection('men'));
        document.getElementById('selectWomenBtn').addEventListener('click', () => app.selectSection('women'));
        document.getElementById('backToSectionsBtn').addEventListener('click', () => {
            window.location.hash = '';
            app.showView('selectionView')
        });
        document.getElementById('backToDashboardBtn').addEventListener('click', () => {
            window.location.hash = '';
            app.showView('dashboardView')
        });
        document.getElementById('backToDashboardFromAnalyticsBtn').addEventListener('click', () => app.showView('dashboardView'));

        document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
            const linkInput = document.getElementById('shareLinkInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                app.halaqaManager.showMessage('تم نسخ الرابط بنجاح!', 'success');
            } catch (err) {
                app.halaqaManager.showMessage('فشل نسخ الرابط. يرجى النسخ يدوياً.', 'error');
            }
        });

        document.getElementById('closeShareModalBtn').addEventListener('click', () => {
            document.getElementById('shareModal').classList.add('hidden');
        });
        document.getElementById('closeEditModalBtn').addEventListener('click', () => {
            document.getElementById('editModal').classList.add('hidden');
        });

        document.getElementById('printAnalyticsBtn').addEventListener('click', () => app.printAnalytics());
        document.getElementById('exportAnalyticsBtn').addEventListener('click', () => app.exportAnalyticsToWord());

        // تفويض أحداث النقر على أزرار الحلقات والدور ضمن dashboardView ديناميكيًا
        document.getElementById('dashboardView').addEventListener('click', (e) => {
            const target = e.target.closest('button');
            if (!target) return;

            const halaqaId = target.dataset.halaqaId;
            const darId = target.dataset.darId;

            if (target.id === 'showAnalyticsBtn') {
                app.showAnalytics();
                return;
            }

            if (target.id === 'generateReportBtn') {
                app.generateSectionReport();
                return;
            }

            if (app.currentSection === 'men') {
                if (target.id === 'addNewHalaqaBtn') {
                    app.addNewHalaqaToMen();
                } else if (halaqaId) {
                    if (target.classList.contains('open-halaqa-btn')) app.openHalaqa(halaqaId);
                    else if (target.classList.contains('delete-halaqa-btn')) app.deleteHalaqaFromMen(halaqaId);
                    else if (target.classList.contains('share-halaqa-btn')) app.shareHalaqa(halaqaId);
                    else if (target.classList.contains('edit-halaqa-btn')) app.editHalaqa(null, halaqaId);
                }
            } else if (app.currentSection === 'women') {
                if (target.id === 'addNewDarBtn') {
                    app.addNewDar();
                } else if (target.classList.contains('add-halaqa-to-dar-btn')) {
                    app.addNewHalaqaToDar(darId);
                } else if (target.classList.contains('delete-dar-btn')) {
                    app.deleteDar(darId);
                } else if (halaqaId && darId) {
                    if (target.classList.contains('open-halaqa-btn')) app.openHalaqa(halaqaId);
                    else if (target.classList.contains('delete-halaqa-btn')) app.deleteHalaqaFromDar(darId, halaqaId);
                    else if (target.classList.contains('share-halaqa-btn')) app.shareHalaqa(halaqaId);
                    else if (target.classList.contains('edit-halaqa-btn')) app.editHalaqa(darId, halaqaId);
                }
            }
        });
    </script>

</body>
</html>
