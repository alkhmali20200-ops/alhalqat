<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
        
        body {
            font-family: 'Amiri', serif;
        }
        
        .print-page { page-break-after: always; }
        
        @media print {
            .no-print { display: none; }
            body { font-size: 10px; }
            .container { max-width: none; margin: 0; padding: 5px; }
            .student-card { page-break-inside: avoid; margin-bottom: 20px; }
        }
        
        input, select, textarea {
            border: 1px solid #d1d5db;
            border-radius: 4px;
            padding: 4px 8px;
            font-family: 'Amiri', serif;
            background-color: transparent;
        }
        
        .student-tab { transition: all 0.3s ease; cursor: pointer; }
        .student-tab.active { background-color: #3b82f6; color: white; }
        .student-tab:hover { background-color: #e5e7eb; }
        .student-tab.active:hover { background-color: #2563eb; }
        
        .student-content, .view { display: none; }
        .view.active { display: block; }
        .student-content.active { display: block; }

        .delete-btn { transition: all 0.2s ease; }
        .delete-btn:hover { transform: scale(1.1); background-color: #fee2e2; }
    </style>
</head>
<body class="bg-gray-50 p-4">

    <!-- App Container -->
    <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-6">

        <!-- View 1: Section Selection -->
        <div id="selectionView" class="view active text-center py-16">
            <h1 class="text-3xl font-bold mb-8 text-gray-700">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
            <p class="text-lg text-gray-500 mb-12">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ø¨Ø¯Ø¡</p>
            <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-8">
                <button id="selectMenBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    Ù‚Ø³Ù… Ø§Ù„Ø±Ø¬Ø§Ù„
                </button>
                <button id="selectWomenBtn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">
                    Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡
                </button>
            </div>
             <p id="firebase-status" class="mt-8 text-gray-400 text-sm">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</p>
        </div>

        <!-- View 2: Halaqa Dashboard -->
        <div id="dashboardView" class="view">
            <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
                <h1 id="dashboardTitle" class="text-3xl font-bold text-gray-700"></h1>
                <button id="backToSectionsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ù‚Ø³Ø§Ù…
                </button>
            </div>
            
            <div class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                <h2 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
                <div class="flex flex-wrap gap-4 items-end">
                    <div class="flex-grow">
                        <label for="newHalaqaName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©</label>
                        <input type="text" id="newHalaqaName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†">
                    </div>
                    <div class="flex-grow">
                        <label for="newTeacherName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©</label>
                        <input type="text" id="newTeacherName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„/Ø©">
                    </div>
                    <button id="addNewHalaqaBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">
                        â• Ø¥Ø¶Ø§ÙØ©
                    </button>
                </div>
            </div>

            <hr class="my-8">

            <div>
                <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
                     <h2 class="text-xl font-bold">Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</h2>
                     <button id="generateReportBtn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-4 rounded-lg">
                        ğŸ“ˆ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù„Ù„Ù‚Ø³Ù…
                     </button>
                </div>
                <div id="halaqaList" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Content is now fully managed by JavaScript -->
                </div>
            </div>
        </div>

        <!-- View 3: Halaqa Management -->
        <div id="halaqaView" class="view">
            <!-- Back to Dashboard Button -->
             <div class="flex justify-start mb-4 no-print">
                <button id="backToDashboardBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">
                    â†’ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
                </button>
            </div>

            <!-- Circle Header -->
            <div class="border-2 border-gray-800 p-4 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                    <div class="flex items-center gap-2">
                        <span class="font-bold">Ø§Ù„Ù…Ø¹Ù„Ù… /</span>
                        <input type="text" id="teacherName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© /</span>
                        <input type="text" id="circleName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©">
                    </div>
                    <div class="flex items-center gap-2">
                        <span class="font-bold">Ø§Ù„Ø´Ù‡Ø± /</span>
                        <select id="month" class="border-b border-gray-400 bg-transparent">
                           <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option><option value="Ù…Ø­Ø±Ù…">Ù…Ø­Ø±Ù…</option><option value="ØµÙØ±">ØµÙØ±</option><option value="Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„</option><option value="Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option><option value="Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰</option><option value="Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option><option value="Ø±Ø¬Ø¨">Ø±Ø¬Ø¨</option><option value="Ø´Ø¹Ø¨Ø§Ù†">Ø´Ø¹Ø¨Ø§Ù†</option><option value="Ø±Ù…Ø¶Ø§Ù†">Ø±Ù…Ø¶Ø§Ù†</option><option value="Ø´ÙˆØ§Ù„">Ø´ÙˆØ§Ù„</option><option value="Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©">Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©</option><option value="Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©">Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©</option>
                        </select>
                    </div>
                </div>
                <div class="text-center"><span id="currentHijriYear" class="font-bold text-lg"></span></div>
            </div>

            <!-- Student Management Section -->
            <div class="mb-6 no-print">
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
                    <h3 class="font-bold text-lg mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
                    <div class="flex gap-4 items-center flex-wrap">
                        <input type="text" id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯" class="flex-grow">
                        <input type="text" id="newStudentGrade" placeholder="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©" class="flex-grow">
                        <input type="text" id="newStudentCivilId" placeholder="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ" class="flex-grow">
                        <button id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                    </div>
                </div>
            </div>

            <!-- Students Tabs -->
            <div id="studentsTabsContainer" class="mb-6 no-print">
                <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-300 pb-2" id="studentsTabs"></div>
            </div>

            <!-- Students Content Area -->
            <div id="studentsContentContainer"></div>

            <!-- Action Buttons -->
            <div class="flex gap-4 mb-6 no-print flex-wrap">
                <button id="addWeekBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                <button id="calculateBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹</button>
                <button id="printBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold">ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± (PDF/Ø·Ø¨Ø§Ø¹Ø©)</button>
                <button id="exportBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-bold">ğŸ“„ ØªØµØ¯ÙŠØ± Ù„Ø¥ÙƒØ³Ù„</button>
            </div>
             <!-- Save Status -->
            <div id="saveStatus" class="mb-4 p-3 rounded-lg hidden"></div>
            
            <!-- Halaqa Summary -->
            <div id="halaqaSummary" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg no-print hidden">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-blue-800">Ù…Ù„Ø®Øµ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø©</h3>
                    <button id="printSummaryBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1 rounded-lg font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ø®Øµ</button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                    <div>
                        <p class="text-2xl font-bold text-green-600" id="halaqaTotalMemorization">0</p>
                        <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø­ÙØ¸</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-indigo-600" id="halaqaTotalReview">0</p>
                        <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p>
                    </div>
                    <div>
                        <p class="text-2xl font-bold text-teal-600" id="halaqaTotalAttendance">0</p>
                        <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</p>
                    </div>
                     <div>
                        <p class="text-2xl font-bold text-red-600" id="halaqaTotalAbsence">0</p>
                        <p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Share Modal -->
    <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden no-print">
        <div class="bg-white rounded-lg p-6 w-full max-w-md text-center shadow-2xl">
            <h3 class="text-xl font-bold mb-4">Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ù„Ù‚Ø©</h3>
            <p class="text-gray-600 mb-4">Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ù…Ø¹Ù„Ù…/Ø©. Ø³ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù„Ù‚Ø©.</p>
            <input type="text" id="shareLinkInput" readonly class="w-full p-2 border rounded-md text-center bg-gray-100 mb-4 font-mono">
            <div class="flex gap-4 justify-center">
                <button id="copyShareLinkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
                <button id="closeShareModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // ===================================================================================
    // == AppManager: Handles high-level logic (views, sections, halaqa management)
    // ===================================================================================
    class AppManager {
        constructor() {
            this.appData = { men: [], women: [] };
            this.currentSection = null;
            this.currentHalaqaId = null;
            this.halaqaManager = new HalaqaManager(this);
            this.db = null;
            this.unsubscribe = null;
            this.initialLinkHandled = false;
            this.appId = null;
            this.initFirebase();
        }

        async initFirebase() {
            try {
                // =======================================================================
                // == ØªÙ… Ù„ØµÙ‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ Ù‡Ù†Ø§ Ø¨Ù†Ø¬Ø§Ø­ ==
                // =======================================================================
                const firebaseConfig = {
                  apiKey: "AIzaSyAsQQ9GGfZ0DmS4V5Fqv49rypXDEeoxCaA",
                  authDomain: "alhalqat-6ac9d.firebaseapp.com",
                  projectId: "alhalqat-6ac9d",
                  storageBucket: "alhalqat-6ac9d.appspot.com",
                  messagingSenderId: "680568855745",
                  appId: "1:680568855745:web:b8adfa8598dfd6d801c840",
                  measurementId: "G-4L9H2WQS60"
                };
                // =======================================================================
                
                this.appId = firebaseConfig.projectId;
                
                const app = initializeApp(firebaseConfig);
                this.db = getFirestore(app);
                const auth = getAuth(app);
                
                await signInAnonymously(auth);

                document.getElementById('firebase-status').textContent = 'Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…';
                this.listenForDataChanges(this.appId);
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                document.getElementById('firebase-status').textContent = 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âŒ';
                 this.handleDirectLinkAfterDataLoad(); 
            }
        }
        
        listenForDataChanges(appId) {
            if (!this.db) { 
                if (!this.initialLinkHandled) this.handleDirectLinkAfterDataLoad();
                return;
            }
            const docRef = doc(this.db, "artifacts", appId, "public/data");
            this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    this.appData = { men: data.men || [], women: data.women || [] };
                } else {
                    this.appData = { men: [], women: [] };
                }

                if (!this.initialLinkHandled) {
                    this.handleDirectLinkAfterDataLoad();
                }

                if (this.currentSection && document.getElementById('dashboardView').classList.contains('active')) {
                    this.renderDashboard();
                }
            }, (error) => {
                console.error("Error listening to data:", error);
                this.halaqaManager.showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
            });
        }
        
        handleDirectLinkAfterDataLoad() {
            this.initialLinkHandled = true;

            const hash = window.location.hash;
            if (hash && hash.startsWith('#halaqa_id=')) {
                const halaqaId = hash.substring('#halaqa_id='.length);
                const section = halaqaId.startsWith('men') ? 'men' : halaqaId.startsWith('women') ? 'women' : null;

                if (section) {
                    const halaqa = (this.appData[section] || []).find(h => h.id === halaqaId);
                    if (halaqa) {
                        this.currentSection = section; 
                        this.openHalaqa(halaqaId);
                    } else {
                         this.showView('selectionView');
                    }
                } else {
                     this.showView('selectionView');
                }
            } else {
                 this.showView('selectionView');
            }
        }

        async saveData() {
            if (!this.db || !this.appId) return;
            const docRef = doc(this.db, "artifacts", this.appId, "public/data");
            try {
                await setDoc(docRef, this.appData, { merge: true });
            } catch (error) {
                console.error("Error saving data:", error);
                this.halaqaManager.showMessage('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!', 'error');
            }
        }

        showView(viewId) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            const viewToShow = document.getElementById(viewId)
            if(viewToShow) {
                viewToShow.classList.add('active');
                if (viewId === 'dashboardView') this.renderDashboard();
            } else {
                document.getElementById('selectionView').classList.add('active');
            }
        }

        selectSection(section) {
            this.currentSection = section;
            document.getElementById('dashboardTitle').textContent = `Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ${section === 'men' ? 'Ù‚Ø³Ù… Ø§Ù„Ø±Ø¬Ø§Ù„' : 'Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡'}`;
            this.showView('dashboardView');
        }

        renderDashboard() {
            const halaqaList = document.getElementById('halaqaList');
            const halaqas = this.appData[this.currentSection] || [];
            halaqaList.innerHTML = '';
            if (halaqas.length === 0) {
                 halaqaList.innerHTML = `<p class="text-gray-500 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯.</p>`;
            } else {
                 halaqas.forEach(halaqa => {
                    const card = document.createElement('div');
                    card.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-200';
                    card.innerHTML = `
                        <h3 class="text-lg font-bold text-blue-800">${halaqa.circleName}</h3>
                        <p class="text-gray-600 mb-4">${halaqa.teacherName}</p>
                        <div class="flex gap-2 mt-4">
                           <button data-halaqa-id="${halaqa.id}" class="open-halaqa-btn flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">ÙØªØ­</button>
                           <button data-halaqa-id="${halaqa.id}" class="share-halaqa-btn flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                           <button data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">Ø­Ø°Ù</button>
                        </div>`;
                    halaqaList.appendChild(card);
                });
            }
        }
        
        shareHalaqa(halaqaId) {
            try {
                const baseUrl = window.location.href.split('#')[0];
                const shareableLink = `${baseUrl}#halaqa_id=${halaqaId}`;
                
                document.getElementById('shareLinkInput').value = shareableLink;
                document.getElementById('shareModal').classList.remove('hidden');
            } catch (e) {
                console.error("Error creating share link:", e);
                this.halaqaManager.showMessage('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.', 'error');
            }
        }

        addNewHalaqa() {
            const circleName = document.getElementById('newHalaqaName').value.trim();
            const teacherName = document.getElementById('newTeacherName').value.trim();
            if (!circleName || !teacherName) return this.halaqaManager.showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…', 'warning');
            const newHalaqa = {
                id: `${this.currentSection}_${Date.now()}`, circleName, teacherName, month: '', students: [], studentIdCounter: 1
            };
            this.appData[this.currentSection].push(newHalaqa);
            this.saveData();
            document.getElementById('newHalaqaName').value = '';
            document.getElementById('newTeacherName').value = '';
            this.halaqaManager.showMessage('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success');
        }
        
        deleteHalaqa(halaqaId) {
            const halaqaIndex = this.appData[this.currentSection].findIndex(h => h.id === halaqaId);
            if (halaqaIndex > -1) {
                this.appData[this.currentSection].splice(halaqaIndex, 1);
                this.saveData();
                this.halaqaManager.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'warning');
            }
        }

        openHalaqa(halaqaId) {
            this.currentHalaqaId = halaqaId;
            const halaqa = (this.appData[this.currentSection] || []).find(h => h.id === halaqaId);
            if (halaqa) {
                this.halaqaManager.loadHalaqa(halaqa);
                this.showView('halaqaView');
            }
        }

        updateCurrentHalaqa(halaqaData) {
            const halaqaIndex = this.appData[this.currentSection].findIndex(h => h.id === this.currentHalaqaId);
            if (halaqaIndex > -1) {
                this.appData[this.currentSection][halaqaIndex] = halaqaData;
                this.saveData();
            }
        }

        calculateHalaqaTotals(halaqa) {
            let totals = { totalMemorization: 0, totalReview: 0, totalAttendance: 0, totalAbsence: 0 };
            if (!halaqa.students) return totals;
            halaqa.students.forEach(student => {
                (student.data.weeks || []).forEach(week => {
                    (week.days || []).forEach(day => {
                        totals.totalMemorization += Number(day.hifdhFaces) || 0;
                        totals.totalReview += Number(day.murajaaFaces) || 0;
                        if (day.attendance === 'Ø­Ø¶Ø±') totals.totalAttendance++;
                        else if (day.attendance === 'ØºØ§Ø¨') totals.totalAbsence++;
                    });
                });
            });
            return totals;
        }

        generateSectionReport() {
            const sectionHalaqas = this.appData[this.currentSection] || [];
            if (sectionHalaqas.length === 0) {
                return this.halaqaManager.showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±', 'warning');
            }

            const sectionName = this.currentSection === 'men' ? 'Ø§Ù„Ø±Ø¬Ø§Ù„' : 'Ø§Ù„Ù†Ø³Ø§Ø¡';
            const today = this.halaqaManager.getHijriDateString(new Date());

            let reportHTML = `
                <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± Ù‚Ø³Ù… ${sectionName}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
                    body { font-family: 'Amiri', serif; margin: 20px; } table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
                    th, td { border: 1px solid #ddd; padding: 12px; text-align: center; } thead { background-color: #f2f2f2; }
                    .header { text-align: center; margin-bottom: 2rem; }
                </style></head><body>
                    <div class="header">
                        <h1 class="text-3xl font-bold">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù‚Ø³Ù… ${sectionName}</h1>
                        <p class="text-lg text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${today}</p>
                    </div>
                    <table><thead><tr>
                        <th>Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø­ÙØ¸</th>
                        <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨</th>
                    </tr></thead><tbody>`;

            sectionHalaqas.forEach(halaqa => {
                const totals = this.calculateHalaqaTotals(halaqa);
                reportHTML += `
                    <tr>
                        <td>${halaqa.circleName}</td><td>${halaqa.teacherName}</td><td>${(halaqa.students || []).length}</td>
                        <td class="font-bold text-green-600">${totals.totalMemorization}</td><td class="font-bold text-indigo-600">${totals.totalReview}</td>
                        <td class="font-bold text-teal-600">${totals.totalAttendance}</td><td class="font-bold text-red-600">${totals.totalAbsence}</td>
                    </tr>`;
            });

            reportHTML += `</tbody></table></body></html>`;
            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            reportWindow.onload = () => reportWindow.print();
        }
    }

    // ===================================================================================
    // == HalaqaManager: Manages the detailed view of a single halaqa (students, tables)
    // ===================================================================================
    class HalaqaManager {
        constructor(appManager) {
            this.app = appManager;
            this.currentHalaqa = null;
            this.currentStudentId = null;
            this.debounceTimer = null;
            this.initializeEventListeners();
        }

        initializeEventListeners() {
            document.getElementById('addStudentBtn').addEventListener('click', () => this.addStudent());
            document.getElementById('addWeekBtn').addEventListener('click', () => this.addWeekToCurrentStudent());
            document.getElementById('calculateBtn').addEventListener('click', () => this.calculateAllTotals());
            document.getElementById('printBtn').addEventListener('click', () => this.generatePrintableReport());
            document.getElementById('exportBtn').addEventListener('click', () => this.exportHalaqaToCSV());
            document.getElementById('printSummaryBtn').addEventListener('click', () => this.printHalaqaSummary());
            document.getElementById('newStudentName').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') this.addStudent();
            });
            document.getElementById('halaqaView').addEventListener('input', () => {
                this.showMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'info');
                clearTimeout(this.debounceTimer);
                this.debounceTimer = setTimeout(() => {
                    this.captureAndSaveHalaqa();
                    this.showMessage('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
                }, 1500);
            });
        }

        getHijriDateParts() {
            const today = new Date();
            const yearFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { year: 'numeric' });
            const monthFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { month: 'long' });
            
            const year = yearFormatter.format(today).replace(/\s*Ù‡Ù€.*/, '');
            const monthName = monthFormatter.format(today);
            
            return { year, monthName };
        }

        loadHalaqa(halaqaData) {
            this.currentHalaqa = JSON.parse(JSON.stringify(halaqaData));
            document.getElementById('studentsTabs').innerHTML = '';
            document.getElementById('studentsContentContainer').innerHTML = '';
            document.getElementById('halaqaSummary').classList.add('hidden');

            const { year, monthName } = this.getHijriDateParts();
            document.getElementById('currentHijriYear').textContent = `Ù„Ø¹Ø§Ù… ${year}Ù‡Ù€`;
            document.getElementById('teacherName').value = this.currentHalaqa.teacherName;
            document.getElementById('circleName').value = this.currentHalaqa.circleName;
            
            const monthSelect = document.getElementById('month');
            if (this.currentHalaqa.month) {
                monthSelect.value = this.currentHalaqa.month;
            } else {
                const currentMonthOption = Array.from(monthSelect.options).find(opt => opt.text === monthName);
                if (currentMonthOption) {
                    monthSelect.value = currentMonthOption.value;
                    this.currentHalaqa.month = currentMonthOption.value;
                } else {
                     monthSelect.value = "";
                }
            }
            
            (this.currentHalaqa.students || []).forEach(student => {
                this.createStudentTab(student);
                this.createStudentContentWithData(student);
            });
            if (this.currentHalaqa.students && this.currentHalaqa.students.length > 0) {
                this.switchToStudent(this.currentHalaqa.students[0].id);
            } else {
                this.currentStudentId = null;
            }
        }

        captureAndSaveHalaqa() {
            if (!this.currentHalaqa) return;
            this.currentHalaqa.teacherName = document.getElementById('teacherName').value;
            this.currentHalaqa.circleName = document.getElementById('circleName').value;
            this.currentHalaqa.month = document.getElementById('month').value;
            (this.currentHalaqa.students || []).forEach(student => this.captureStudentData(student.id));
            this.app.updateCurrentHalaqa(this.currentHalaqa);
        }

        addStudent() {
            const nameInput = document.getElementById('newStudentName');
            const studentName = nameInput.value.trim();
            if (!studentName) return this.showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'warning');
            if (!this.currentHalaqa.studentIdCounter) this.currentHalaqa.studentIdCounter = (this.currentHalaqa.students || []).length + 1;
            const studentId = `student_${this.currentHalaqa.studentIdCounter++}`;
            const newStudent = {
                id: studentId, name: studentName,
                grade: document.getElementById('newStudentGrade').value.trim(),
                civilId: document.getElementById('newStudentCivilId').value.trim(),
                data: { weeks: [{ days: Array(4).fill({}).map(() => ({ date: this.getHijriDateString(new Date()) })) }] }
            };
            if (!this.currentHalaqa.students) this.currentHalaqa.students = [];
            this.currentHalaqa.students.push(newStudent);
            this.createStudentTab(newStudent);
            this.createStudentContentWithData(newStudent);
            this.switchToStudent(studentId);
            nameInput.value = '';
            document.getElementById('newStudentGrade').value = '';
            document.getElementById('newStudentCivilId').value = '';
            this.captureAndSaveHalaqa();
            this.showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        }
        
        removeStudent(studentId) {
            const studentIndex = this.currentHalaqa.students.findIndex(s => s.id === studentId);
            if(studentIndex > -1){
                const studentName = this.currentHalaqa.students[studentIndex].name;
                this.currentHalaqa.students.splice(studentIndex, 1);
                document.getElementById(`tab_${studentId}`).remove();
                document.getElementById(`content_${studentId}`).remove();
                if (this.currentStudentId === studentId) {
                    this.currentStudentId = this.currentHalaqa.students.length > 0 ? this.currentHalaqa.students[0].id : null;
                    if (this.currentStudentId) this.switchToStudent(this.currentStudentId);
                }
                this.captureAndSaveHalaqa();
                this.showMessage(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}`, 'warning');
            }
        }

        switchToStudent(studentId) {
            if (!this.currentHalaqa || !this.currentHalaqa.students.find(s => s.id === studentId)) return;
            this.currentStudentId = studentId;
            document.querySelectorAll('.student-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.student-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`tab_${studentId}`).classList.add('active');
            document.getElementById(`content_${studentId}`).classList.add('active');
        }
        
        addWeekToCurrentStudent() {
            if (!this.currentStudentId) return this.showMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
            const student = this.currentHalaqa.students.find(s => s.id === this.currentStudentId);
            if (student) {
                if (!student.data.weeks) student.data.weeks = [];
                student.data.weeks.push({ days: Array(4).fill({}) });
                const weeksContainer = document.getElementById(`weeks_${this.currentStudentId}`);
                const newWeekData = student.data.weeks[student.data.weeks.length - 1];
                weeksContainer.insertAdjacentHTML('beforeend', this.createWeekTableWithData(student.id, newWeekData, student.data.weeks.length));
                this.captureAndSaveHalaqa();
            }
        }
        
        createStudentTab(student) {
            const tabsContainer = document.getElementById('studentsTabs');
            const tab = document.createElement('div');
            tab.id = `tab_${student.id}`;
            tab.className = 'student-tab px-4 py-2 rounded-lg border border-gray-300 font-bold flex items-center gap-2';
            tab.innerHTML = `<span class="flex-1 select-none">${student.name}</span>`;
            tab.addEventListener('click', () => this.switchToStudent(student.id));
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn text-red-500 hover:text-red-700 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold';
            deleteBtn.textContent = 'âœ•';
            deleteBtn.title = 'Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation(); 
                this.removeStudent(student.id);
            });
            tab.appendChild(deleteBtn);
            tabsContainer.appendChild(tab);
        }

        createStudentContentWithData(student) {
            const contentContainer = document.getElementById('studentsContentContainer');
            const studentDiv = document.createElement('div');
            studentDiv.id = `content_${student.id}`;
            studentDiv.className = 'student-content student-card';
            let weeksHTML = (student.data.weeks || []).map((weekData, index) => this.createWeekTableWithData(student.id, weekData, index + 1)).join('');
            
            studentDiv.innerHTML = `
                <div class="border-2 border-blue-600 p-4 mb-6 bg-blue-50">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div><span class="font-bold">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</span> <span class="text-blue-800 font-bold">${student.name}</span></div>
                        <div><span class="font-bold">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</span> <span class="text-blue-800">${student.grade}</span></div>
                        <div><span class="font-bold">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ:</span> <span class="text-blue-800">${student.civilId}</span></div>
                    </div>
                </div>
                <div id="weeks_${student.id}">${weeksHTML}</div>
                <div id="summary_${student.id}" class="mt-6 p-4 bg-gray-50 border border-gray-300 rounded-lg">
                    <h4 class="font-bold text-center text-lg mb-2">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨</h4>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div><p class="font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙØ¸: <span class="total-memorization text-green-600">0</span></p></div>
                        <div><p class="font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: <span class="total-review text-indigo-600">0</span></p></div>
                        <div><p class="font-bold">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: <span class="total-attendance text-teal-600">0</span></p></div>
                        <div><p class="font-bold">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨: <span class="total-absence text-red-600">0</span></p></div>
                    </div>
                </div>`;
            contentContainer.appendChild(studentDiv);
        }

        getHijriDateString(date) {
            const formatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { day: '2-digit', month: '2-digit', year: 'numeric' });
            return formatter.format(date).replace(/\s*Ù‡Ù€.*/, '');
        }

        createWeekTableWithData(studentId, weekData, weekNumber) {
            const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'];
            
            const createTextField = (dayIndex, field, placeholder = '', value = '', type = 'text') => {
                 return `<input type="${type}" placeholder="${placeholder}" value="${value || ''}" class="w-full text-center border-gray-300 rounded" data-day-index="${dayIndex}" data-field="${field}">`;
            };
            
            const createTextArea = (dayIndex, field, placeholder = '', value = '') => {
                 return `<textarea placeholder="${placeholder}" class="w-full border-gray-300 rounded text-sm p-1" rows="2" data-day-index="${dayIndex}" data-field="${field}">${value || ''}</textarea>`;
            };

            const createAttendanceSelect = (dayIndex, field, value = '') => {
                 return `<select class="w-full border-gray-300 rounded attendance-select" data-day-index="${dayIndex}" data-field="${field}">
                            <option value=""></option>
                            <option value="Ø­Ø¶Ø±" ${value === 'Ø­Ø¶Ø±' ? 'selected' : ''}>Ø­Ø¶Ø±</option>
                            <option value="ØºØ§Ø¨" ${value === 'ØºØ§Ø¨' ? 'selected' : ''}>ØºØ§Ø¨</option>
                            <option value="Ù…Ø³ØªØ£Ø°Ù†" ${value === 'Ù…Ø³ØªØ£Ø°Ù†' ? 'selected' : ''}>Ù…Ø³ØªØ£Ø°Ù†</option>
                        </select>`;
            };
            
            const createGradeSelect = (dayIndex, field, value = '') => {
                 return `<select class="w-full border-gray-300 rounded" data-day-index="${dayIndex}" data-field="${field}">
                            <option value=""></option>
                            <option value="Ù…Ù…ØªØ§Ø²" ${value === 'Ù…Ù…ØªØ§Ø²' ? 'selected' : ''}>Ù…Ù…ØªØ§Ø²</option>
                            <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹" ${value === 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' ? 'selected' : ''}>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</option>
                            <option value="Ø¬ÙŠØ¯" ${value === 'Ø¬ÙŠØ¯' ? 'selected' : ''}>Ø¬ÙŠØ¯</option>
                            <option value="Ù…Ù‚Ø¨ÙˆÙ„" ${value === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'selected' : ''}>Ù…Ù‚Ø¨ÙˆÙ„</option>
                            <option value="Ø¶Ø¹ÙŠÙ" ${value === 'Ø¶Ø¹ÙŠÙ' ? 'selected' : ''}>Ø¶Ø¹ÙŠÙ</option>
                        </select>`;
            };

            // --- MOBILE VIEW HTML ---
            const mobileDayCards = days.map((day, dayIndex) => {
                const dayData = weekData.days?.[dayIndex] || {};
                const hijriDateString = this.getHijriDateString(new Date());

                return `
                <div class="border-b-2 border-gray-200 p-3 last:border-b-0">
                    <div class="flex justify-between items-center mb-4">
                        <h5 class="font-bold text-lg text-blue-800">${day}</h5>
                        <div class="w-1/2">
                            ${createTextField(dayIndex, 'date', '', dayData.date || hijriDateString)}
                        </div>
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø­Ø¶ÙˆØ±</label>
                        ${createAttendanceSelect(dayIndex, 'attendance', dayData.attendance)}
                    </div>

                    <!-- Hifdh Section -->
                    <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
                        <h6 class="font-bold mb-2 text-blue-700">Ø§Ù„Ø­ÙØ¸</h6>
                        <div class="grid grid-cols-2 gap-3 items-center">
                            <label class="block text-sm font-medium">Ø§Ù„Ø³ÙˆØ±Ø©</label> ${createTextField(dayIndex, 'hifdhSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.hifdhSurah)}
                            <label class="block text-sm font-medium">Ù…Ù†</label> ${createTextField(dayIndex, 'hifdhFrom', 'Ø¢ÙŠØ©', dayData.hifdhFrom)}
                            <label class="block text-sm font-medium">Ø¥Ù„Ù‰</label> ${createTextField(dayIndex, 'hifdhTo', 'Ø¢ÙŠØ©', dayData.hifdhTo)}
                            <label class="block text-sm font-medium">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</label> ${createGradeSelect(dayIndex, 'hifdhGrade', dayData.hifdhGrade)}
                            <label class="block text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</label> ${createTextField(dayIndex, 'hifdhFaces', '0', dayData.hifdhFaces, 'number')}
                        </div>
                    </div>

                    <!-- Murajaa Section -->
                     <div class="bg-green-50 p-3 rounded-lg border border-green-200 mt-3">
                        <h6 class="font-bold mb-2 text-green-700">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h6>
                        <div class="grid grid-cols-2 gap-3 items-center">
                            <label class="block text-sm font-medium">Ø§Ù„Ø³ÙˆØ±Ø©</label> ${createTextField(dayIndex, 'murajaaSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.murajaaSurah)}
                            <label class="block text-sm font-medium">Ù…Ù†</label> ${createTextField(dayIndex, 'murajaaFrom', 'Ø¢ÙŠØ©', dayData.murajaaFrom)}
                            <label class="block text-sm font-medium">Ø¥Ù„Ù‰</label> ${createTextField(dayIndex, 'murajaaTo', 'Ø¢ÙŠØ©', dayData.murajaaTo)}
                            <label class="block text-sm font-medium">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</label> ${createGradeSelect(dayIndex, 'murajaaGrade', dayData.murajaaGrade)}
                            <label class="block text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</label> ${createTextField(dayIndex, 'murajaaFaces', '0', dayData.murajaaFaces, 'number')}
                        </div>
                    </div>
                    
                    <!-- Daily Notes Section -->
                    <div class="mt-3">
                        <label class="block text-sm font-medium text-gray-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…</label>
                        ${createTextArea(dayIndex, 'notes', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª...', dayData.notes)}
                    </div>
                </div>
                `;
            }).join('');

            // --- DESKTOP VIEW HTML ---
            const desktopDayRows = days.map((day, dayIndex) => {
                const dayData = weekData.days?.[dayIndex] || {};
                const hijriDateString = this.getHijriDateString(new Date());

                return `<tr>
                    <td class="border p-2 font-bold bg-gray-50">${day}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'date', '', dayData.date || hijriDateString)}</td>
                    <td class="border p-1">${createAttendanceSelect(dayIndex, 'attendance', dayData.attendance)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.hifdhSurah)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhFrom', 'Ø¢ÙŠØ©', dayData.hifdhFrom)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhTo', 'Ø¢ÙŠØ©', dayData.hifdhTo)}</td>
                    <td class="border p-1">${createGradeSelect(dayIndex, 'hifdhGrade', dayData.hifdhGrade)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'hifdhFaces', '', dayData.hifdhFaces, 'number')}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.murajaaSurah)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaFrom', 'Ø¢ÙŠØ©', dayData.murajaaFrom)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaTo', 'Ø¢ÙŠØ©', dayData.murajaaTo)}</td>
                    <td class="border p-1">${createGradeSelect(dayIndex, 'murajaaGrade', dayData.murajaaGrade)}</td>
                    <td class="border p-1">${createTextField(dayIndex, 'murajaaFaces', '', dayData.murajaaFaces, 'number')}</td>
                    <td class="border p-1">${createTextArea(dayIndex, 'notes', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', dayData.notes)}</td>
                </tr>`;
            }).join('');

            return `<div class="week-table mb-8 border border-gray-400 rounded-lg overflow-hidden">
                <h4 class="font-bold p-2 bg-gray-100 text-center">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekNumber}</h4>
                
                <!-- Mobile View -->
                <div class="block md:hidden">${mobileDayCards}</div>

                <!-- Desktop View -->
                <div class="hidden md:block">
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm min-w-[1200px] whitespace-nowrap">
                            <thead class="bg-gray-200">
                                <tr>
                                    <th rowspan="2" class="border p-1">Ø§Ù„ÙŠÙˆÙ…</th><th rowspan="2" class="border p-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th rowspan="2" class="border p-1">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                                    <th colspan="5" class="border p-1">Ø§Ù„Ø­ÙØ¸</th><th colspan="5" class="border p-1">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
                                    <th rowspan="2" class="border p-1">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                                </tr>
                                <tr class="bg-gray-100 text-xs">
                                    <th class="border p-1">Ø§Ù„Ø³ÙˆØ±Ø©</th><th class="border p-1">Ù…Ù†</th><th class="border p-1">Ø¥Ù„Ù‰</th><th class="border p-1">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th><th class="border p-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</th>
                                    <th class="border p-1">Ø§Ù„Ø³ÙˆØ±Ø©</th><th class="border p-1">Ù…Ù†</th><th class="border p-1">Ø¥Ù„Ù‰</th><th class="border p-1">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th><th class="border p-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</th>
                                </tr>
                            </thead>
                            <tbody>${desktopDayRows}</tbody>
                        </table>
                    </div>
                </div>

                <div class="bg-yellow-50 font-bold p-2 text-center grid grid-cols-1 sm:grid-cols-2">
                    <div>Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: <span class="weekly-memorization">0</span></div>
                    <div>Ø­ØµÙŠÙ„Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: <span class="weekly-review">0</span></div>
                </div>
            </div>`;
        }
        
        captureStudentData(studentId) {
            const student = this.currentHalaqa.students.find(s => s.id === studentId);
            if (!student) return;
            const contentElement = document.getElementById(`content_${studentId}`);
            if (contentElement) {
                student.data.weeks = [];
                const weekTables = contentElement.querySelectorAll('.week-table');
                weekTables.forEach(table => {
                    const weekData = { 
                        days: Array(4).fill(0).map(() => ({}))
                    };
                    const allInputs = table.querySelectorAll('input[data-field], select[data-field], textarea[data-field]');

                    allInputs.forEach(input => {
                        const dayIndex = input.dataset.dayIndex;
                        const field = input.dataset.field;
                        if (dayIndex !== undefined && field) {
                            if (!weekData.days[dayIndex]) weekData.days[dayIndex] = {};
                            weekData.days[dayIndex][field] = input.value;
                        }
                    });
                    student.data.weeks.push(weekData);
                });
            }
        }

        calculateAllTotals() {
            if (!this.currentHalaqa || !this.currentHalaqa.students) return;
            this.currentHalaqa.students.forEach(student => this.captureStudentData(student.id));

            let halaqaTotalMemorization = 0, halaqaTotalReview = 0, halaqaTotalAttendance = 0, halaqaTotalAbsence = 0;

            this.currentHalaqa.students.forEach(student => {
                let studentTotalMemorization = 0, studentTotalReview = 0, studentTotalAttendance = 0, studentTotalAbsence = 0;
                const studentContent = document.getElementById(`content_${student.id}`);
                
                (student.data.weeks || []).forEach((week, weekIndex) => {
                    let weeklyMemorization = 0, weeklyReview = 0;
                    (week.days || []).forEach(day => {
                        weeklyMemorization += Number(day.hifdhFaces) || 0;
                        weeklyReview += Number(day.murajaaFaces) || 0;
                        if (day.attendance === 'Ø­Ø¶Ø±') studentTotalAttendance++;
                        else if (day.attendance === 'ØºØ§Ø¨') studentTotalAbsence++;
                    });

                    if (studentContent) {
                        const weekTable = studentContent.querySelectorAll('.week-table')[weekIndex];
                        if (weekTable) {
                            weekTable.querySelectorAll('.weekly-memorization').forEach(el => el.textContent = weeklyMemorization);
                            weekTable.querySelectorAll('.weekly-review').forEach(el => el.textContent = weeklyReview);
                        }
                    }
                    studentTotalMemorization += weeklyMemorization;
                    studentTotalReview += weeklyReview;
                });

                if (studentContent) {
                    const summaryDiv = studentContent.querySelector(`#summary_${student.id}`);
                    if(summaryDiv){
                        summaryDiv.querySelector('.total-memorization').textContent = studentTotalMemorization;
                        summaryDiv.querySelector('.total-review').textContent = studentTotalReview;
                        summaryDiv.querySelector('.total-attendance').textContent = studentTotalAttendance;
                        summaryDiv.querySelector('.total-absence').textContent = studentTotalAbsence;
                    }
                }
                
                halaqaTotalMemorization += studentTotalMemorization;
                halaqaTotalReview += studentTotalReview;
                halaqaTotalAttendance += studentTotalAttendance;
                halaqaTotalAbsence += studentTotalAbsence;
            });
            
            const halaqaSummaryDiv = document.getElementById('halaqaSummary');
            halaqaSummaryDiv.querySelector('#halaqaTotalMemorization').textContent = halaqaTotalMemorization;
            halaqaSummaryDiv.querySelector('#halaqaTotalReview').textContent = halaqaTotalReview;
            halaqaSummaryDiv.querySelector('#halaqaTotalAttendance').textContent = halaqaTotalAttendance;
            halaqaSummaryDiv.querySelector('#halaqaTotalAbsence').textContent = halaqaTotalAbsence;
            halaqaSummaryDiv.classList.remove('hidden');
            this.showMessage("ØªÙ… Ø­Ø³Ø§Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹ Ø¨Ù†Ø¬Ø§Ø­!", "success");
        }
        
        exportHalaqaToCSV() {
            if (!this.currentHalaqa) return this.showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø© Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'warning');

            const headers = ['Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©', 'Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ', 'Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹', 'Ø§Ù„ÙŠÙˆÙ…', 'Ø§Ù„ØªØ§Ø±ÙŠØ®', 'Ø§Ù„Ø­Ø¶ÙˆØ±', 'Ø³ÙˆØ±Ø© Ø§Ù„Ø­ÙØ¸', 'Ø§Ù„Ø­ÙØ¸ Ù…Ù†', 'Ø§Ù„Ø­ÙØ¸ Ø¥Ù„Ù‰', 'ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ø­ÙØ¸', 'Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø­ÙØ¸', 'Ø³ÙˆØ±Ø© Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ù…Ù†', 'Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø© Ø¥Ù„Ù‰', 'ØªÙ‚Ø¯ÙŠØ± Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ø£ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…'];
            let csvContent = "\uFEFF"; // BOM for Arabic Excel
            csvContent += headers.join(',') + '\r\n';

            (this.currentHalaqa.students || []).forEach(student => {
                (student.data.weeks || []).forEach((week, weekIndex) => {
                    const daysOfWeek = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'];
                    (week.days || []).forEach((day, dayIndex) => {
                        const row = [
                            `"${student.name}"`, `"${student.grade}"`, `"${student.civilId}"`,
                            weekIndex + 1, daysOfWeek[dayIndex], `"${day.date || ''}"`, `"${day.attendance || ''}"`,
                            `"${day.hifdhSurah || ''}"`, `"${day.hifdhFrom || ''}"`, `"${day.hifdhTo || ''}"`, `"${day.hifdhGrade || ''}"`, `"${day.hifdhFaces || '0'}"`,
                            `"${day.murajaaSurah || ''}"`, `"${day.murajaaFrom || ''}"`, `"${day.murajaaTo || ''}"`, `"${day.murajaaGrade || ''}"`, `"${day.murajaaFaces || '0'}"`,
                            `"${(day.notes || '').replace(/"/g, '""')}"`
                        ].join(',');
                        csvContent += row + '\r\n';
                    });
                });
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `${this.currentHalaqa.circleName || 'halaqa'}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        generatePrintableReport() {
            this.captureAndSaveHalaqa();
            const halaqa = this.currentHalaqa;
            if (!halaqa) return;

            let reportHTML = `
                <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± Ø­Ù„Ù‚Ø© ${halaqa.circleName}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
                    body { font-family: 'Amiri', serif; margin: 20px; }
                    .student-card { page-break-inside: avoid; margin-bottom: 2rem; border: 1px solid #ccc; padding: 1rem; border-radius: 0.5rem;}
                    table { width: 100%; border-collapse: collapse; } th, td { border: 1px solid #ddd; padding: 8px; text-align: center; }
                    thead { background-color: #f2f2f2; }
                    .notes-section { margin-top: 1rem; padding: 0.5rem; border-top: 2px solid #eee; }
                </style></head><body>
                    <h1 class="text-3xl font-bold text-center mb-2">ØªÙ‚Ø±ÙŠØ± Ø­Ù„Ù‚Ø©: ${halaqa.circleName}</h1>
                    <h2 class="text-xl text-center mb-6">Ø§Ù„Ù…Ø¹Ù„Ù…: ${halaqa.teacherName} | Ø§Ù„Ø´Ù‡Ø±: ${halaqa.month}</h2>`;

            (halaqa.students || []).forEach(student => {
                reportHTML += `<div class="student-card"><h3 class="text-2xl font-bold mb-4">Ø§Ù„Ø·Ø§Ù„Ø¨: ${student.name}</h3>`;
                (student.data.weeks || []).forEach((week, index) => {
                    reportHTML += this.createWeekTableWithData(student.id, week, index + 1);
                });
                reportHTML += `</div>`;
            });
            reportHTML += `</body></html>`;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            reportWindow.onload = () => reportWindow.print();
        }

        printHalaqaSummary() {
            this.captureAndSaveHalaqa();
            const halaqa = this.currentHalaqa;
            const summaryNode = document.getElementById('halaqaSummary');
            if (!halaqa || !summaryNode) return;

            const summaryContent = summaryNode.cloneNode(true);
            const btnInClone = summaryContent.querySelector('#printSummaryBtn');
            if (btnInClone) btnInClone.parentElement.replaceWith(summaryContent.querySelector('h3'));
            
            let reportHTML = `
                <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>Ù…Ù„Ø®Øµ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø­Ù„Ù‚Ø© ${halaqa.circleName}</title>
                <script src="https://cdn.tailwindcss.com"><\/script>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
                    body { font-family: 'Amiri', serif; margin: 20px; }
                    .summary-container { margin-top: 2rem; padding: 1.5rem; background-color: #eff6ff; border: 1px solid #93c5fd; border-radius: 0.5rem; }
                </style></head><body>
                <div class="container mx-auto max-w-4xl">
                    <div class="text-center">
                        <h1 class="text-3xl font-bold mb-2">Ù…Ù„Ø®Øµ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø­Ù„Ù‚Ø©: ${halaqa.circleName}</h1>
                        <h2 class="text-xl mb-6">Ø§Ù„Ù…Ø¹Ù„Ù…: ${halaqa.teacherName} | Ø§Ù„Ø´Ù‡Ø±: ${halaqa.month || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</h2>
                    </div>
                    <div class="summary-container">${summaryContent.innerHTML}</div>
                </div></body></html>`;

            const reportWindow = window.open('', '_blank');
            reportWindow.document.write(reportHTML);
            reportWindow.document.close();
            reportWindow.onload = () => reportWindow.print();
        }

        showMessage(message, type = 'info') {
            const statusDiv = document.getElementById('saveStatus');
            statusDiv.textContent = message;
            const colors = {
                success: 'bg-green-100 border-green-300 text-green-800',
                warning: 'bg-yellow-100 border-yellow-300 text-yellow-800',
                info: 'bg-blue-100 border-blue-300 text-blue-800',
                error: 'bg-red-100 border-red-300 text-red-800'
            };
            statusDiv.className = `p-3 rounded-lg border text-center font-bold ${colors[type]}`;
            clearTimeout(this.messageTimeout);
            this.messageTimeout = setTimeout(() => { statusDiv.className = 'hidden'; }, 3000);
        }
    }

    const app = new AppManager();
    
    // Bind events for elements that exist on page load
    document.getElementById('selectMenBtn').addEventListener('click', () => app.selectSection('men'));
    document.getElementById('selectWomenBtn').addEventListener('click', () => app.selectSection('women'));
    document.getElementById('backToSectionsBtn').addEventListener('click', () => {
        window.location.hash = '';
        app.showView('selectionView')
    });
    document.getElementById('backToDashboardBtn').addEventListener('click', () => {
        window.location.hash = '';
        app.showView('dashboardView')
    });
    document.getElementById('addNewHalaqaBtn').addEventListener('click', () => app.addNewHalaqa());
    document.getElementById('generateReportBtn').addEventListener('click', () => app.generateSectionReport());
    
    document.getElementById('copyShareLinkBtn').addEventListener('click', () => {
        const linkInput = document.getElementById('shareLinkInput');
        linkInput.select();
        linkInput.setSelectionRange(0, 99999);
        try {
            document.execCommand('copy');
            app.halaqaManager.showMessage('ØªÙ… Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø· Ø¨Ù†Ø¬Ø§Ø­!', 'success');
        } catch (err) {
            app.halaqaManager.showMessage('ÙØ´Ù„ Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù†Ø³Ø® ÙŠØ¯ÙˆÙŠØ§Ù‹.', 'error');
        }
    });

    document.getElementById('closeShareModalBtn').addEventListener('click', () => {
        document.getElementById('shareModal').classList.add('hidden');
    });

    // Use event delegation for dynamically created elements
    document.getElementById('halaqaList').addEventListener('click', (e) => {
        const target = e.target.closest('button');
        if (!target) return;

        const halaqaId = target.dataset.halaqaId;
        if (target.classList.contains('open-halaqa-btn')) {
            app.openHalaqa(halaqaId);
        } else if (target.classList.contains('delete-halaqa-btn')) {
            app.deleteHalaqa(halaqaId);
        } else if (target.classList.contains('share-halaqa-btn')) {
            app.shareHalaqa(halaqaId);
        }
    });

    </script>
</body>
</html>

