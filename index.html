<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Chart.js UMD Ø¹Ø¨Ø± CDN (ÙŠÙˆÙØ± Ø§Ù„ÙƒØ§Ø¦Ù† Chart ÙÙŠ Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø¹Ø§Ù…) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
    body { font-family: 'Amiri', serif; }
    .print-page { page-break-after: always; }
    @media print {
      body, .container { margin: 0; padding: 0; box-shadow: none; border: none; font-size: 10px; }
      .no-print { display: none !important; }
      .view { display: none !important; }
      #analyticsView { display: block !important; }
    }
    input, select, textarea { border: 1px solid #d1d5db; border-radius: 4px; padding: 4px 8px; font-family: 'Amiri', serif; background-color: transparent; }
    .student-tab { transition: all 0.3s ease; cursor: pointer; }
    .student-tab.active { background-color: #3b82f6; color: white; }
    .student-tab:hover { background-color: #e5e7eb; }
    .student-tab.active:hover { background-color: #2563eb; }
    .student-content, .view { display: none; }
    .view.active { display: block; }
    .student-content.active { display: block; }
    .delete-btn { transition: all 0.2s ease; }
    .delete-btn:hover { transform: scale(1.1); background-color: #fee2e2; }
  </style>

  <!-- ØªÙ‡ÙŠØ¦Ø© Firebase: ÙŠØ¬Ø¨ ÙˆØ¶Ø¹Ù‡Ø§ Ù‚Ø¨Ù„ Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ -->
  <script>
    // Ø§Ø³ØªØ¨Ø¯Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ù‚ÙŠÙ… Ù…Ù† Firebase Console â†’ Project settings â†’ Your apps â†’ Web app
    window.__firebase_config = JSON.stringify({
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
      projectId: "YOUR_PROJECT_ID",
      appId: "YOUR_APP_ID"
    });
    // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: ØªØ«Ø¨ÙŠØª Ù…Ø¹Ø±Ù Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù„Ù…Ø³Ø§Ø± Firestore
    window.__app_id = "YOUR_PROJECT_ID";
    // Ø§Ø®ØªÙŠØ§Ø±ÙŠ: Ø¥Ø°Ø§ ØªÙˆÙØ± ØªÙˆÙƒÙ† Ù…ØµØ§Ø¯Ù‚Ø© Ù…Ø®ØµØµ
    // window.__initial_auth_token = "YOUR_CUSTOM_TOKEN";
  </script>
</head>
<body class="bg-gray-50 p-4">

  <!-- App Container -->
  <div class="container mx-auto max-w-7xl bg-white shadow-lg rounded-lg p-6">

    <!-- View 1: Section Selection -->
    <div id="selectionView" class="view active text-center py-16">
      <h1 class="text-3xl font-bold mb-8 text-gray-700">Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù‚Ø±Ø¢Ù† Ø§Ù„ÙƒØ±ÙŠÙ…</h1>
      <p class="text-lg text-gray-500 mb-12">Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù‚Ø³Ù… Ù„Ù„Ø¨Ø¯Ø¡</p>
      <div class="flex flex-col sm:flex-row justify-center gap-4 sm:gap-8">
        <button id="selectMenBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">Ù‚Ø³Ù… Ø§Ù„Ø±Ø¬Ø§Ù„</button>
        <button id="selectWomenBtn" class="bg-pink-500 hover:bg-pink-600 text-white font-bold py-4 px-10 rounded-lg text-xl shadow-lg transition-transform transform hover:scale-105">Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡</button>
      </div>
      <p id="firebase-status" class="mt-8 text-gray-400 text-sm">Ø¬Ø§Ø±ÙŠ ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...</p>
    </div>

    <!-- View 2: Halaqa Dashboard -->
    <div id="dashboardView" class="view">
      <div class="flex flex-wrap justify-between items-center mb-6 gap-4">
        <h1 id="dashboardTitle" class="text-3xl font-bold text-gray-700"></h1>
        <button id="backToSectionsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø£Ù‚Ø³Ø§Ù…</button>
      </div>
      <div id="formContainer" class="bg-gray-50 p-6 rounded-lg border border-gray-200"></div>
      <hr class="my-8">
      <div>
        <div class="flex flex-wrap gap-4 justify-between items-center mb-4">
          <h2 id="listTitle" class="text-xl font-bold"></h2>
          <div class="flex gap-2">
            <button id="showAnalyticsBtn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-2 px-4 rounded-lg">ğŸ“Š Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</button>
            <button id="generateReportBtn" class="bg-teal-600 hover:bg-teØ§Ù„-700 text-white font-bold py-2 px-4 rounded-lg">ğŸ“ˆ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ù„Ù„Ù‚Ø³Ù…</button>
          </div>
        </div>
        <div id="listContainer"></div>
      </div>
    </div>

    <!-- View 3: Halaqa Management -->
    <div id="halaqaView" class="view">
      <div class="flex justify-start mb-4 no-print">
        <button id="backToDashboardBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">â†’ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</button>
      </div>

      <div class="border-2 border-gray-800 p-4 mb-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
          <div class="flex items-center gap-2">
            <span class="font-bold">Ø§Ù„Ù…Ø¹Ù„Ù… /</span>
            <input type="text" id="teacherName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…">
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold">Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© /</span>
            <input type="text" id="circleName" class="flex-1 border-b border-gray-400 bg-transparent" placeholder="Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©">
          </div>
          <div class="flex items-center gap-2">
            <span class="font-bold">Ø§Ù„Ø´Ù‡Ø± /</span>
            <select id="month" class="border-b border-gray-400 bg-transparent">
              <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø±</option>
              <option value="Ù…Ø­Ø±Ù…">Ù…Ø­Ø±Ù…</option><option value="ØµÙØ±">ØµÙØ±</option><option value="Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø£ÙˆÙ„</option><option value="Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ">Ø±Ø¨ÙŠØ¹ Ø§Ù„Ø«Ø§Ù†ÙŠ</option>
              <option value="Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø£ÙˆÙ„Ù‰</option><option value="Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©">Ø¬Ù…Ø§Ø¯Ù‰ Ø§Ù„Ø«Ø§Ù†ÙŠØ©</option><option value="Ø±Ø¬Ø¨">Ø±Ø¬Ø¨</option><option value="Ø´Ø¹Ø¨Ø§Ù†">Ø´Ø¹Ø¨Ø§Ù†</option>
              <option value="Ø±Ù…Ø¶Ø§Ù†">Ø±Ù…Ø¶Ø§Ù†</option><option value="Ø´ÙˆØ§Ù„">Ø´ÙˆØ§Ù„</option><option value="Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©">Ø°Ùˆ Ø§Ù„Ù‚Ø¹Ø¯Ø©</option><option value="Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©">Ø°Ùˆ Ø§Ù„Ø­Ø¬Ø©</option>
            </select>
          </div>
        </div>
        <div class="text-center"><span id="currentHijriYear" class="font-bold text-lg"></span></div>
      </div>

      <div class="mb-6 no-print">
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
          <h3 class="font-bold text-lg mb-3">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø·Ù„Ø§Ø¨</h3>
          <div class="flex gap-4 items-center flex-wrap">
            <input type="text" id="newStudentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯" class="flex-grow">
            <input type="text" id="newStudentGrade" placeholder="Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©" class="flex-grow">
            <input type="text" id="newStudentCivilId" placeholder="Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ" class="flex-grow">
            <button id="addStudentBtn" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded font-bold">â• Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
          </div>
        </div>
      </div>

      <div id="studentsTabsContainer" class="mb-6 no-print">
        <div class="flex flex-wrap gap-2 mb-4 border-b border-gray-300 pb-2" id="studentsTabs"></div>
      </div>

      <div id="studentsContentContainer"></div>

      <div class="flex gap-4 mb-6 no-print flex-wrap">
        <button id="addWeekBtn" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg font-bold">Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ø¨ÙˆØ¹ Ù„Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
        <button id="calculateBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded-lg font-bold">Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¬Ø§Ù…ÙŠØ¹</button>
        <button id="printBtn" class="bg-purple-600 hover:bg-purple-700 text-white px-6 py-2 rounded-lg font-bold">ğŸ“„ Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ± (PDF/Ø·Ø¨Ø§Ø¹Ø©)</button>
        <button id="exportBtn" class="bg-emerald-600 hover:bg-emerald-700 text-white px-6 py-2 rounded-lg font-bold">ğŸ“„ ØªØµØ¯ÙŠØ± Ù„Ø¥ÙƒØ³Ù„</button>
      </div>

      <div id="saveStatus" class="mb-4 p-3 rounded-lg hidden"></div>

      <div id="halaqaSummary" class="mt-8 p-6 bg-blue-50 border border-blue-200 rounded-lg no-print hidden">
        <div class="flex justify-between items-center mb-4">
          <h3 class="text-xl font-bold text-blue-800">Ù…Ù„Ø®Øµ Ø¥Ù†Ø¬Ø§Ø²Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø©</h3>
          <button id="printSummaryBtn" class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-1 rounded-lg font-bold">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ù…Ù„Ø®Øµ</button>
        </div>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
          <div><p class="text-2xl font-bold text-green-600" id="halaqaTotalMemorization">0</p><p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø­ÙØ¸</p></div>
          <div><p class="text-2xl font-bold text-indigo-600" id="halaqaTotalReview">0</p><p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</p></div>
          <div><p class="text-2xl font-bold text-teØ§Ù„-600" id="halaqaTotalAttendance">0</p><p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±</p></div>
          <div><p class="text-2xl font-bold text-red-600" id="halaqaTotalAbsence">0</p><p class="text-sm text-gray-600">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨</p></div>
        </div>
      </div>
    </div>

    <!-- View 4: Analytics View -->
    <div id="analyticsView" class="view">
      <div class="flex flex-wrap justify-between items-center mb-6 gap-4 no-print">
        <h1 id="analyticsTitle" class="text-3xl font-bold text-gray-700"></h1>
        <div class="flex gap-2">
          <button id="printAnalyticsBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">ğŸ–¨ï¸ Ø·Ø¨Ø§Ø¹Ø©</button>
          <button id="exportAnalyticsBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">ğŸ“„ ØªØµØ¯ÙŠØ± (ÙˆÙˆØ±Ø¯)</button>
          <button id="backToDashboardFromAnalyticsBtn" class="bg-gray-200 hover:bg-gray-300 text-gray-800 font-bold py-2 px-4 rounded-lg">â†’ Ø§Ù„Ø¹ÙˆØ¯Ø©</button>
        </div>
      </div>
      <div id="analyticsContent" class="bg-white p-4 sm:p-6 rounded-lg shadow-lg">
        <canvas id="halaqaChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="shareModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden no-print">
    <div class="bg-white rounded-lg p-6 w-full max-w-md text-center shadow-2xl">
      <h3 class="text-xl font-bold mb-4">Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„Ø­Ù„Ù‚Ø©</h3>
      <p class="text-gray-600 mb-4">Ø§Ù†Ø³Ø® Ù‡Ø°Ø§ Ø§Ù„Ø±Ø§Ø¨Ø· ÙˆØ£Ø±Ø³Ù„Ù‡ Ù„Ù„Ù…Ø¹Ù„Ù…/Ø©. Ø³ÙŠØªÙ…ÙƒÙ† Ù…Ù† Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø­Ù„Ù‚Ø©.</p>
      <input type="text" id="shareLinkInput" readonly class="w-full p-2 border rounded-md text-center bg-gray-100 mb-4 font-mono">
      <div class="flex gap-4 justify-center">
        <button id="copyShareLinkBtn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">Ù†Ø³Ø® Ø§Ù„Ø±Ø§Ø¨Ø·</button>
        <button id="closeShareModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Ø¥ØºÙ„Ø§Ù‚</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden no-print">
    <div class="bg-white rounded-lg p-6 w-full max-w-md text-center shadow-2xl">
      <h3 class="text-xl font-bold mb-4">ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø©</h3>
      <div class="space-y-4 text-right">
        <div>
          <label for="editHalaqaName" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
          <input type="text" id="editHalaqaName" class="w-full p-2 border rounded-md">
        </div>
        <div>
          <label for="editTeacherName" class="block text-sm font-medium text-gray-700 mb-1">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
          <input type="text" id="editTeacherName" class="w-full p-2 border rounded-md">
        </div>
      </div>
      <div class="flex gap-4 justify-center mt-6">
        <button id="saveEditBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
        <button id="closeEditModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Ø¥Ù„ØºØ§Ø¡</button>
      </div>
    </div>
  </div>

  <!-- Ø³ÙƒØ±Ø¨Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ (Ù†ÙØ³ Ù…Ù†Ø·Ù‚Ùƒ ÙƒÙ…Ø§ Ù‡Ùˆ) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    // ============== AppManager ==============
    class AppManager {
      constructor() {
        this.appData = { men: [], women: [] };
        this.currentSection = null;
        this.currentHalaqaId = null;
        this.halaqaManager = new HalaqaManager(this);
        this.db = null;
        this.unsubscribe = null;
        this.initialLinkHandled = false;
        this.appId = null;
        this.initFirebase();
      }

      async initFirebase() {
        if (typeof __firebase_config === 'undefined') {
          document.getElementById('firebase-status').textContent = 'ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø© (Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¹Ø·Ù„)';
          this.handleDirectLinkAfterDataLoad();
          return;
        }
        try {
          const firebaseConfig = JSON.parse(__firebase_config);
          this.appId = typeof __app_id !== 'undefined' ? __app_id : firebaseConfig.projectId;
          const app = initializeApp(firebaseConfig);
          this.db = getFirestore(app);
          const auth = getAuth(app);
          if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
          } else {
            await signInAnonymously(auth);
          }
          document.getElementById('firebase-status').textContent = 'Ù…ØªØµÙ„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…';
          this.listenForDataChanges(this.appId);
        } catch (error) {
          console.error("Firebase initialization failed:", error);
          document.getElementById('firebase-status').textContent = `ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„: ${error.message}`;
          this.handleDirectLinkAfterDataLoad();
        }
      }

      listenForDataChanges(appId) {
        if (!this.db) {
          if (!this.initialLinkHandled) this.handleDirectLinkAfterDataLoad();
          return;
        }
        const ref = doc(this.db, "artifacts", appId, "public", "data");
        this.unsubscribe = onSnapshot(ref, (snap) => {
          if (snap.exists()) {
            const data = snap.data();
            this.appData = { men: data.men || [], women: data.women || [] };
          } else {
            this.appData = { men: [], women: [] };
            this.saveData();
          }
          if (!this.initialLinkHandled) this.handleDirectLinkAfterDataLoad();
          if (this.currentSection && document.getElementById('dashboardView').classList.contains('active')) {
            this.renderDashboard();
          }
        }, () => {
          this.halaqaManager.showMessage('Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø²Ø§Ù…Ù†Ø© Ù…Ø¹ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error');
        });
      }

      handleDirectLinkAfterDataLoad() {
        this.initialLinkHandled = true;
        const hash = window.location.hash;
        if (hash && hash.startsWith('#halaqa_id=')) {
          const halaqaId = hash.substring('#halaqa_id='.length);
          const section = halaqaId.startsWith('men') ? 'men' : halaqaId.startsWith('women') ? 'women' : null;
          if (section) {
            this.currentSection = section;
            this.openHalaqa(halaqaId);
          } else {
            this.showView('selectionView');
          }
        } else {
          this.showView('selectionView');
        }
      }

      async saveData() {
        if (!this.db || !this.appId) return;
        const ref = doc(this.db, "artifacts", this.appId, "public", "data");
        try {
          await setDoc(ref, this.appData);
        } catch (error) {
          this.halaqaManager.showMessage('ÙØ´Ù„ Ø§Ù„Ø­ÙØ¸: ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙˆØµÙˆÙ„ Ù…Ø±ÙÙˆØ¶Ø©. Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø£Ù…Ø§Ù†.', 'error');
          throw error;
        }
      }

      showView(viewId) {
        document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
        const viewToShow = document.getElementById(viewId);
        if (viewToShow) {
          viewToShow.classList.add('active');
          if (viewId === 'dashboardView') this.renderDashboard();
        } else {
          document.getElementById('selectionView').classList.add('active');
        }
      }

      selectSection(section) {
        this.currentSection = section;
        document.getElementById('dashboardTitle').textContent = `Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… ${section === 'men' ? 'Ù‚Ø³Ù… Ø§Ù„Ø±Ø¬Ø§Ù„' : 'Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡'}`;
        this.showView('dashboardView');
      }

      renderDashboard() {
        const listContainer = document.getElementById('listContainer');
        const formContainer = document.getElementById('formContainer');
        const listTitle = document.getElementById('listTitle');
        listContainer.innerHTML = '';

        if (this.currentSection === 'men') {
          listTitle.textContent = 'Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù…Ø³Ø¬Ù„Ø©';
          formContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <div class="flex flex-wrap gap-4 items-end">
              <div class="flex-grow"><label for="newHalaqaName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©</label><input type="text" id="newHalaqaName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„Ù‚Ø© Ø§Ù„Ù…Ø¨ØªØ¯Ø¦ÙŠÙ†"></div>
              <div class="flex-grow"><label for="newTeacherName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©</label><input type="text" id="newTeacherName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„/Ø©"></div>
              <button id="addNewHalaqaBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">â• Ø¥Ø¶Ø§ÙØ©</button>
            </div>`;
          listContainer.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
          const halaqas = this.appData.men || [];
          if (halaqas.length === 0) {
            listContainer.innerHTML = `<p class="text-gray-500 col-span-full">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯.</p>`;
          } else {
            halaqas.forEach(halaqa => {
              const card = document.createElement('div');
              card.className = 'bg-white p-6 rounded-lg shadow-md border border-gray-200';
              card.innerHTML = `
                <h3 class="text-lg font-bold text-blue-800">${halaqa.circleName}</h3>
                <p class="text-gray-600 mb-4">${halaqa.teacherName}</p>
                <div class="flex gap-2 mt-4 flex-wrap">
                  <button data-halaqa-id="${halaqa.id}" class="open-halaqa-btn flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ÙØªØ­</button>
                  <button data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn flex-1 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-4 rounded-lg text-sm">ØªØ¹Ø¯ÙŠÙ„</button>
                  <button data-halaqa-id="${halaqa.id}" class="share-halaqa-btn flex-1 bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                  <button data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg text-sm">Ø­Ø°Ù</button>
                </div>`;
              listContainer.appendChild(card);
            });
          }
        } else if (this.currentSection === 'women') {
          listTitle.textContent = 'Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ù…Ø³Ø¬Ù„Ø©';
          formContainer.innerHTML = `
            <h2 class="text-xl font-bold mb-4">Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ø± Ø¬Ø¯ÙŠØ¯Ø©</h2>
            <div class="flex flex-wrap gap-4 items-end">
              <div class="flex-grow"><label for="newDarName" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø±</label><input type="text" id="newDarName" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ù…Ø«Ø§Ù„: Ø¯Ø§Ø± Ø§Ù„Ù‡Ø¯Ù‰ Ø§Ù„Ù†Ø³Ø§Ø¦ÙŠØ©"></div>
              <button id="addNewDarBtn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">â• Ø¥Ø¶Ø§ÙØ© Ø¯Ø§Ø±</button>
            </div>`;
          listContainer.className = 'space-y-6';
          const dars = this.appData.women || [];
          if (dars.length === 0) {
            listContainer.innerHTML = `<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¯ÙˆØ± Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø¹Ø¯.</p>`;
          } else {
            dars.forEach(dar => {
              const darContainer = document.createElement('div');
              darContainer.className = 'bg-white p-6 rounded-lg shadow-lg border border-pink-200';
              let halaqaCardsHTML = (dar.halaqas || []).map(halaqa => `
                <div class="bg-gray-50 p-4 rounded-md border flex flex-col md:flex-row justify-between items-start md:items-center gap-3">
                  <div>
                    <h4 class="font-bold text-gray-800">${halaqa.circleName}</h4>
                    <p class="text-sm text-gray-500">${halaqa.teacherName}</p>
                  </div>
                  <div class="flex gap-2 flex-shrink-0 flex-wrap">
                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="open-halaqa-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded-md text-sm">ÙØªØ­</button>
                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="edit-halaqa-btn bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-3 rounded-md text-sm">ØªØ¹Ø¯ÙŠÙ„</button>
                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="share-halaqa-btn bg-gray-500 hover:bg-gray-600 text-white font-bold py-1 px-3 rounded-md text-sm">Ù…Ø´Ø§Ø±ÙƒØ©</button>
                    <button data-dar-id="${dar.id}" data-halaqa-id="${halaqa.id}" class="delete-halaqa-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-md text-sm">Ø­Ø°Ù</button>
                  </div>
                </div>
              `).join('');
              darContainer.innerHTML = `
                <div class="flex justify-between items-center mb-4">
                  <h3 class="text-2xl font-bold text-pink-700">${dar.name}</h3>
                  <button data-dar-id="${dar.id}" class="delete-dar-btn bg-red-100 text-red-700 hover:bg-red-200 font-bold py-1 px-3 rounded-md">Ø­Ø°Ù Ø§Ù„Ø¯Ø§Ø±</button>
                </div>
                <div class="space-y-3 mb-6">${halaqaCardsHTML || '<p class="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ø± Ø¨Ø¹Ø¯.</p>'}</div>
                <div class="bg-pink-50 p-4 rounded-lg border border-pink-200 mt-4">
                  <h4 class="font-bold mb-3">Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‚Ø© Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø¯Ø§Ø±</h4>
                  <div class="flex flex-wrap gap-4 items-end">
                    <div class="flex-grow"><label for="newHalaqaName_${dar.id}" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©</label><input type="text" id="newHalaqaName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ù…Ø«Ø§Ù„: Ø­Ù„Ù‚Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø§Øª"></div>
                    <div class="flex-grow"><label for="newTeacherName_${dar.id}" class="block text-sm font-medium text-gray-700">Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©</label><input type="text" id="newTeacherName_${dar.id}" class="mt-1 block w-full border-gray-300 rounded-md shadow-sm" placeholder="Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø© Ø§Ù„Ù…Ø³Ø¤ÙˆÙ„Ø©"></div>
                    <button data-dar-id="${dar.id}" class="add-halaqa-to-dar-btn bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-6 rounded-lg">â• Ø¥Ø¶Ø§ÙØ© Ø­Ù„Ù‚Ø©</button>
                  </div>
                </div>`;
              listContainer.appendChild(darContainer);
            });
          }
        }
      }

      shareHalaqa(halaqaId) {
        try {
          const baseUrl = window.location.href.split('#');
          const shareableLink = `${baseUrl}#halaqa_id=${halaqaId}`;
          document.getElementById('shareLinkInput').value = shareableLink;
          document.getElementById('shareModal').classList.remove('hidden');
        } catch {
          this.halaqaManager.showMessage('ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©.', 'error');
        }
      }

      addNewHalaqaToMen() {
        const circleName = document.getElementById('newHalaqaName').value.trim();
        const teacherName = document.getElementById('newTeacherName').value.trim();
        if (!circleName || !teacherName) { this.halaqaManager.showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…', 'warning'); return; }
        const newHalaqa = { id: `men_${Date.now()}`, circleName, teacherName, month: '', students: [], studentIdCounter: 1 };
        const originalData = JSON.parse(JSON.stringify(this.appData));
        this.appData.men.push(newHalaqa);
        this.renderDashboard();
        this.saveData().then(() => {
          this.halaqaManager.showMessage('ØªÙ…Øª Ø§Ù„Ø¥Ø¶Ø§ÙØ© Ø¨Ù†Ø¬Ø§Ø­!', 'success');
          document.getElementById('newHalaqaName').value = '';
          document.getElementById('newTeacherName').value = '';
        }).catch(() => { this.appData = originalData; this.renderDashboard(); });
      }

      deleteHalaqaFromMen(halaqaId) {
        const idx = this.appData.men.findIndex(h => h.id === halaqaId);
        if (idx > -1) {
          const originalData = JSON.parse(JSON.stringify(this.appData));
          this.appData.men.splice(idx, 1);
          this.renderDashboard();
          this.saveData().then(() => this.halaqaManager.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'warning'))
            .catch(() => { this.appData = originalData; this.renderDashboard(); });
        }
      }

      addNewDar() {
        const darNameInput = document.getElementById('newDarName');
        const darName = darNameInput.value.trim();
        if (!darName) { return this.halaqaManager.showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø±', 'warning'); }
        const newDar = { id: `dar_${Date.now()}`, name: darName, halaqas: [] };
        const originalData = JSON.parse(JSON.stringify(this.appData));
        this.appData.women.push(newDar);
        this.renderDashboard();
        this.saveData().then(() => { darNameInput.value = ''; this.halaqaManager.showMessage('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¯Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success'); })
          .catch(() => { this.appData = originalData; this.renderDashboard(); });
      }

      deleteDar(darId) {
        const idx = this.appData.women.findIndex(d => d.id === darId);
        if (idx > -1) {
          const originalData = JSON.parse(JSON.stringify(this.appData));
          this.appData.women.splice(idx, 1);
          this.renderDashboard();
          this.saveData().then(() => this.halaqaManager.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¯Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'warning'))
            .catch(() => { this.appData = originalData; this.renderDashboard(); });
        }
      }

      addNewHalaqaToDar(darId) {
        const halaqaNameInput = document.getElementById(`newHalaqaName_${darId}`);
        const teacherNameInput = document.getElementById(`newTeacherName_${darId}`);
        const circleName = halaqaNameInput.value.trim();
        const teacherName = teacherNameInput.value.trim();
        if (!circleName || !teacherName) { return this.halaqaManager.showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø© ÙˆØ§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…Ø©', 'warning'); }
        const originalData = JSON.parse(JSON.stringify(this.appData));
        const dar = this.appData.women.find(d => d.id === darId);
        if (dar) {
          const newHalaqa = { id: `women_${Date.now()}`, circleName, teacherName, month: '', students: [], studentIdCounter: 1 };
          if (!dar.halaqas) dar.halaqas = [];
          dar.halaqas.push(newHalaqa);
          this.renderDashboard();
          this.saveData().then(() => { halaqaNameInput.value = ''; teacherNameInput.value = ''; this.halaqaManager.showMessage('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success'); })
            .catch(() => { this.appData = originalData; this.renderDashboard(); });
        }
      }

      deleteHalaqaFromDar(darId, halaqaId) {
        const originalData = JSON.parse(JSON.stringify(this.appData));
        const dar = this.appData.women.find(d => d.id === darId);
        if (dar && dar.halaqas) {
          const idx = dar.halaqas.findIndex(h => h.id === halaqaId);
          if (idx > -1) {
            dar.halaqas.splice(idx, 1);
            this.renderDashboard();
            this.saveData().then(() => this.halaqaManager.showMessage('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'warning'))
              .catch(() => { this.appData = originalData; this.renderDashboard(); });
          }
        }
      }

      editHalaqa(darId, halaqaId) {
        let halaqa;
        if (this.currentSection === 'men') {
          halaqa = this.appData.men.find(h => h.id === halaqaId);
        } else {
          const dar = this.appData.women.find(d => d.id === darId);
          if (dar) halaqa = (dar.halaqas || []).find(h => h.id === halaqaId);
        }
        if (halaqa) {
          const modal = document.getElementById('editModal');
          const halaqaNameInput = document.getElementById('editHalaqaName');
          const teacherNameInput = document.getElementById('editTeacherName');
          const saveBtn = document.getElementById('saveEditBtn');
          halaqaNameInput.value = halaqa.circleName;
          teacherNameInput.value = halaqa.teacherName;
          const newSaveBtn = saveBtn.cloneNode(true);
          saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
          newSaveBtn.onclick = () => {
            const newCircleName = halaqaNameInput.value.trim();
            const newTeacherName = teacherNameInput.value.trim();
            if (!newCircleName || !newTeacherName) return this.halaqaManager.showMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¹Ø¯Ù… ØªØ±Ùƒ Ø§Ù„Ø­Ù‚ÙˆÙ„ ÙØ§Ø±ØºØ©', 'warning');
            const originalData = JSON.parse(JSON.stringify(this.appData));
            halaqa.circleName = newCircleName;
            halaqa.teacherName = newTeacherName;
            this.renderDashboard();
            this.saveData().then(() => { this.halaqaManager.showMessage('ØªÙ… ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ù„Ù‚Ø© Ø¨Ù†Ø¬Ø§Ø­', 'success'); modal.classList.add('hidden'); })
              .catch(() => { this.appData = originalData; this.renderDashboard(); });
          };
          modal.classList.remove('hidden');
        }
      }

      openHalaqa(halaqaId) {
        this.currentHalaqaId = halaqaId;
        let halaqa;
        if (this.currentSection === 'men') {
          halaqa = (this.appData.men || []).find(h => h.id === halaqaId);
        } else if (this.currentSection === 'women') {
          for (const dar of (this.appData.women || [])) {
            halaqa = (dar.halaqas || []).find(h => h.id === halaqaId);
            if (halaqa) break;
          }
        }
        if (halaqa) {
          this.halaqaManager.loadHalaqa(halaqa);
          this.showView('halaqaView');
        }
      }

      async updateCurrentHalaqa(halaqaData) {
        if (this.currentSection === 'men') {
          const idx = this.appData.men.findIndex(h => h.id === this.currentHalaqaId);
          if (idx > -1) this.appData.men[idx] = halaqaData;
        } else if (this.currentSection === 'women') {
          for (const dar of this.appData.women) {
            const idx = (dar.halaqas || []).findIndex(h => h.id === this.currentHalaqaId);
            if (idx > -1) { dar.halaqas[idx] = halaqaData; break; }
          }
        }
        await this.saveData();
      }

      showAnalytics() {
        const sectionName = this.currentSection === 'men' ? 'Ù‚Ø³Ù… Ø§Ù„Ø±Ø¬Ø§Ù„' : 'Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡';
        document.getElementById('analyticsTitle').textContent = `Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø§Øª ÙÙŠ ${sectionName}`;
        this.showView('analyticsView');
        let allHalaqas = [];
        if (this.currentSection === 'men') {
          allHalaqas = this.appData.men || [];
        } else if (this.currentSection === 'women') {
          (this.appData.women || []).forEach(dar => (dar.halaqas || []).forEach(halaqa => allHalaqas.push({ ...halaqa, darName: dar.name })));
        }
        const ctx = document.getElementById('halaqaChart').getContext('2d');
        if (window.myHalaqaChart instanceof Chart) window.myHalaqaChart.destroy();
        const labels = allHalaqas.map(h => h.circleName);
        const memorizationData = allHalaqas.map(h => this.halaqaManager.calculateHalaqaTotals(h).totalMemorization);
        const reviewData = allHalaqas.map(h => this.halaqaManager.calculateHalaqaTotals(h).totalReview);
        const attendanceData = allHalaqas.map(h => this.halaqaManager.calculateHalaqaTotals(h).totalAttendance);
        window.myHalaqaChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [
              { label: 'Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø­ÙØ¸', data: memorizationData, backgroundColor: 'rgba(54, 162, 235, 0.6)', borderColor: 'rgba(54, 162, 235, 1)', borderWidth: 1 },
              { label: 'Ø£ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©', data: reviewData, backgroundColor: 'rgba(75, 192, 192, 0.6)', borderColor: 'rgba(75, 192, 192, 1)', borderWidth: 1 },
              { label: 'Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±', data: attendanceData, backgroundColor: 'rgba(255, 206, 86, 0.6)', borderColor: 'rgba(255, 206, 86, 1)', borderWidth: 1 }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: { position: 'top', labels: { font: { family: 'Amiri', size: 14 } } },
              title: { display: true, text: 'Ù…Ù‚Ø§Ø±Ù†Ø© Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø­Ù„Ù‚Ø§Øª', font: { family: 'Amiri', size: 18 } }
            },
            scales: {
              y: { beginAtZero: true, ticks: { font: { family: 'Amiri' } } },
              x: { ticks: { font: { family: 'Amiri', size: 12 } } }
            }
          }
        });
      }

      printAnalytics() { window.print(); }

      exportAnalyticsToWord() {
        if (!window.myHalaqaChart) return this.halaqaManager.showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'error');
        const sectionName = this.currentSection === 'men' ? 'Ù‚Ø³Ù… Ø§Ù„Ø±Ø¬Ø§Ù„' : 'Ù‚Ø³Ù… Ø§Ù„Ù†Ø³Ø§Ø¡';
        const title = `<h1>ØªÙ‚Ø±ÙŠØ± Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ${sectionName}</h1>`;
        const chartImage = window.myHalaqaChart.toBase64Image();
        const chartData = window.myHalaqaChart.data;
        let tableHtml = `<table border="1" style="border-collapse: collapse; width: 100%; text-align: right; font-family: sans-serif;">
          <thead><tr><th>Ø§Ù„Ø­Ù„Ù‚Ø©</th><th>${chartData.datasets.label}</th><th>${chartData.datasets[1].label}</th><th>${chartData.datasets.label}</th></tr></thead><tbody>`;
        chartData.labels.forEach((label, index) => {
          tableHtml += `<tr><td>${label}</td><td>${chartData.datasets.data[index]}</td><td>${chartData.datasets[1].data[index]}</td><td>${chartData.datasets.data[index]}</td></tr>`;
        });
        tableHtml += `</tbody></table>`;
        const htmlContent = `
          <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
          <head><meta charset='utf-8'><title>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª</title>
            <style>body { font-family: 'Arial', sans-serif; direction: rtl; } table { border-collapse: collapse; width: 100%; } th, td { border: 1px solid #ddd; text-align: right; padding: 8px; } th { background-color: #f2f2f2; }</style>
          </head>
          <body>${title}<br/><h2>Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ</h2><p><img src="${chartImage}" alt="Analytics Chart" style="max-width: 100%;"></p><br/><h2>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h2>${tableHtml}</body></html>`;
        const blob = new Blob(['\ufeff', htmlContent], { type: 'application/msword' });
        const url = URL.createObjectURL(blob);
        const link = document.createElement("a");
        link.href = url;
        link.download = `statistics_report_${this.currentSection}.doc`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }

      generateSectionReport() {
        let sectionHalaqas = [];
        let sectionName = '';
        if (this.currentSection === 'men') { sectionHalaqas = this.appData.men || []; sectionName = 'Ø§Ù„Ø±Ø¬Ø§Ù„'; }
        else if (this.currentSection === 'women') {
          sectionName = 'Ø§Ù„Ù†Ø³Ø§Ø¡';
          (this.appData.women || []).forEach(dar => { (dar.halaqas || []).forEach(halaqa => sectionHalaqas.push({ ...halaqa, darName: dar.name })); });
        }
        if (sectionHalaqas.length === 0) return this.halaqaManager.showMessage('Ù„Ø§ ØªÙˆØ¬Ø¯ Ø­Ù„Ù‚Ø§Øª ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù„Ø¥Ù†Ø´Ø§Ø¡ ØªÙ‚Ø±ÙŠØ±', 'warning');
        const today = this.halaqaManager.getHijriDateString(new Date());
        let reportHTML = `
          <!DOCTYPE html><html lang="ar" dir="rtl"><head><meta charset="UTF-8"><title>ØªÙ‚Ø±ÙŠØ± Ù‚Ø³Ù… ${sectionName}</title>
          <script src="https://cdn.tailwindcss.com"><\/script>
          <style>@import url('https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&display=swap');
            body { font-family: 'Amiri', serif; margin: 20px; } table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
            th, td { border: 1px solid #ddd; padding: 12px; text-align: center; } thead { background-color: #f2f2f2; }
            .header { text-align: center; margin-bottom: 2rem; }
          </style></head><body>
            <div class="header">
              <h1 class="text-3xl font-bold">Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„Ù‚Ø³Ù… ${sectionName}</h1>
              <p class="text-lg text-gray-600">ØªØ§Ø±ÙŠØ® Ø§Ù„ØªÙ‚Ø±ÙŠØ±: ${today}</p>
            </div>
            <table><thead><tr>
              ${this.currentSection === 'women' ? '<th>Ø§Ø³Ù… Ø§Ù„Ø¯Ø§Ø±</th>' : ''}<th>Ø§Ø³Ù… Ø§Ù„Ø­Ù„Ù‚Ø©</th><th>Ø§Ø³Ù… Ø§Ù„Ù…Ø¹Ù„Ù…/Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ø­ÙØ¸</th>
              <th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙˆØ¬Ù‡ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­Ø¶ÙˆØ±</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„ØºÙŠØ§Ø¨</th>
            </tr></thead><tbody>`;
        sectionHalaqas.forEach(halaqa => {
          const totals = this.halaqaManager.calculateHalaqaTotals(halaqa);
          reportHTML += `<tr>
            ${this.currentSection === 'women' ? `<td>${halaqa.darName || ''}</td>` : ''}
            <td>${halaqa.circleName}</td><td>${halaqa.teacherName}</td><td>${(halaqa.students || []).length}</td>
            <td class="font-bold text-green-600">${totals.totalMemorization}</td><td class="font-bold text-indigo-600">${totals.totalReview}</td>
            <td class="font-bold text-teal-600">${totals.totalAttendance}</td><td class="font-bold text-red-600">${totals.totalAbsence}</td>
          </tr>`;
        });
        reportHTML += `</tbody></table></body></html>`;
        const reportWindow = window.open('', '_blank');
        reportWindow.document.write(reportHTML);
        reportWindow.document.close();
        reportWindow.onload = () => reportWindow.print();
      }
    }

    // ============== HalaqaManager ==============
    class HalaqaManager {
      constructor(appManager) {
        this.app = appManager;
        this.currentHalaqa = null;
        this.currentStudentId = null;
        this.debounceTimer = null;
        this.initializeEventListeners();
      }

      initializeEventListeners() {
        document.getElementById('addStudentBtn').addEventListener('click', () => this.addStudent());
        document.getElementById('addWeekBtn').addEventListener('click', () => this.addWeekToCurrentStudent());
        document.getElementById('calculateBtn').addEventListener('click', () => this.calculateAllTotals());
        document.getElementById('printBtn').addEventListener('click', () => this.generatePrintableReport());
        document.getElementById('exportBtn').addEventListener('click', () => this.exportHalaqaToCSV());
        document.getElementById('printSummaryBtn').addEventListener('click', () => this.printHalaqaSummary());
        document.getElementById('newStudentName').addEventListener('keypress', (e) => { if (e.key === 'Enter') this.addStudent(); });
        document.getElementById('halaqaView').addEventListener('input', () => {
          this.showMessage('Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...', 'info');
          clearTimeout(this.debounceTimer);
          this.debounceTimer = setTimeout(() => {
            this.captureAndSaveHalaqa().then(() => this.showMessage('ØªÙ… Ø§Ù„Ø­ÙØ¸ Ø¨Ù†Ø¬Ø§Ø­!', 'success'));
          }, 1500);
        });

        // Ø£Ø­Ø¯Ø§Ø« Ø¹Ø§Ù…Ø© Ù…ÙˆØ¬ÙˆØ¯Ø© Ø®Ø§Ø±Ø¬ Ø§Ù„ØµÙ ÙÙŠ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ Ø³ØªØ¨Ù‚Ù‰ ÙƒÙ…Ø§ Ù‡ÙŠ Ø£Ø³ÙÙ„ Ø§Ù„Ù…Ù„Ù
      }

      calculateHalaqaTotals(halaqa) {
        let totals = { totalMemorization: 0, totalReview: 0, totalAttendance: 0, totalAbsence: 0 };
        if (!halaqa.students) return totals;
        halaqa.students.forEach(student => {
          (student.data.weeks || []).forEach(week => {
            (week.days || []).forEach(day => {
              totals.totalMemorization += Number(day.hifdhFaces) || 0;
              totals.totalReview += Number(day.murajaaFaces) || 0;
              if (day.attendance === 'Ø­Ø¶Ø±') totals.totalAttendance++;
              else if (day.attendance === 'ØºØ§Ø¨') totals.totalAbsence++;
            });
          });
        });
        return totals;
      }

      getHijriDateParts() {
        const today = new Date();
        const yearFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { year: 'numeric' });
        const monthFormatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { month: 'long' });
        const year = yearFormatter.format(today).replace(/\s*Ù‡Ù€.*/, '');
        const monthName = monthFormatter.format(today);
        return { year, monthName };
      }

      loadHalaqa(halaqaData) {
        this.currentHalaqa = JSON.parse(JSON.stringify(halaqaData));
        document.getElementById('studentsTabs').innerHTML = '';
        document.getElementById('studentsContentContainer').innerHTML = '';
        document.getElementById('halaqaSummary').classList.add('hidden');
        const { year, monthName } = this.getHijriDateParts();
        document.getElementById('currentHijriYear').textContent = `Ù„Ø¹Ø§Ù… ${year}Ù‡Ù€`;
        document.getElementById('teacherName').value = this.currentHalaqa.teacherName;
        document.getElementById('circleName').value = this.currentHalaqa.circleName;
        const monthSelect = document.getElementById('month');
        if (this.currentHalaqa.month) {
          monthSelect.value = this.currentHalaqa.month;
        } else {
          const currentMonthOption = Array.from(monthSelect.options).find(opt => opt.text === monthName);
          if (currentMonthOption) { monthSelect.value = currentMonthOption.value; this.currentHalaqa.month = currentMonthOption.value; }
          else { monthSelect.value = ""; }
        }
        (this.currentHalaqa.students || []).forEach(student => {
          this.createStudentTab(student);
          this.createStudentContentWithData(student);
        });
        if (this.currentHalaqa.students && this.currentHalaqa.students.length > 0) this.switchToStudent(this.currentHalaqa.students.id);
        else this.currentStudentId = null;
      }

      async captureAndSaveHalaqa() {
        if (!this.currentHalaqa) return;
        this.currentHalaqa.teacherName = document.getElementById('teacherName').value;
        this.currentHalaqa.circleName = document.getElementById('circleName').value;
        this.currentHalaqa.month = document.getElementById('month').value;
        (this.currentHalaqa.students || []).forEach(student => this.captureStudentData(student.id));
        await this.app.updateCurrentHalaqa(this.currentHalaqa);
      }

      addStudent() {
        const nameInput = document.getElementById('newStudentName');
        const studentName = nameInput.value.trim();
        if (!studentName) return this.showMessage('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨', 'warning');
        if (!this.currentHalaqa.studentIdCounter) this.currentHalaqa.studentIdCounter = (this.currentHalaqa.students || []).length + 1;
        const studentId = `student_${this.currentHalaqa.studentIdCounter++}`;
        const newStudent = {
          id: studentId, name: studentName,
          grade: document.getElementById('newStudentGrade').value.trim(),
          civilId: document.getElementById('newStudentCivilId').value.trim(),
          data: { weeks: [{ days: Array(4).fill({}).map(() => ({ date: this.getHijriDateString(new Date()) })) }] }
        };
        if (!this.currentHalaqa.students) this.currentHalaqa.students = [];
        this.currentHalaqa.students.push(newStudent);
        this.createStudentTab(newStudent);
        this.createStudentContentWithData(newStudent);
        this.switchToStudent(studentId);
        nameInput.value = ''; document.getElementById('newStudentGrade').value = ''; document.getElementById('newStudentCivilId').value = '';
        this.captureAndSaveHalaqa();
        this.showMessage('ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­!', 'success');
      }

      removeStudent(studentId) {
        const idx = this.currentHalaqa.students.findIndex(s => s.id === studentId);
        if (idx > -1) {
          const studentName = this.currentHalaqa.students[idx].name;
          this.currentHalaqa.students.splice(idx, 1);
          document.getElementById(`tab_${studentId}`).remove();
          document.getElementById(`content_${studentId}`).remove();
          if (this.currentStudentId === studentId) {
            this.currentStudentId = this.currentHalaqa.students.length > 0 ? this.currentHalaqa.students.id : null;
            if (this.currentStudentId) this.switchToStudent(this.currentStudentId);
          }
          this.captureAndSaveHalaqa();
          this.showMessage(`ØªÙ… Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨: ${studentName}`, 'warning');
        }
      }

      switchToStudent(studentId) {
        if (!this.currentHalaqa || !this.currentHalaqa.students.find(s => s.id === studentId)) return;
        this.currentStudentId = studentId;
        document.querySelectorAll('.student-tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.student-content').forEach(c => c.classList.remove('active'));
        document.getElementById(`tab_${studentId}`).classList.add('active');
        document.getElementById(`content_${studentId}`).classList.add('active');
      }

      addWeekToCurrentStudent() {
        if (!this.currentStudentId) return this.showMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± Ø·Ø§Ù„Ø¨ Ø£ÙˆÙ„Ø§Ù‹', 'warning');
        const student = this.currentHalaqa.students.find(s => s.id === this.currentStudentId);
        if (student) {
          if (!student.data.weeks) student.data.weeks = [];
          student.data.weeks.push({ days: Array(4).fill({}) });
          const weeksContainer = document.getElementById(`weeks_${this.currentStudentId}`);
          const newWeekData = student.data.weeks[student.data.weeks.length - 1];
          weeksContainer.insertAdjacentHTML('beforeend', this.createWeekTableWithData(student.id, newWeekData, student.data.weeks.length));
          this.captureAndSaveHalaqa();
        }
      }

      createStudentTab(student) {
        const tabsContainer = document.getElementById('studentsTabs');
        const tab = document.createElement('div');
        tab.id = `tab_${student.id}`;
        tab.className = 'student-tab px-4 py-2 rounded-lg border border-gray-300 font-bold flex items-center gap-2';
        tab.innerHTML = `<span class="flex-1 select-none">${student.name}</span>`;
        tab.addEventListener('click', () => this.switchToStudent(student.id));
        const deleteBtn = document.createElement('button');
        deleteBtn.className = 'delete-btn text-red-500 hover:text-red-700 rounded-full w-6 h-6 flex items-center justify-center text-sm font-bold';
        deleteBtn.textContent = 'âœ•'; deleteBtn.title = 'Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨';
        deleteBtn.addEventListener('click', (e) => { e.stopPropagation(); this.removeStudent(student.id); });
        tab.appendChild(deleteBtn);
        tabsContainer.appendChild(tab);
      }

      createStudentContentWithData(student) {
        const contentContainer = document.getElementById('studentsContentContainer');
        const studentDiv = document.createElement('div');
        studentDiv.id = `content_${student.id}`;
        studentDiv.className = 'student-content student-card';
        let weeksHTML = (student.data.weeks || []).map((weekData, index) => this.createWeekTableWithData(student.id, weekData, index + 1)).join('');
        studentDiv.innerHTML = `
          <div class="border-2 border-blue-600 p-4 mb-6 bg-blue-50">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div><span class="font-bold">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</span> <span class="text-blue-800 font-bold">${student.name}</span></div>
              <div><span class="font-bold">Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø¯Ø±Ø§Ø³ÙŠØ©:</span> <span class="text-blue-800">${student.grade}</span></div>
              <div><span class="font-bold">Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ:</span> <span class="text-blue-800">${student.civilId}</span></div>
            </div>
          </div>
          <div id="weeks_${student.id}">${weeksHTML}</div>
          <div id="summary_${student.id}" class="mt-6 p-4 bg-gray-50 border border-gray-300 rounded-lg">
            <h4 class="font-bold text-center text-lg mb-2">Ø§Ù„Ù…Ù„Ø®Øµ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨</h4>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
              <div><p class="font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø­ÙØ¸: <span class="total-memorization text-green-600">0</span></p></div>
              <div><p class="font-bold">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©: <span class="total-review text-indigo-600">0</span></p></div>
              <div><p class="font-bold">Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ±: <span class="total-attendance text-teal-600">0</span></p></div>
              <div><p class="font-bold">Ø£ÙŠØ§Ù… Ø§Ù„ØºÙŠØ§Ø¨: <span class="total-absence text-red-600">0</span></p></div>
            </div>
          </div>`;
        contentContainer.appendChild(studentDiv);
      }

      getHijriDateString(date) {
        const formatter = new Intl.DateTimeFormat('ar-SA-u-ca-islamic', { day: '2-digit', month: '2-digit', year: 'numeric' });
        return formatter.format(date).replace(/\s*Ù‡Ù€.*/, '');
      }

      createWeekTableWithData(studentId, weekData, weekNumber) {
        const days = ['Ø§Ù„Ø£Ø­Ø¯', 'Ø§Ù„Ø§Ø«Ù†ÙŠÙ†', 'Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡', 'Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡'];
        const createTextField = (dayIndex, field, placeholder = '', value = '', type = 'text') =>
          `<input type="${type}" placeholder="${placeholder}" value="${value || ''}" class="w-full text-center border-gray-300 rounded" data-day-index="${dayIndex}" data-field="${field}">`;
        const createTextArea = (dayIndex, field, placeholder = '', value = '') =>
          `<textarea placeholder="${placeholder}" class="w-full border-gray-300 rounded text-sm p-1" rows="2" data-day-index="${dayIndex}" data-field="${field}">${value || ''}</textarea>`;
        const createAttendanceSelect = (dayIndex, field, value = '') =>
          `<select class="w-full border-gray-300 rounded attendance-select" data-day-index="${dayIndex}" data-field="${field}">
            <option value=""></option>
            <option value="Ø­Ø¶Ø±" ${value === 'Ø­Ø¶Ø±' ? 'selected' : ''}>Ø­Ø¶Ø±</option>
            <option value="ØºØ§Ø¨" ${value === 'ØºØ§Ø¨' ? 'selected' : ''}>ØºØ§Ø¨</option>
            <option value="Ù…Ø³ØªØ£Ø°Ù†" ${value === 'Ù…Ø³ØªØ£Ø°Ù†' ? 'selected' : ''}>Ù…Ø³ØªØ£Ø°Ù†</option>
          </select>`;
        const createGradeSelect = (dayIndex, field, value = '') =>
          `<select class="w-full border-gray-300 rounded" data-day-index="${dayIndex}" data-field="${field}">
            <option value=""></option>
            <option value="Ù…Ù…ØªØ§Ø²" ${value === 'Ù…Ù…ØªØ§Ø²' ? 'selected' : ''}>Ù…Ù…ØªØ§Ø²</option>
            <option value="Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹" ${value === 'Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹' ? 'selected' : ''}>Ø¬ÙŠØ¯ Ø¬Ø¯Ø§Ù‹</option>
            <option value="Ø¬ÙŠØ¯" ${value === 'Ø¬ÙŠØ¯' ? 'selected' : ''}>Ø¬ÙŠØ¯</option>
            <option value="Ù…Ù‚Ø¨ÙˆÙ„" ${value === 'Ù…Ù‚Ø¨ÙˆÙ„' ? 'selected' : ''}>Ù…Ù‚Ø¨ÙˆÙ„</option>
            <option value="Ø¶Ø¹ÙŠÙ" ${value === 'Ø¶Ø¹ÙŠÙ' ? 'selected' : ''}>Ø¶Ø¹ÙŠÙ</option>
          </select>`;

        const mobileDayCards = days.map((day, dayIndex) => {
          const dayData = weekData.days?.[dayIndex] || {};
          const hijriDateString = this.getHijriDateString(new Date());
          return `
          <div class="border-b-2 border-gray-200 p-3 last:border-b-0">
            <div class="flex justify-between items-center mb-4">
              <h5 class="font-bold text-lg text-blue-800">${day}</h5>
              <div class="w-1/2">
                ${createTextField(dayIndex, 'date', '', dayData.date || hijriDateString)}
              </div>
            </div>
            <div class="mb-4">
              <label class="block text-sm font-medium text-gray-700 mb-1">Ø§Ù„Ø­Ø¶ÙˆØ±</label>
              ${createAttendanceSelect(dayIndex, 'attendance', dayData.attendance)}
            </div>
            <div class="bg-blue-50 p-3 rounded-lg border border-blue-200">
              <h6 class="font-bold mb-2 text-blue-700">Ø§Ù„Ø­ÙØ¸</h6>
              <div class="grid grid-cols-2 gap-3 items-center">
                <label class="block text-sm font-medium">Ø§Ù„Ø³ÙˆØ±Ø©</label> ${createTextField(dayIndex, 'hifdhSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.hifdhSurah)}
                <label class="block text-sm font-medium">Ù…Ù†</label> ${createTextField(dayIndex, 'hifdhFrom', 'Ø¢ÙŠØ©', dayData.hifdhFrom)}
                <label class="block text-sm font-medium">Ø¥Ù„Ù‰</label> ${createTextField(dayIndex, 'hifdhTo', 'Ø¢ÙŠØ©', dayData.hifdhTo)}
                <label class="block text-sm font-medium">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</label> ${createGradeSelect(dayIndex, 'hifdhGrade', dayData.hifdhGrade)}
                <label class="block text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</label> ${createTextField(dayIndex, 'hifdhFaces', '0', dayData.hifdhFaces, 'number')}
              </div>
            </div>
            <div class="bg-green-50 p-3 rounded-lg border border-green-200 mt-3">
              <h6 class="font-bold mb-2 text-green-700">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</h6>
              <div class="grid grid-cols-2 gap-3 items-center">
                <label class="block text-sm font-medium">Ø§Ù„Ø³ÙˆØ±Ø©</label> ${createTextField(dayIndex, 'murajaaSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.murajaaSurah)}
                <label class="block text-sm font-medium">Ù…Ù†</label> ${createTextField(dayIndex, 'murajaaFrom', 'Ø¢ÙŠØ©', dayData.murajaaFrom)}
                <label class="block text-sm font-medium">Ø¥Ù„Ù‰</label> ${createTextField(dayIndex, 'murajaaTo', 'Ø¢ÙŠØ©', dayData.murajaaTo)}
                <label class="block text-sm font-medium">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</label> ${createGradeSelect(dayIndex, 'murajaaGrade', dayData.murajaaGrade)}
                <label class="block text-sm font-medium">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</label> ${createTextField(dayIndex, 'murajaaFaces', '0', dayData.murajaaFaces, 'number')}
              </div>
            </div>
            <div class="mt-3">
              <label class="block text-sm font-medium text-gray-700 mb-1">Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„ÙŠÙˆÙ…</label>
              ${createTextArea(dayIndex, 'notes', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª...', dayData.notes)}
            </div>
          </div>`;
        }).join('');

        const desktopDayRows = days.map((day, dayIndex) => {
          const dayData = weekData.days?.[dayIndex] || {};
          const hijriDateString = this.getHijriDateString(new Date());
          return `<tr>
            <td class="border p-2 font-bold bg-gray-50">${day}</td>
            <td class="border p-1">${createTextField(dayIndex, 'date', '', dayData.date || hijriDateString)}</td>
            <td class="border p-1">${createAttendanceSelect(dayIndex, 'attendance', dayData.attendance)}</td>
            <td class="border p-1">${createTextField(dayIndex, 'hifdhSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.hifdhSurah)}</td>
            <td class="border p-1">${createTextField(dayIndex, 'hifdhFrom', 'Ø¢ÙŠØ©', dayData.hifdhFrom)}</td>
            <td class="border p-1">${createTextField(dayIndex, 'hifdhTo', 'Ø¢ÙŠØ©', dayData.hifdhTo)}</td>
            <td class="border p-1">${createGradeSelect(dayIndex, 'hifdhGrade', dayData.hifdhGrade)}</td>
            <td class="border p-1">${createTextField(dayIndex, 'hifdhFaces', '', dayData.hifdhFaces, 'number')}</td>
            <td class="border p-1">${createTextField(dayIndex, 'murajaaSurah', 'Ø§Ù„Ø³ÙˆØ±Ø©', dayData.murajaaSurah)}</td>
            <td class="border p-1">${createTextField(dayIndex, 'murajaaFrom', 'Ø¢ÙŠØ©', dayData.murajaaFrom)}</td>
            <td class="border p-1">${createTextField(dayIndex, 'murajaaTo', 'Ø¢ÙŠØ©', dayData.murajaaTo)}</td>
            <td class="border p-1">${createGradeSelect(dayIndex, 'murajaaGrade', dayData.murajaaGrade)}</td>
            <td class="border p-1">${createTextField(dayIndex, 'murajaaFaces', '', dayData.murajaaFaces, 'number')}</td>
            <td class="border p-1">${createTextArea(dayIndex, 'notes', 'Ù…Ù„Ø§Ø­Ø¸Ø§Øª', dayData.notes)}</td>
          </tr>`;
        }).join('');

        return `<div class="week-table mb-8 border border-gray-400 rounded-lg overflow-hidden">
          <h4 class="font-bold p-2 bg-gray-100 text-center">Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${weekNumber}</h4>
          <div class="block md:hidden">${mobileDayCards}</div>
          <div class="hidden md:block">
            <div class="overflow-x-auto">
              <table class="w-full text-sm min-w-[1200px] whitespace-nowrap">
                <thead class="bg-gray-200">
                  <tr>
                    <th rowspan="2" class="border p-1">Ø§Ù„ÙŠÙˆÙ…</th><th rowspan="2" class="border p-1">Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th rowspan="2" class="border p-1">Ø§Ù„Ø­Ø¶ÙˆØ±</th>
                    <th colspan="5" class="border p-1">Ø§Ù„Ø­ÙØ¸</th><th colspan="5" class="border p-1">Ø§Ù„Ù…Ø±Ø§Ø¬Ø¹Ø©</th>
                    <th rowspan="2" class="border p-1">Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th>
                  </tr>
                  <tr class="bg-gray-100 text-xs">
                    <th class="border p-1">Ø§Ù„Ø³ÙˆØ±Ø©</th><th class="border p-1">Ù…Ù†</th><th class="border p-1">Ø¥Ù„Ù‰</th><th class="border p-1">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th><th class="border p-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</th>
                    <th class="border p-1">Ø§Ù„Ø³ÙˆØ±Ø©</th><th class="border p-1">Ù…Ù†</th><th class="border p-1">Ø¥Ù„Ù‰</th><th class="border p-1">Ø§Ù„ØªÙ‚Ø¯ÙŠØ±</th><th class="border p-1">Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙˆØ¬Ù‡</th>
                  </tr>
                </thead>
                <tbody>${desktopDayRows}</tbody>
              </table>
            </div>
          </div>
          <div class="bg-yellow-50 font-bold p-2 text-center grid grid-cols-1 sm:grid-cols-2">
            <div>Ø­ØµÙŠÙ„Ø© Ø§Ù„Ø­ÙØ¸ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: <span class
